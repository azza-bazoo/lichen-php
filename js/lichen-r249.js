var AddressBookManager=new Class({initialize:function(_1,_2){this.wrapper=_2;this.server=_1;this.cache=null;},getWindowTitle:function(){return _("Address Book");},showAddressBook:function(_3,_4){this.server.addressBookList(_3,_4,this.showAddressBookCBStub.bind(this));},showAddressBookCBStub:function(_5){Lichen.action("abook","AddressBook","showAddressBookCB",[_5]);},showAddressBookCB:function(_6){this._render(_6.addresses);this.cache=_6.addresses;},getFromCache:function(_7){var _8=null;for(var i=0;i<this.cache.length;i++){if(this.cache[i].email==_7){_8=this.cache[i];}}return _8;},_render:function(_a){var _b="";_b+="<table border=\"1\">";_b+="<tr><th>Name</th><th>Email</th><th>Notes</th><th></th></tr>";if(_a){for(var i=0;i<_a.length;i++){_b+="<tr>";_b+="<td>"+_a[i].name_html+"</td>";_b+="<td>"+_a[i].email_html+"</td>";_b+="<td>"+_a[i].notes_html+"</td>";_b+="<td>";_b+="[<a href=\"#abook\" onclick=\"Lichen.AddressBook.editAddress('"+_a[i].email+"');return false\">"+_("Edit")+"</a>]";_b+="[<a href=\"#abook\" onclick=\"Lichen.AddressBook.deleteAddress('"+_a[i].email+"');return false\">"+_("Delete")+"</a>]";_b+="</tr>";}}_b+="</table>";_b+="<p>[<a href=\"#abook\" onclick=\"Lichen.AddressBook.newAddress();return false\">"+_("New Address")+"</a>]</p>";_b+="<p>";_b+="<input type=\"hidden\" id=\"abook-original\" size=\"30\" value=\"\"/>";_b+="<label for=\"abook-name\">"+_("name:")+"</label>";_b+="<input type=\"text\" id=\"abook-name\" size=\"30\" /><br />";_b+="<label for=\"abook-email\">"+_("email:")+"</label>";_b+="<input type=\"text\" id=\"abook-email\" size=\"30\" /><br />";_b+="<label for=\"abook-notes\">"+_("notes:")+"</label>";_b+="<input type=\"text\" id=\"abook-notes\" size=\"30\" /><br />";_b+="<button id=\"abook-save\" onclick=\"Lichen.AddressBook.saveAddress();return false\">"+_("save changes")+"</button>";_b+="</p>";$(this.wrapper).setHTML(_b);},addAddress:function(_d){$("abook-original").value="";$("abook-name").value="";$("abook-email").value="";$("abook-notes").value="";},editAddress:function(_e){var _f=this.getFromCache(_e);if(_f){$("abook-original").value=_f.email;$("abook-name").value=_f.name;$("abook-email").value=_f.email;$("abook-notes").value=_f.notes;}else{this.addAddress();}},saveAddress:function(){this.server.addressBookEdit($("abook-original").value,$("abook-name").value,$("abook-email").value,$("abook-notes").value,this.saveAddressCB.bind(this));},saveAddressCB:function(){this.showAddressBook();},deleteAddress:function(_10){this.server.addressBookDelete(_10,this.saveAddressCB.bind(this));}});var GoogleCacheConnector=new Class({initialize:function(_11,_12){}});var HashCacheConnector=new Class({initialize:function(_13,_14){this.messagelists={};this.messagelistsvalidity={};this.messages={};this.mailboxlist={};this.mailboxlistvalidity=null;this.dataStore=_13;},storeMessageList:function(_15,_16,_17,_18,_19,_1a){var _1b=_15+_16+_17+_18;if(_1a&&this.messagelistsvalidity[_1b]&&_1a==this.messagelistsvalidity[_1b]){return this.messagelists[_1b];}else{this.messagelists[_1b]=_19;this.messagelistsvalidity[_1b]=_1a;return _19;}},getMessageList:function(_1c,_1d,_1e,_1f,_20){var _21=_1c+_1d+_1e+_1f;if(this.messagelists[_21]&&this.messagelistsvalidity[_21]&&_20&&this.messagelistsvalidity[_21]==_20){return this.messagelists[_21];}else{return null;}},getMessageListValidity:function(_22,_23,_24,_25){var _26=_22+_23+_24+_25;if(this.messagelistsvalidity[_26]!=null){return this.messagelistsvalidity[_26];}else{return null;}},haveCachedMessageList:function(_27,_28,_29,_2a){if(this.getMessageList(_27,_28,_29,_2a,this.getMessageListValidity(_27,_28,_29,_2a))){return true;}return false;},updateFlagStatus:function(_2b,_2c,_2d,_2e,uid,_30,_31){var _32=_2b+_2c+_2d+_2e;var _33=uid.toInt();if(this.messagelists[_32]){for(var i=0;i<this.messagelists[_32].messages.length;i++){if(this.messagelists[_32].messages[i].uid==_33){switch(_30){case "flagged":this.messagelists[_32].messages[i].flagged=_31;break;case "seen":if(_31){this.messagelists[_32].messages[i].readStatus="R";}else{this.messagelists[_32].messages[i].readStatus="U";}break;}}}}},storeMessage:function(_35,uid,_37,_38){var _39=_35+uid;if(this.messages[_39]){var _3a=this.messages[_39];if(_3a.texthtmlpresent&&_3a.texthtml.length==0&&_37.texthtml.length>0){_3a.texthtml=_37.texthtml;}if(_3a.textplainpresent&&_3a.textplain.length==0&&_37.textplain.length>0){_3a.textplain=_37.textplain;}if(_3a.source==null&&_37.source!=null){_3a.source=_37.source;}}else{this.messages[_39]=_37;}return this.messages[_39];},storeLargePart:function(_3b,uid,_3d,_3e){var _3f=_3b+uid;if(this.messages[_3f]){this.messages[_3f].textplain[_3d]=_3e;}},getMessage:function(_40,uid,_42,_43){var _44=_40+uid;var _45=null;if(this.messages[_44]&&_43){var _46=false;var _47=this.messages[_44];switch(_42){case "html":if(_47.texthtmlpresent&&_47.texthtml.length!=0){_46=true;}break;case "text":if(_47.textplainpresent&&_47.textplain.length!=0){_46=true;}break;case "source":if(_47.source){_46=true;}break;case "all":break;default:_46=true;break;}if(_46){_45=this.messages[_44];}}return _45;},storeMailboxList:function(_48,_49){if(_49&&_49==this.mailboxlistvalidity){return this.mailboxlist;}else{this.mailboxlist=_48;this.mailboxlistvalidity=_49;return _48;}},getMailboxList:function(_4a){if(_4a&&_4a==this.mailboxlistvalidity){return this.mailboxlist;}else{return null;}},getMailboxListValidity:function(){return this.mailboxlistvalidity;}});var MessageComposer=new Class({initialize:function(_4b){this.wrapper=_4b;this.messageFormat="text/plain";this.sending=false;this.composerData=null;this.draftSaveTimer=null;},getWindowTitle:function(){var _4c=_("Composer - ");if(this.composerData){switch(this.composerData.comp_mode){case "reply":case "replyall":_4c+=_("Replying to ")+this.composerData.comp_subj;break;case "forwardinline":case "forwardasattach":_4c+=_("Forwarding ")+this.composerData.comp_subj;break;case "draft":_4c+=_("Editing draft ")+this.composerData.comp_subj;break;default:_4c+=_("New message");break;}}else{_4c+=_("New message");}return _4c;},showComposer:function(_4d,_4e,_4f){var _50="request=getComposeData&mailbox="+encodeURIComponent(Lichen.MessageList.getMailbox());if(_4d){_50+="&mode="+_4d;}if(_4e){_50+="&uid="+encodeURIComponent(_4e);}if(_4f){_50+="&mailto="+encodeURIComponent(_4f);}if_remoteRequestStart();new Ajax("ajax.php",{postBody:_50,onComplete:this.showComposerCBStub.bind(this),onFailure:if_remoteRequestFailed}).request();},showComposerCBStub:function(_51){Lichen.action("compose","MessageCompose","showComposerCB",[_51]);},showComposerCB:function(_52){var _53=if_checkRemoteResult(_52);if(!_53){return;}this._render(_53.composedata);this.composerData=_53.composedata;},makeHTMLMail:function(){this.messageFormat="text/html";var _54=$("comp_msg");if(_54.value!=""){_54.value="<pre>"+_54.value+"</pre>";}tinyMCE.execCommand("mceAddControl",false,"comp_msg");},makePlainMail:function(){var _55=HTMLToText(tinyMCE.getContent("comp_msg"));this.messageFormat="text/plain";tinyMCE.execCommand("mceRemoveControl",false,"comp_msg");$("comp_msg").value=_55;},_render:function(_56){var _57="";var _58=_56.comp_mode;_57="<div class=\"header-bar\"><img src=\"themes/"+userSettings.theme+"/top-corner.png\" alt=\"\" class=\"top-corner\" /><div class=\"header-right\">&nbsp;</div><div class=\"comp-header\">"+_("New message")+"</div></div>";_57+="<form action=\""+lichenURL+"\" method=\"post\" id=\"compose\" onsubmit=\"Lichen.MessageCompose.sendMessage();return false\">";_57+="<input type=\"hidden\" name=\"comp_mode\" id=\"comp_mode\" value=\""+_56.comp_mode+"\" />";if(_56.comp_quoteuid){_57+="<input type=\"hidden\" name=\"comp_quoteuid\" id=\"comp_quoteuid\" value=\""+_56.comp_quoteuid+"\" />";_57+="<input type=\"hidden\" name=\"comp_quotemailbox\" id=\"comp_quotemailbox\" value=\""+_56.comp_quotemailbox+"\" />";}_57+="<input type=\"hidden\" name=\"comp_draftuid\" id=\"comp_draftuid\" value=\"";if(_58=="draft"){_57+=_56.comp_draftuid;}_57+="\" />";if(_56.identities.length==1){_57+="<input name=\"comp_identity\" id=\"comp_identity\" type=\"hidden\" value=\""+_56.identities[0].address_html+"\" />";}else{_57+="<label class=\"comp-label\" for=\"comp_identity\">"+_("From:")+"</label> ";_57+="<select name=\"comp_identity\" id=\"comp_identity\" onchange=\"Lichen.MessageCompose.changeIdentity();\">";for(var i=0;i<_56.identities.length;i++){var _5a=_56.identities[i];_57+="<option value=\""+_5a.address_html+"\"";if(_56.identity.address==_56.identities[i].address){_57+=" selected=\"selected\"";}_57+=">"+_5a.name_html+" &lt;"+_5a.address_html+"&gt;</option>";}_57+="</select>";}_57+="<div class=\"comp-label\"><label for=\"comp_to\">"+_("To:")+"</label>";_57+="<p class=\"comp-add-fields\"><a id=\"comp-ccshow\" href=\"#\""+(_56.show_cc?" style=\"display:none\"":"")+" onclick=\"$('comp-cceditor').style.display='block';$('comp-ccshow').style.display='none';return false\">"+_("add CC")+"</a>";_57+=" <a id=\"comp-bccshow\" href=\"#\""+(_56.show_bcc?" style=\"display:none\"":"")+" onclick=\"$('comp-bcceditor').style.display='block';$('comp-bccshow').style.display='none';return false\">"+_("add BCC")+"</a></p>";_57+="</div> <textarea name=\"comp_to\" id=\"comp_to\">"+_56.comp_to+"</textarea>";_57+="<div id=\"comp-cceditor\" style=\"display: "+(_56.show_cc?"block":"none")+";\">";_57+="<label class=\"comp-label\" for=\"comp_cc\">"+_("CC:")+"</label> <textarea name=\"comp_cc\" id=\"comp_cc\">";_57+=_56.comp_cc;_57+="</textarea></div>";_57+="<div id=\"comp-bcceditor\" style=\"display: "+(_56.show_bcc?"block":"none")+";\">";_57+="<label class=\"comp-label\" for=\"comp_bcc\">"+_("BCC:")+"</label> <textarea name=\"comp_bcc\" id=\"comp_bcc\">";_57+=_56.comp_bcc;_57+="</textarea></div>";_57+="<label class=\"comp-label\" for=\"comp_subj\">"+_("Subject:")+"</label> <input type=\"text\" name=\"comp_subj\" id=\"comp_subj\" value=\"";_57+=_56.comp_subj+"\" />";_57+="<textarea name=\"comp_msg\" id=\"comp_msg\" onchange=\"Lichen.MessageCompose.draftSaveTimeout();\">";_57+=_56.comp_msg;_57+="</textarea>";if(_58=="forwardinline"){_57+="<p><a href=\"#\" onclick=\"Lichen.MessageCompose.showComposer('forwardasattach',Lichen.MessageDisplayer.getViewedUID()); return false\">&raquo; "+_("forward message as attachment")+"</a></p>";}var _5b="";for(var i=0;i<_56.comp_attach.length;i++){var _5c=_56.comp_attach[i];_5b+="<li>"+_5c.filename+" ("+_5c.type+", "+_5c.size+") ";if(_5c.isforwardedmessage){_5b+="<a href=\"#\" onclick=\"Lichen.MessageCompose.showComposer('forwardinline',Lichen.MessageDisplayer.getViewedUID()); return false\">"+_("[forward inline]")+"</a>";}else{_5b+="<a href=\"#\" onclick=\"Lichen.MessageCompose.removeAttachment('"+encodeURIComponent(_5c.filename)+"');return false\">";_5b+=_("[remove]")+"</a>";}_5b+="</li>";_57+="<input type=\"hidden\" name=\"comp_attach[]\" value=\""+_5c.filename+"\" />";}_57+="</form>";_57+="<div class=\"sidebar-panel\" id=\"comp-attachments\">";_57+="<h2 class=\"sidebar-head\"><img src=\"themes/"+userSettings.theme+"/icons/attach.png\" alt=\"\" /> "+_("attachments")+"</h2>";_57+="<ul id=\"comp-attachlist\">";_57+=_5b;_57+="</ul>";_57+="<form enctype=\"multipart/form-data\" action=\"ajax.php\" id=\"comp-uploadform\" method=\"post\" onsubmit=\"return Lichen.MessageCompose.asyncUploadFile($('comp-uploadform'))\">";_57+="<input type=\"hidden\" name=\"request\" id=\"request\" value=\"uploadAttachment\" />";_57+="<input type=\"hidden\" name=\"MAX_FILE_SIZE\" value=\""+_56.maxattachmentsize+"\" />";_57+="<label for=\"comp_attachfile\">"+_("add new")+"</label><br />";_57+="<input type=\"file\" name=\"comp_attachfile\" id=\"comp_attachfile\" />";_57+="<div class=\"comp-attach-submit\"><input type=\"submit\" value=\""+_("upload file")+"\" /></div>";_57+="<input type=\"hidden\" name=\"upattach\" value=\"1\" />";_57+="</form></div>";$(this.wrapper).setHTML(_57);},getIdentityFromCache:function(_5d){if(this.composerData){for(var i=0;i<this.composerData.identities.length;i++){if(this.composerData.identities[i].address==_5d){return this.composerData.identities[i];}}}return null;},changeIdentity:function(){var _5f=this.getIdentityFromCache(this.composerData.identity.address);var _60=this.getIdentityFromCache($("comp_identity").value);var _61="";if(this.messageFormat=="text/html"){_61=tinyMCE.getContent("comp_msg");}else{_61=$("comp_msg").value;}var _62=-1;if(_5f.signature!=""){_62=_61.indexOf(_5f.signature);}if(_62!=-1){_61=_61.substr(0,_62)+_60.signature+_61.substr(_62+_5f.signature.length);}else{_61+="\n"+_60.signature;}this.composerData.identity=_60;$("comp_msg").value=_61;if(this.messageFormat=="text/html"){tinyMCE.updateContent("comp_msg");}},sendMessage:function(_63){Lichen.busy();if(this.sending){Lichen.Flash.flashMessage(_("The message is sending. Please wait."));return false;}else{this.sending=true;}if(_63){Lichen.Flash.flashMessage(_("Saving draft ..."));}else{Lichen.Flash.flashMessage(_("Sending message ..."));}var _64="request=sendMessage&";if(_63){_64+="draft=save&";}_64+="format="+encodeURIComponent(this.messageFormat)+"&";_64+=$("compose").toQueryString();if(this.messageFormat=="text/html"){_64+="&comp_msg="+encodeURIComponent(tinyMCE.getContent("comp_msg"));}new Ajax("ajax.php",{postBody:_64,onComplete:this.sendMessageCB.bind(this),onFailure:if_remoteRequestFailed}).request();this.draftClearTimeout();},sendMessageCB:function(_65){this.sending=false;Lichen.notbusy();var _66=if_checkRemoteResult(_65);if(!_66){return;}if(_66.draftMode){if($("comp_draftuid")){$("comp_draftuid").value=_66.draftUid;}var d=new Date();var hr=d.getHours();var min=d.getMinutes();if(min<10){min="0"+min;}if(hr==0){hr="12";}if(hr>12){hr=hr-12;min+=" PM";}else{min+=" AM";}Lichen.Flash.flashMessage(_("Draft saved at")+" "+hr+":"+min);}else{this.cleanupComposer();Lichen.action("list","MessageList","listUpdate");Lichen.Flash.flashMessage(_66.message);}},cleanupComposer:function(){if(this.messageFormat=="text/html"){tinyMCE.execCommand("mceRemoveControl",false,"comp_msg");}this.draftClearTimeout();},draftSaveTimeout:function(){if(this.draftSaveTimer){clearTimeout(this.draftSaveTimer);}this.draftSaveTimer=setTimeout(this.draftSaveTimedout.bind(this),60*1000);},draftClearTimeout:function(){if(this.draftSaveTimer){clearTimeout(this.draftSaveTimer);this.draftSaveTimer=null;}},draftSaveTimedout:function(){this.sendMessage(true);},removeAttachment:function(_6a){var _6b=$A($("compose").getElementsByTagName("input"));var _6c=$A($("comp-attachlist").getElementsByTagName("li"));var _6d=false;_6a=unescape(_6a);for(var i=0;i<_6b.length;i++){var _6f=_6b[i];if(_6f.type=="hidden"&&_6f.value==_6a){_6d=true;_6f.remove();}}for(var i=0;i<_6c.length;i++){var _6f=_6c[i];if(_6f.getText().contains(_6a)){_6f.remove();}}if(_6d){new Ajax("ajax.php",{postBody:"request=removeAttachment&filename="+encodeURIComponent(_6a),onComplete:this.attachmentDeleted.bind(this),onFailure:if_remoteRequestFailed}).request();}},attachmentDeleted:function(_70){var _71=if_checkRemoteResult(_70);},asyncUploadFile:function(_72){var _73="asyncUpload"+Math.floor(Math.random()*99999);var _74=new Element("div");$(_74).setHTML("<iframe style='display: none;' src='about:blank' id='"+_73+"' name='"+_73+"' onload='Lichen.MessageCompose.asyncUploadCompleted(\""+_73+"\")'></iframe>");$("comp-wrapper").adopt(_74);$(_72).setProperty("target",_73);return true;},asyncUploadCompleted:function(_75){var _76=$(_75);if(_76==null){return;}if(_76.contentWindow!=null){_76=_76.contentWindow.document;}else{if(_76.contentDocument!=null){_76=_76.contentDocument;}else{_76=window.frames[_75].document;}}if(_76.location.href=="about:blank"){return;}_76.location.href="about:blank";var _77=if_checkRemoteResult(_76.body.innerHTML);if(!_77){return;}$(_75).getParent().remove();var _78=new Element("li");_78.setHTML(_77.filename+" ("+_77.type+", "+_77.size+" bytes)"+" (<a href=\"#\" onclick=\"Lichen.MessageCompose.removeAttachment('"+escape(_77.filename)+"');return false\">"+_("remove")+"</a>)");$("comp-attachlist").adopt(_78);var _79=new Element("input");_79.type="hidden";_79.name="comp_attach[]";_79.value=_77.filename;$("compose").adopt(_79);$("comp_attachfile").value="";}});function HTMLToText(_7a,_7b){var _7c=document.createElement("div");_7c.innerHTML=_7a;var _7d=_htt_parseNode(_7c,_7b);return _7d;}function _htt_parseNode(_7e,_7f,_80){var i=0;var _82="";for(i=0;i<_7e.childNodes.length;i++){if(_7e.childNodes[i].tagName=="A"){_82+=_7e.childNodes[i].href;}else{if(_7e.childNodes[i].tagName=="HR"){_82+="-------------------------\n\n";}else{if(_7e.childNodes[i].childNodes.length>0){_82+=_htt_parseNode(_7e.childNodes[i]);}else{if(_7e.childNodes[i].nodeType==3){_82+=_7e.childNodes[i].nodeValue;}}}}}switch(_7e.tagName){case "H1":case "H2":case "H3":case "H4":case "H5":case "H6":_82=_82.toUpperCase();_82+="\n\n";break;case "P":case "DIV":_82+="\n\n";break;}return _82;}window.onload=if_init;var activeFadeEffect=false;var userSettings;var Lichen;tinyMCE.init({mode:"none",theme:"advanced"});function if_init(){Lichen.onLoadInit();}function _(str){return str;}var InterfaceController=new Class({initialize:function(){this.mode="list";this.Messages=new MessagesDatastore(true);this.OptionsEditor=new OptionsEditorClass("opts-wrapper");this.MailboxManager=new MailboxManagerClass(this.Messages);this.MessageDisplayer=new MessageDisplay(this.Messages,"msg-wrapper");this.Flash=new FlashArea("notification");this.MessageList=new MessageLister(this.Messages,"list-wrapper");this.MailboxList=new MailboxLister("mailboxes");this.MessageCompose=new MessageComposer("comp-wrapper");this.AddressBook=new AddressBookManager(this.Messages,"addr-wrapper");this.ActionCounter=1;this.historyTrail=new Array(Array("list","MessageList","listUpdate"));this.historyChecker=null;this.lastHash="";this.modeFeedback=null;this.busyCounter=0;this.busyDiv="loading-box";this.busyIFrame=new Element("iframe");this.busyIFrame.setStyle("display","none");this.loadInit=false;},onLoadInit:function(){this.checkCount();this.MessageList.listUpdate();if(window.khtml){var _84=(window.innerWidth-350)+"px";$("list-bar").style.width=_84;$("comp-bar").style.width=_84;$("opts-bar").style.width=_84;$("msg-bar").style.width=_84;}if(window.ie6){for(var i=0;i<document.images.length;i++){var img=document.images[i];var _87=img.src.toUpperCase();if(_87.substring(_87.length-3,_87.length)=="PNG"){var _88="<span style=\"width:22px;height:22px;cursor:hand;"+"display:inline-block;vertical-align:middle;"+"filter:progid:DXImageTransform.Microsoft.AlphaImageLoader"+"(src='"+img.src+"', sizingMethod='crop');\"></span>";img.outerHTML=_88;i=i-1;}}$("corner-bar").style.width=(document.body.clientWidth-128)+"px";}},checkCount:function(){this.Messages.fetchMailboxList();this.clearTimer();this.setTimer();},setTimer:function(){if(!this.refreshTimer&&userSettings["list_refreshtime"]!="disabled"){this.refreshTimer=setTimeout(this.checkCount.bind(this),userSettings["list_refreshtime"]*60*1000);}},clearTimer:function(){if(this.refreshTimer){clearTimeout(this.refreshTimer);this.refreshTimer=null;}},action:function(_89,_8a,_8b,_8c,_8d){if(_89&&this.mode=="compose"&&_89!=this.mode){this.MessageCompose.cleanupComposer();}if(_89&&_89!=this.mode&&this.modeFeedback==null){this.modeFeedback=new PaneTransition(this.getWrapperName(this.mode));this.busy();}else{if(_89&&_89!=this.mode&&this.modeFeedback!=null){this.modeFeedback.end();this.modeFeedback=null;this.clearScreen();this.enterMode(_89);this.notbusy();}}if(_89&&_89!="list"){this.clearTimer();}else{if(_89=="list"){this.setTimer();}}if(this[_8a]&&this[_8a][_8b]){if(_8c){this[_8a][_8b].apply(this[_8a],_8c);}else{this[_8a][_8b].apply(this[_8a],[]);}}if(this[_8a]&&this[_8a]["getWindowTitle"]){document.title=this[_8a].getWindowTitle();}return false;},clearScreen:function(){$("list-bar").setStyle("display","none");$("comp-bar").setStyle("display","none");$("msg-bar").setStyle("display","none");$("opts-bar").setStyle("display","none");$("list-wrapper").setStyle("display","none");$("msg-wrapper").setStyle("display","none");$("opts-wrapper").setStyle("display","none");$("comp-wrapper").setStyle("display","none");$("addr-wrapper").setStyle("display","none");$("list-wrapper").empty();$("msg-wrapper").empty();$("opts-wrapper").empty();$("comp-wrapper").empty();$("addr-wrapper").setStyle("display","none");},getWrapperName:function(_8e){var _8f="list-wrapper";switch(_8e){case "list":_8f="list-wrapper";break;case "compose":_8f="comp-wrapper";break;case "display":_8f="msg-wrapper";break;case "options":_8f="opts-wrapper";break;case "abook":_8f="addr-wrapper";break;}return _8f;},enterMode:function(_90){if(_90!=this.mode){this.mode=_90;switch(_90){case "list":$("list-bar").setStyle("display","block");$("list-wrapper").setStyle("display","block");break;case "compose":$("comp-bar").setStyle("display","block");$("comp-wrapper").setStyle("display","block");break;case "display":$("msg-bar").setStyle("display","block");$("msg-wrapper").setStyle("display","block");break;case "options":$("opts-bar").setStyle("display","block");$("opts-wrapper").setStyle("display","block");break;case "abook":$("addr-wrapper").setStyle("display","block");break;default:this.enterMode("list");break;}}},getMode:function(){return this.mode;},busy:function(){if(!this.loadInit){$(this.busyDiv).adopt(this.busyIFrame);this.loadInit=true;}this.busyCounter+=1;if(this.busyCounter>0){this.busyIFrame.src="wait.php";}},notbusy:function(){if(this.busyCounter>0){this.busyCounter-=1;}if(this.busyCounter<1){this.busyIFrame.src="about:blank";}}});var Lichen=new InterfaceController();var FlashArea=new Class({initialize:function(_91){this.wrapper=_91;this.messages=new Array();this.timeouts=new Array();this.onscreen=false;},flashMessage:function(_92,_93){if(_93){this.messages.push(_92+"<div class=\"detail\">"+_93+"</div>");}else{this.messages.push(_92);}this.renderFlash();if(!this.onscreen){$(this.wrapper).setStyle("display","block");this.onscreen=true;}this.timeouts.push(window.setTimeout(this.clearFlash.bind(this),7500));},renderFlash:function(){var _94=this.messages.join("<br />");$(this.wrapper).setHTML(_94);},clearFlash:function(){this.messages.shift();this.timeouts.shift();if(this.messages.length==0){$(this.wrapper).setStyle("display","none");this.onscreen=false;}else{this.renderFlash();}},hideFlash:function(){this.messages=new Array();for(var i=0;i<this.timeouts.length;i++){window.clearTimeout(this.timeouts[i]);}this.timeouts=new Array();this.renderFlash();this.onscreen=false;$(this.wrapper).setStyle("display","none");}});var PaneTransition=new Class({initialize:function(_96){this.fadeOut=new Fx.Style(_96,"opacity",{duration:1500});this.elementID=_96;this.fadeOut.start(0.9,0);},end:function(){this.fadeOut.stop();$(this.elementID).style.display="none";$(this.elementID).setStyle("opacity",1);}});function if_remoteRequestStart(){}function if_remoteRequestEnd(){}function if_checkRemoteResult(_97){var _98="";if($type(_97)!="string"){return _97;}_98=Json.evaluate(_97,true);if(!_98){alert(_("Unable to Json decode what the server sent back.\n The server sent us:")+" '"+_97+"'\n");if_remoteRequestEnd();return null;}if_remoteRequestEnd();if(_98.resultCode!="OK"){if(_98.resultCode=="AUTH"){if($("relogin_pass")==null){var _99=$("opts-wrapper");var _9a="";_9a+="<h3>"+_("You were logged out.")+"</h3>";_9a+="<p>"+_("The server said:")+" "+_98.errorMessage+"</p>";_9a+="<p>"+_("Enter your password to login again:")+"</p>";_9a+="<input type=\"password\" name=\"relogin_pass\" id=\"relogin_pass\" />";_9a+="<button onclick=\"if_relogin(); return false\">"+_("Login")+"</button>";_99.setHTML(_9a);_99.setStyle("display","block");$("relogin_pass").focus();}}else{if(_98.imapNotices!=""){Lichen.Flash.flashMessage(_98.errorMessage,_("IMAP messages: ")+_98.imapNotices);}else{Lichen.Flash.flashMessage(_98.errorMessage,"");}return null;}}else{return _98;}}function if_remoteRequestFailed(_9b){if_remoteRequestEnd();Lichen.Flash.flashMessage(_9b);Lichen.Messages.getCallback(true);}function if_relogin(){var _9c=$("relogin_pass").value;new Ajax("index.php",{postBody:"action=relogin&user="+encodeURIComponent(serverUser)+"&pass="+encodeURIComponent(_9c),onComplete:if_reloginCB,onFailure:if_remoteRequestFailed}).request();}function if_reloginCB(_9d){var _9e=if_checkRemoteResult(_9d);if(!_9e){return;}if(_9e.error){Lichen.Flash.flashMessage(_9e.error);}else{$("opts-wrapper").setStyle("display","none");$("opts-wrapper").empty();}}function if_logoutSilent(){new Ajax("index.php",{postBody:"logout=0&silent=0",onComplete:if_logoutSilentCB,onFailure:if_remoteRequestFailed}).request();}function if_logoutSilentCB(_9f){var _a0=if_checkRemoteResult(_9f);if(!_a0){return;}Lichen.Flash.flashMessage(_("Silently logged out."));}function if_newWin(_a1){var nw=window.open(_a1);return !nw;}var MessagesDatastore=new Class({initialize:function(_a3){this.online=_a3;this.server=new IMAPServerConnector(this);this.cache=new HashCacheConnector(this,serverUser);this.callbacks=new Array();this.allMessagesMailbox=null;this.allMessagesSearch=null;},addCallback:function(_a4){this.callbacks.push(_a4);},getCallback:function(_a5){var _a6=this.callbacks.shift();if(_a5){_a6=null;}return _a6;},fetchMessageList:function(_a7,_a8,_a9,_aa){var _ab=this.cache.getMessageListValidity(_a7,_a8,_a9,_aa);var _ac=this.cache.getMessageList(_a7,_a8,_a9,_aa,_ab);if(_ac){Lichen.action("list","MessageList","listUpdateCB",[_ac]);}if(this.online){this.server.messageList(_a7,_a8,_a9,_aa,_ab);}if(!this.online&&!_ac){Lichen.Flash.flashMessage(_("Not online, and that data is not cached."));}},fetchMessageListCB:function(_ad,_ae,_af,_b0,_b1,_b2,_b3){if(_b0==-1){return;}var _b4=this.cache.getMessageList(_ae,_af,_b0,_b1,_b2);if(_b4==null){var _b4=this.cache.storeMessageList(_ae,_af,_b0,_b1,_ad.data,_ad.validityKey);if(_b3!="true"&&Lichen.getMode()=="list"){Lichen.action("list","MessageList","listUpdateCB",[_b4]);}if(this.online&&_b3!="true"){if(_b0!=0&&!this.cache.haveCachedMessageList(_ae,_af,_b0-1,_b1)){this.server.messageList(_ae,_af,_b0-1,_b1,this.cache.getMessageListValidity(_ae,_af,_b0-1,_b1),true);}if(_b4.numberpages>(_b0+1)&&!this.cache.haveCachedMessageList(_ae,_af,_b0+1,_b1)){this.server.messageList(_ae,_af,_b0+1,_b1,this.cache.getMessageListValidity(_ae,_af,_b0+1,_b1),true);}}}},fetchAdjacentMessages:function(_b5,_b6,_b7,_b8,uid){var _ba=-1;var _bb=-1;var _bc=-1;var _bd=null;var _be=null;var _bf=new Array();_bf.push(this.cache.getMessageList(_b5,_b6,_b7,_b8,this.cache.getMessageListValidity(_b5,_b6,_b7,_b8)));_bf.push(this.cache.getMessageList(_b5,_b6,_b7+1,_b8,this.cache.getMessageListValidity(_b5,_b6,_b7+1,_b8)));_bf.push(this.cache.getMessageList(_b5,_b6,_b7-1,_b8,this.cache.getMessageListValidity(_b5,_b6,_b7-1,_b8)));for(var j=0;j<_bf.length;j++){if(_bf[j]==null){continue;}for(var i=0;i<_bf[j].messages.length;i++){if(_bf[j].messages[i].uid==uid){_ba=i;_bb=_bf[j].thispage.toInt();_bc=j;break;}}if(_ba!=-1){break;}}if(_bb!=_b7){return this.fetchAdjacentMessages(_b5,_b6,_bb,_b8,uid);}if(_ba!=-1&&_bb!=-1){if(_ba>0){_bd=_bf[_bc].messages[_ba-1];}if(_ba==0){if(_bf[2]!=null){_bd=_bf[2].messages[_bf[2].messages.length-1];}}if(_ba<(_bf[_bc].messages.length-1)){_be=_bf[_bc].messages[_ba+1];}if(_ba==(_bf[_bc].messages.length-1)){if(_bf[1]!=null){_be=_bf[1].messages[0];}}}if(_bb!=-1&&_bb!=Lichen.MessageList.getPage()){Lichen.MessageList.setPage(_bb,true);if(this.online){if(_bb!=0){var _c2=this.cache.getMessageListValidity(_b5,_b6,_bb-1,_b8);if(!this.cache.getMessageList(_b5,_b6,_bb-1,_b8,_c2)){this.server.messageList(_b5,_b6,_bb-1,_b8,_c2,true);}}var _c2=this.cache.getMessageListValidity(_b5,_b6,_bb+1,_b8);if(!this.cache.getMessageList(_b5,_b6,_bb+1,_b8,_c2)){this.server.messageList(_b5,_b6,_bb+1,_b8,_c2,true);}}}var _c3={};_c3.previous=_bd;_c3.next=_be;return _c3;},fetchMailboxList:function(_c4){var _c5=this.cache.getMailboxListValidity();var _c6=this.cache.getMailboxList(_c5);if(_c4){return _c6;}if(this.online){this.server.mailboxList(_c5);}else{if(_c6){Lichen.MailboxList.listUpdateCB(_c6);}else{Lichen.Flash.flashMessage(_("Unable to fetch mailbox list: not online and not cached."));}}},fetchMailboxListCB:function(_c7){var _c8=this.cache.storeMailboxList(_c7.data,_c7.validity);Lichen.MailboxList.listUpdateCB(_c8);},fetchMailboxStatus:function(_c9){var _ca=this.cache.getMailboxListValidity();var _cb=this.cache.getMailboxList(_ca);var _cc=null;if(_cb){for(var i=0;i<_cb.length;i++){if(_cb[i].fullboxname==_c9){_cc=_cb[i];}}}else{}return _cc;},fetchMessage:function(_ce,uid,_d0){var _d1=this.cache.getMessage(_ce,uid,_d0,true);if(_d1){Lichen.action("display","MessageDisplayer","showMessageCB",[_d1]);}else{if(this.online){this.server.messageBody(_ce,uid,_d0);}else{Lichen.Flash.flashMessage(_("Unable to view message: in offline mode, and not cached."));}}},fetchMessageCB:function(_d2,_d3,uid){var _d5=this.cache.storeMessage(_d3,uid,_d2.data);Lichen.action("display","MessageDisplayer","showMessageCB",[_d2.data]);},fetchLargePart:function(_d6,uid,_d8,_d9){if(this.online){var _da=this.server.fetchLargePart(_d6,uid,_d8);_da="<pre>"+_da+"</pre>";this.cache.storeLargePart(_d6,uid,_d9,_da);return _da;}else{return _("Not online - unable to fetch that part of the message.");}},nextOperationOnAllMessages:function(_db,_dc){this.allMessagesMailbox=_db;this.allMessagesSearch=_dc;if(this.online){this.server.nextOperationOnAllMessages(_db,_dc);}else{}},clearOperationOnAllMessages:function(){if(this.online){this.server.clearOperationOnAllMessages();}this.allMessagesMailbox=null;this.allMessagesSearch=null;},moveMessage:function(_dd,_de,uid,_e0){this.addCallback(_e0);this.server.moveMessage(_dd,_de,uid);},moveMessageCB:function(_e1,_e2){this.genericServerCallback(_e1,_e2);},deleteMessage:function(_e3,uid,_e5){this.addCallback(_e5);this.server.deleteMessage(_e3,uid);},deleteMessageCB:function(_e6,_e7){this.genericServerCallback(_e6,_e7);},twiddleFlag:function(_e8,uid,_ea,_eb,_ec){this.addCallback(_ec);this.server.twiddleFlag(_e8,uid,_ea,_eb);},twiddleFlagCB:function(_ed,_ee){if(!_ee){this.cache.updateFlagStatus(Lichen.MessageList.getMailbox(),Lichen.MessageList.getSearch(),Lichen.MessageList.getPage(),Lichen.MessageList.getSortStr(),_ed.uid,_ed.flag,_ed.state);}this.genericServerCallback(_ed,_ee);},addressBookList:function(_ef,_f0,_f1){this.addCallback(_f1);this.server.addressBookList(_ef,_f0);},addressBookListCB:function(_f2,_f3){if(!_f3){}this.genericServerCallback(_f2,_f3);},addressBookEdit:function(_f4,_f5,_f6,_f7,_f8){this.addCallback(_f8);this.server.addressBookEdit(_f4,_f5,_f6,_f7);},addressBookEditCB:function(_f9,_fa){this.genericServerCallback(_f9,_fa);},addressBookDelete:function(_fb,_fc){this.addCallback(_fc);this.server.addressBookDelete(_fb);},addressBookDeleteCB:function(_fd,_fe){this.genericServerCallback(_fd,_fe);},genericServerCallback:function(_ff,_100){var _101=this.getCallback(_100);if(_101){_101(_ff);}}});var MailboxManagerClass=new Class({initialize:function(_102){this.mailboxCache=null;this.dataStore=_102;},renameInline:function(_103,_104){if($("mbm-namearea-"+_103)){var _105="<input id=\"mbm-rename-"+_103+"\" type=\"text\" size=\"20\" value=\""+_104+"\" />";_105+="<button onclick=\"Lichen.MailboxManager.renameDone('"+_103+"', '"+_104+"');return false\">"+_("save")+"</button> <button onclick=\"Lichen.MailboxManager.renameCancel('"+_103+"');return false\">"+_("cancel")+"</button> ";$("mbm-namearea-"+_103).setHTML(_105);var _106=$("mbm-rename-"+_103);if(_106){_106.focus();}}},renameDone:function(_107,_108){var _109=$("mbm-rename-"+_107);if(_109){var _10a=_109.value;if(_10a&&_10a!=""){if(_10a==_108){this.serverActionCB({action:"rename",mailbox1:_107,mailbox2:_107});}else{_10a=_107.substr(0,_107.length-_108.length)+_10a;new Ajax("ajax.php",{postBody:"request=mailboxAction&action=rename&mailbox1="+encodeURIComponent(_107)+"&mailbox2="+encodeURIComponent(_10a),onComplete:this.serverActionCB.bind(this),onFailure:if_remoteRequestFailed}).request();}}}},renameCancel:function(_10b){var _10c=$("mbm-rename-"+_10b);if(_10c){this.serverActionCB({action:"rename",mailbox1:_10b,mailbox2:_10b});}},mailboxDelete:function(_10d,_10e){if(confirm(_("Are you sure you want to delete '")+_10e+_("'?\nAll messages in this mailbox will be deleted.\nThis cannot be undone."))){new Ajax("ajax.php",{postBody:"request=mailboxAction&action=delete&mailbox1="+encodeURIComponent(_10d),onComplete:this.serverActionCB.bind(this),onFailure:if_remoteRequestFailed}).request();}},newChild:function(_10f){var _110=$("mbm-changearea-"+_10f);if(_110){var _111="<div id=\"mbm-newchild-wrapper-"+_10f+"\">";_111+=_("New Subfolder:")+" <input id=\"mbm-newchild-"+_10f+"\" type=\"text\" size=\"20\" />";_111+="<button onclick=\"Lichen.MailboxManager.newChildSubmit('"+_10f+"'); return false\">"+_("Add")+"</button>";_111+="<button onclick=\"Lichen.MailboxManager.newChildCancel('"+_10f+"'); return false\">"+_("Cancel")+"</button>";_111+="</div>";_110.setHTML(_111);var _112=$("mbm-newchild-"+_10f);if(_112){_112.focus();}}},newChildSubmit:function(_113){var _114=$("mbm-newchild-"+_113);if(_114&&_114.value!=""){new Ajax("ajax.php",{postBody:"request=mailboxAction&action=create&mailbox1="+encodeURIComponent(_113)+"&mailbox2="+encodeURIComponent(_114.value),onComplete:this.serverActionCB.bind(this),onFailure:if_remoteRequestFailed}).request();}},newChildCancel:function(_115){var _116=$("mbm-newchild-wrapper-"+_115);if(_116){_116.remove();}},changeParentInline:function(_117,_118){var _119=$("mbm-changearea-"+_117);if(_119){var _11a="<div id=\"mbm-changeparent-wrapper-"+_117+"\">";_11a+=_("Move to subfolder of: ");_11a+="<select id=\"mbm-changeparent-"+_117+"\">";_11a+="<option value=\"\">"+_("[Top Level]")+"</option>";for(var i=0;i<this.mailboxCache.length;i++){var _11c=this.mailboxCache[i];_11a+="<option value=\""+_11c.fullboxname+"\"";if(_118==_11c.mailbox){_11a+=" selected=\"selected\">";}else{_11a+=">";}for(var j=0;j<_11c.folderdepth;j++){_11a+="-";}_11a+=_11c.mailbox+"</option>";}_11a+="</select>";_11a+="<button onclick=\"Lichen.MailboxManager.changeParentSubmit('"+_117+"', '"+_118+"'); return false\">"+_("Move")+"</button>";_11a+="<button onclick=\"Lichen.MailboxManager.changeParentCancel('"+_117+"', '"+_118+"'); return false\">"+_("Cancel")+"</button>";_11a+="</div>";_119.setHTML(_11a);}},changeParentSubmit:function(_11e,_11f){var _120=$("mbm-changeparent-"+_11e);if(_120&&_120.value!=_11f){new Ajax("ajax.php",{postBody:"request=mailboxAction&action=move&mailbox1="+encodeURIComponent(_11e)+"&mailbox2="+encodeURIComponent(_120.value),onComplete:this.serverActionCB.bind(this),onFailure:if_remoteRequestFailed}).request();}},changeParentCancel:function(_121,_122){var _123=$("mbm-changeparent-wrapper-"+_121);if(_123){_123.remove();}},serverActionCB:function(_124){var _125=if_checkRemoteResult(_124);if(!_125){return;}Lichen.action("options","OptionsEditor","showEditor",["mailboxes"]);if(_125.mailboxes){this.mailboxCache=_125.mailboxes;}}});var MailboxLister=new Class({initialize:function(_126){this.wrapper=_126;this.mailboxCount=0;this.lastUIDconst=-1;this.mailboxCount=-1;this.msgCount=-1;this.openMailboxes=new Array();this.listCache=null;},isMailboxOpen:function(_127){for(var i=0;i<this.openMailboxes.length;i++){if(this.openMailboxes[i]==_127){return i;}}return -1;},listUpdate:function(){Lichen.Messages.fetchMailboxList();},listUpdateCB:function(_129){var _12a=_129;this.listCache=_129;if(this.mailboxCount!=_12a.length){this._render(_12a);this.mailboxCount=_12a.length;}var i=0;for(i=0;i<_12a.length;i++){if(Lichen.MessageList.getMailbox()==_12a[i].fullboxname){if(this.lastUIDconst!=-1&&this.lastUIDconst!=_12a[i].uidConst){Lichen.action("list","MessageList","listUpdate");}else{if(this.msgCount!=-1&&this.msgCount!=_12a[i].messages){Lichen.action("list","MessageList","listUpdate");}}this.lastUIDconst=_12a[i].uidConst;this.msgCount=_12a[i].messages;$("mb-"+Lichen.MessageList.getMailbox()).addClass("mb-active");}var _12c="";if(_12a[i].unseen>0||userSettings.boxlist_showtotal){_12c="("+_12a[i].unseen;if(userSettings.boxlist_showtotal){_12c+="/"+_12a[i].messages;}_12c+=")";}if($("mb-unread-"+_12a[i].fullboxname)){$("mb-unread-"+_12a[i].fullboxname).setHTML(_12c);}else{this._render(_12a);return;}}this.mailboxCount=_129.length;},_render:function(_12d){$(this.wrapper).empty();var _12e="<li id=\"mb-header\"><span class=\"s-head\">"+_("Mailboxes")+"</span> [<a href=\"#manage-mailboxes\" onclick=\"return Lichen.action('options','OptionsEditor','showEditor',['mailboxes'])\">"+_("edit")+"</a>]</li>";var _12f=new Array();for(var i=0;i<_12d.length;i++){if(_12f.length>0){var _131=_12f[_12f.length-1];if(_12d[i].fullboxname.substr(0,_131.length)==_131){continue;}else{_12f.pop();}}_12e+="<li id=\"mb-"+_12d[i].fullboxname;if(Lichen.MessageList.getMailbox()==_12d[i].fullboxname){_12e+="\" class=\"mb-active";}_12e+="\">";if(_12d[i].haschildren){_12e+=" <a href=\"#\" style=\"float:right;\" onclick=\"return Lichen.MailboxList.viewToggle('"+_12d[i].fullboxname+"');\">";if(this.isMailboxOpen(_12d[i].fullboxname)!=-1){_12e+="<img width=\"8\" height=\"8\" src=\"themes/"+userSettings.theme+"/icons/folder_contract.png\" alt=\""+_("[contract]")+"\" />";}else{_12f.push(_12d[i].fullboxname+_12d[i].delimiter);_12e+="<img width=\"8\" height=\"8\" src=\"themes/"+userSettings.theme+"/icons/folder_expand.png\" alt=\""+_("[expand]")+"\" />";}_12e+="</a>";}if(_12d[i].selectable){_12e+="<a href=\"#\" onclick=\"return Lichen.action('list', 'MailboxList', 'selectMailbox', ['"+_12d[i].fullboxname+"'])\" class=\"mb-click\">";}else{_12e+="<div class=\"mb-noclick\">";}for(var j=0;j<_12d[i].folderdepth;j++){_12e+="&nbsp;&nbsp;";}_12e+="<span class=\"mailbox\">"+_12d[i].mailbox;_12e+=" <span id=\"mb-unread-"+_12d[i].fullboxname+"\">";if(_12d[i].unseen>0||userSettings.boxlist_showtotal){_12e+="("+_12d[i].unseen;if(userSettings.boxlist_showtotal){_12e+="/"+_12d[i].messages;}_12e+=")";}_12e+="</span>";_12e+="</span>";if(_12d[i].selectable){_12e+="</a>";}else{_12e+="</div>";}_12e+="</li>";}$(this.wrapper).setHTML(_12e);},selectMailbox:function(_133){this.lastUIDconst="";this.msgCount=0;var _134=$("mb-"+Lichen.MessageList.getMailbox());if(_134){_134.removeClass("mb-active");}Lichen.action("list","MessageList","setMailbox",[_133]);$("mb-"+Lichen.MessageList.getMailbox()).addClass("mb-active");return false;},viewToggle:function(_135){var _136=this.isMailboxOpen(_135);if(_136==-1){this.openMailboxes.push(_135);this._render(this.listCache);}else{this.openMailboxes.splice(_136,1);this._render(this.listCache);}return false;}});var MessageDisplay=new Class({initialize:function(_137,_138){this.dataStore=_137;this.wrapperdiv=_138;this.displayMode="";this.displayModeUID="";this.lastShownUID="";this.messageData=null;},getViewedUID:function(){return this.lastShownUID;},getWindowTitle:function(){if(this.messageData){return this.messageData.subject+_(" - Message Display");}else{return _("Message Display");}},showMessage:function(_139,uid,mode){this.displayMode=mode;this.displayModeUID=uid;var _13c=mode;if(mode=="monospace"){_13c="text";}this.dataStore.fetchMessage(_139,uid,_13c);return false;},showMessageCB:function(_13d,mode){if($("mr-"+_13d.uid)){$("mr-"+_13d.uid).removeClass("new");}if(!mode&&this.displayModeUID==_13d.uid){mode=this.displayMode;}$(this.wrapperdiv).empty();$(this.wrapperdiv).setHTML(this._render(_13d,mode));$(this.wrapperdiv).style.display="block";$("msg-bar").style.display="block";this.lastShownUID=_13d.uid;var _13f=$("btn-draft");if(Lichen.MessageList.getMailbox()==specialFolders.drafts){_13f.setStyle("display","inline");}else{_13f.setStyle("display","none");}},_render:function(_140,_141){var _142=this.dataStore.fetchAdjacentMessages(Lichen.MessageList.getMailbox(),Lichen.MessageList.getSearch(),Lichen.MessageList.getPage(),Lichen.MessageList.getSortStr(),_140.uid);var _143="<div class=\"list-header-bar\"><img src=\"themes/"+userSettings.theme+"/top-corner.png\" alt=\"\" class=\"top-corner\" />";var _144="<div class=\"header-left\"><a class=\"list-return\" href=\"#inbox\" onclick=\"Lichen.action('list','MessageList','listUpdate');return false\">"+_("back to ")+Lichen.MessageList.getMailbox()+"</a></div>";_144+="<div class=\"header-right\">";if(_142.previous){_144+="<a href=\"#\" onclick=\"return Lichen.action('display','MessageDisplayer','showMessage',['"+_140.mailbox+"','"+_142.previous.uid+"'])\">"+"&laquo; ";if(_142.previous.subject.length>24){_144+=_142.previous.subject.substr(0,24)+"...";}else{_144+=_142.previous.subject;}if(_142.next){_144+="</a> | ";}else{_144+="</a>";}}if(_142.next){_144+="<a href=\"#\" onclick=\"return Lichen.action('display','MessageDisplayer','showMessage',['"+_140.mailbox+"','"+_142.next.uid+"'])\">";if(_142.next.subject.length>24){_144+=_142.next.subject.substr(0,24)+"...";}else{_144+=_142.next.subject;}_144+=" &raquo;"+"</a>";}_144+="</div>";_144+="<div class=\"header-left\">";_144+="<select onchange=\"Lichen.MessageDisplayer.moveMessage(this)\">";_144+="<option value=\"noop\" selected=\"selected\">"+_("move message to ...")+"</option>";if(!window.ie){mailboxes=this.dataStore.fetchMailboxList(true);}if(mailboxes){for(var i=0;i<mailboxes.length;i++){_144+="<option value=\"move-"+mailboxes[i].fullboxname+"\">";for(var j=0;j<mailboxes[i].folderdepth;j++){_144+="-";}_144+=mailboxes[i].mailbox;_144+="</option>";}}_144+="</select>";_144+=" &nbsp; <input type=\"button\" onclick=\"Lichen.MessageDisplayer.deleteMessage();return false\" value=\""+_("delete message")+"\" />";_144+="</div>";_144+="</div>";_143+=_144;_143+="<select id=\"msg-switch-view\" onchange=\"return Lichen.action('display','MessageDisplayer','switchView',[this.value])\">";_143+="<option value=\"noop\">"+_("switch view ...")+"</option>";if(_140.texthtml.length>0||_140.texthtmlpresent){_143+="<option value=\"html\">"+_("HTML part")+"</option>";}if(_140.textplain.length>0||_140.textplainpresent){_143+="<option value=\"text\">"+_("text part")+"</option>";_143+="<option value=\"text-mono\">"+_("monospace text")+"</option>";}_143+="<option value=\"source\">"+_("message source")+"</option>";_143+="</select>";_143+="<h1 class=\"msg-head-subject\">"+_140.subject_html+"</h1>";_143+="<p class=\"msg-head-line2\" id=\"msg-details-short\">";_143+=_("to")+" <span class=\"msg-head-sender\">"+_140.to_html+"</span><br />";_143+=_("from")+" <span class=\"msg-head-sender\">"+_140.from_html+"</span> ";_143+="at <span class=\"msg-head-date\">"+_140.localdate+"</span> ";_143+="</p>";if(_140.htmlhasremoteimages){_143+="<div class=\"msg-notification\" id=\"msg-remoteimagesnotify\">";_143+=_("Remote images are not displayed.")+" [<a href=\"#\" onclick=\"return Lichen.MessageDisplayer.enableRemoteContent()\">"+_("show images")+"</a>]";_143+="</div>";}if(_140.texthtml.length>0&&_141!="text"&&_141!="monospace"&&_141!="source"){for(var i=0;i<_140.texthtml.length;i++){_143+="<div class=\"html-message\">";_143+=_140.texthtml[i];_143+="</div>";}}else{for(var i=0;i<_140.textplain.length;i++){_143+="<div id=\"plainmsg-"+i+"\" class=\"plain-message";if(_141=="monospace"){_143+=" plain-message-monospace";}_143+="\">";if(_140.textplain[i].substr(0,14)=="LICHENTOOLARGE"){var _147=_140.textplain[i].substr(15).split(")")[0];_143+="<a href=\"#\" onclick=\"Lichen.MessageDisplayer.getLargePart('"+_140.uid+"', '"+_140.mailbox+"','"+_147+"',"+i+");return false\">"+("This message part was too large to return directly. Click here to load it.")+"</a>";}else{_143+=_140.textplain[i];}_143+="</div>";}}if(_140.attachments.length>0&&_141!="source"){_143+="<ul class=\"attachments\">";for(var i=0;i<_140.attachments.length;i++){var _148=_140.attachments[i];if(_148.filename==""){continue;}_143+="<li>";var _149="message.php?mailbox="+encodeURIComponent(_140.mailbox)+"&uid="+encodeURIComponent(_140.uid)+"&filename="+encodeURIComponent(_148.filename);_143+="<a href=\""+_149+"\" onclick=\"return if_newWin('"+_149+"')\">";_143+=_148.filename+"</a>";_143+=" <span class=\"msg-attach-meta\">type "+_148.type+", size ~"+_148.size+" bytes</span>";if(_148.type.substr(0,5)=="image"){_143+="<br />";_143+="<img src=\""+_149+"\" alt=\""+_149+"\" />";}}_143+="</ul>";}_143+="<div class=\"footer-bar\"><img src=\"themes/"+userSettings.theme+"/bottom-corner.png\" alt=\"\" class=\"bottom-corner\" />"+_144+"</div>";this.messageData=_140;return _143;},switchView:function(_14a){switch(_14a){case "html":this.showMessage(Lichen.MessageList.getMailbox(),this.lastShownUID,"html");break;case "text":this.showMessage(Lichen.MessageList.getMailbox(),this.lastShownUID,"text");break;case "text-mono":this.showMessage(Lichen.MessageList.getMailbox(),this.lastShownUID,"monospace");break;case "source":if_newWin("message.php?source&mailbox="+encodeURIComponent(Lichen.MessageList.getMailbox())+"&uid="+encodeURIComponent(this.lastShownUID));break;}return false;},alwaysEnableRemoteContent:function(){this.enableRemoteContent();},showFullDetails:function(){$("msg-details-short").setStyle("display","none");$("msg-details-long").setStyle("display","block");},enableRemoteContent:function(){if(this.messageData.htmlhasremoteimages){for(var i=0;i<this.messageData.remotecontent.length;i++){var _14c=this.messageData.remotecontent[i];var _14d=$(_14c.id);if(_14d){if(_14c.attr=="style"){for(var j=0;j<_14c.url.length;j++){_14d.setStyle(_14c.url[j][0],_14c.url[j][1]);}}else{_14d[_14c.attr]=_14c.url;}}}}$("msg-remoteimagesnotify").setStyle("display","none");return false;},getLargePart:function(uid,_150,part,_152){$("plainmsg-"+_152).setHTML(_("Please wait... this might take a while..."));var _153=Lichen.Messages.fetchLargePart(_150,uid,part,_152);$("plainmsg-"+_152).setHTML(_153);},moveMessage:function(_154){var _155=_154.value.substr(5);Lichen.Messages.moveMessage(Lichen.MessageList.getMailbox(),_155,this.displayModeUID,this.movedMessageCB.bind(this));},deleteMessage:function(){Lichen.Messages.deleteMessage(Lichen.MessageList.getMailbox(),this.displayModeUID,this.movedMessageCB.bind(this));},movedMessageCB:function(_156){Lichen.Flash.flashMessage(_156.message);var _157=this.dataStore.fetchAdjacentMessages(Lichen.MessageList.getMailbox(),Lichen.MessageList.getSearch(),Lichen.MessageList.getPage(),Lichen.MessageList.getSortStr(),this.displayModeUID);if(_157.next){this.showMessage(Lichen.MessageList.getMailbox(),_157.next.uid);}else{Lichen.action("list","MessageList","listUpdate");}}});var MessageLister=new Class({initialize:function(_158,_159){this.parseSort(userSettings.list_sortmode);this.mailbox=specialFolders.inbox;this.page=0;this.search="";this.wrapper=_159;this.dataStore=_158;this.numberPages=1;this.messagesOnThisPage=0;this.messagesInMailbox=0;this.unreadMessages=0;this.allSelectedStatus=0;},getWindowTitle:function(){var _15a=this.mailbox+" (";_15a+=this.unreadMessages+_(" unread, ");_15a+=this.messagesInMailbox+_(" total");_15a+=")";return _15a;},setSort:function(_15b,_15c){$("list-sort-"+this.sort).getParent().getElementsByTagName("img")[0].remove();if(_15b==this.sort){this.sortAsc=!this.sortAsc;}else{this.sort=_15b;this.sortAsc=true;}userSettings.list_sortmode=this.getSortStr();if(!_15c){this.listUpdate();}},getSortStr:function(){return this.sort+(this.sortAsc?"":"_r");},getSort:function(){return this.sort;},getSortAsc:function(){return this.sortAsc;},parseSort:function(_15d){if(_15d){if(_15d.substr(_15d.length-2,2)=="_r"){this.sort=_15d.substr(0,_15d.length-2);this.sortAsc=false;}else{this.sort=_15d;this.sortAsc=true;}}else{this.sort="date";this.sortAsc=false;}},setSearch:function(_15e,_15f){if(this.search!=_15e){this.search=_15e;this.page=0;this.allSelectedStatus=0;if(!_15f){this.listUpdate();}}if(_15e==""){if($("qsearch")){$("qsearch").value="";}}return false;},getSearch:function(){return this.search;},setMailbox:function(_160,_161){if(this.mailbox!=_160){this.mailbox=_160;this.page=0;this.search="";this.allSelectedStatus=0;}if(!_161){this.listUpdate();}return false;},getMailbox:function(){return this.mailbox;},setPage:function(_162,_163){if(this.page!=_162){if(_162>=0&&_162<=(this.numberPages-1)){if(this.allSelectedStatus!=2){this.allSelectedStatus=0;}this.page=_162;if(!_163){this.listUpdate();}}}return false;},nextPage:function(){return this.setPage(this.page+1);},previousPage:function(){return this.setPage(this.page-1);},firstPage:function(){return this.setPage(0);},lastPage:function(){return this.setPage(this.numberPages);},listUpdate:function(){Lichen.busy();this.dataStore.fetchMessageList(this.mailbox,this.search,this.page,this.getSortStr());},getPage:function(){return this.page;},listUpdateCB:function(_164){Lichen.notbusy();if(_164.mailbox!=this.mailbox||_164.search!=this.search||_164.sort!=this.getSortStr()||_164.thispage!=this.page){return;}if(_164.thispage>=_164.numberpages||_164.thispage==-1){this.setPage(_164.numberpages-1);return;}this.numberPages=_164.numberpages;if(_164.unreadmessages!=null){this.unreadMessages=_164.unreadmessages;}this._render(_164.messages,_164);this.dataStore.fetchMailboxList();},_render:function(_165,_166){var _167=this.getSelectedMessages();$(this.wrapper).empty();var _168="";_168+=this._createPageBar(_166,true);if(this.search!=""){_168+="<div class=\"list-notification\"><strong>"+_("Found ")+_166.numbermessages+_(" results for")+" &#8220;"+this.search+"&#8221;</strong> "+"[<a href=\"#clearsearch\" onclick=\"return Lichen.action('list','MessageList','setSearch',[''])\">"+_("clear search")+"</a>]</div>";this.messagesInMailbox=_166.numbermessages;}else{this.messagesInMailbox=_166.mailboxmessages;}this.messagesOnThisPage=_165.length;var _169=this.allSelectedDisplay(true);_168+="<div class=\"list-notification\" id=\"select-all-notification\" ";if(_169==""){_168+="style=\"display: none\">";}else{_168+=">"+_169;}_168+="</div>";_168+="<table id=\"list-data-tbl\" class=\"messagelist\">";var _16a=window.getWidth()-515;if(userSettings.list_showsize){_16a=window.getWidth()-590;}_168+="<colgroup><col class=\"mcol-checkbox\" /><col class=\"mcol-flag\" /><col class=\"mcol-sender\" /><col class=\"mcol-subject\" style=\"width:"+_16a+"px\" />";if(userSettings.list_showsize){_168+="<col class=\"mcol-size\" />";}_168+="<col class=\"mcol-date\" /></colgroup>";_168+="<thead><tr class=\"list-sortrow\">";_168+="<th><input type=\"checkbox\" id=\"list-check-main\" value=\"0\" onclick=\"Lichen.MessageList.selectMessages(0)\" /></th><th></th>";_168+="<th class=\"list-sortlabel\"><a href=\"#sort-from\" id=\"list-sort-from\" onclick=\"Lichen.MessageList.setSort('from');return false\">"+_("sender")+"</a></th>";_168+="<th class=\"list-sortlabel\"><a href=\"#sort-subject\" id=\"list-sort-subject\" onclick=\"Lichen.MessageList.setSort('subject');return false\">"+_("subject")+"</a></th>";if(userSettings.list_showsize){_168+="<th class=\"list-sortlabel\"><a href=\"#sort-size\" id=\"list-sort-size\" onclick=\"Lichen.MessageList.setSort('size');return false\">"+_("size")+"</a></th>";}_168+="<th class=\"list-sortlabel\"><a href=\"#sort-date\" id=\"list-sort-date\" onclick=\"Lichen.MessageList.setSort('date');return false\">"+_("date")+"</a></th>";_168+="</tr></thead><tbody>";if(_165.length==0){_168+="<tr><td colspan=\"5\" class=\"list-nothing\">"+_("No messages in this mailbox.")+"</td></tr>";}for(var i=0;i<_165.length;i++){var _16c=_165[i];var uid=_16c.uid;var _16e="<tr id=\"mr-"+_16c.uid+"\" class=\"";if(i%2==1){_16e+="odd";}else{_16e+="even";}if(_16c.readStatus=="U"){_16e+=" new";}if(this.allSelectedStatus==2){_16e+=" active";}_16e+="\">";_16e+="<td><input type=\"checkbox\" class=\"msg-select\" name=\"s-"+_16c.uid+"\" id=\"s-"+_16c.uid+"\" value=\""+_16c.uid+"\" onclick=\"Lichen.MessageList.messageCheckboxClicked(this);\" /></td>";var _16f=_16c.flagged?"/icons/flag.png":"/icons/flag_off.png";_16e+="<td><img src=\"themes/"+userSettings.theme+_16f+"\" id=\"f-"+_16c.uid+"\" alt=\"\" onclick=\"Lichen.MessageList.twiddleFlag('"+_16c.uid+"', 'flagged', 'toggle')\" title=\"Flag this message\" class=\"list-flag\" /></td>";_16e+="<td class=\"sender\" onclick=\"Lichen.action('display','MessageDisplayer','showMessage',['"+this.mailbox+"','"+_16c.uid+"'])\"";if(_16c.fromName==""){if(_16c.fromAddr.length>22){_16e+=" title=\""+_16c.fromAddr+"\"";}_16e+="><div class=\"sender\">"+_16c.fromAddr;}else{_16e+=" title=\""+_16c.fromAddr+"\"><div class=\"sender\">"+_16c.fromName;}_16e+="</div></td>";_16e+="<td class=\"subject\" onclick=\"Lichen.action('display','MessageDisplayer','showMessage',['"+this.mailbox+"','"+_16c.uid+"'])\"><div class=\"subject\">"+_16c.subject;if(userSettings.list_showpreviews){_16e+="<span class=\"messagePreview\">"+_16c.preview+"</span>";}_16e+="</div></td>";if(userSettings.list_showsize){_16e+="<td class=\"size\"><div class=\"size\">"+_16c.size+"</div></td>";}_16e+="<td class=\"date\"><div class=\"date\">"+_16c.dateString+"</div></td>";_16e+="</tr>";_168+=_16e;}_168+="</tbody></table>";_168+=this._createPageBar(_166,false);$(this.wrapper).setHTML(_168);var _170=null;if(!this.sortAsc){_170=new Element("img",{"class":"list-sort-marker","src":"themes/"+userSettings.theme+"/icons/sort_decrease.png"});}else{_170=new Element("img",{"class":"list-sort-marker","src":"themes/"+userSettings.theme+"/icons/sort_incr.png"});}$("list-sort-"+this.sort).getParent().adopt(_170);if(this.allSelectedStatus==2){this.selectMessages(7);}else{for(var i=0;i<_167.length;i++){var _171=$("s-"+_167[i]);if(_171){_171.checked=true;}}}},_createPageBar:function(_172,_173){var _174="";if(_173){_174+="<div class=\"list-header-bar\"><img src=\"themes/"+userSettings.theme+"/top-corner.png\" alt=\"\" class=\"top-corner\" />";}else{_174+="<div class=\"list-footer-bar\"><img src=\"themes/"+userSettings.theme+"/bottom-corner.png\" alt=\"\" class=\"bottom-corner\" />";}var _175=_172.thispage+1;var _176=_172.numberpages;var _177=_175*_172.pagesize;if(_177>_172.numbermessages){_177=_172.numbermessages;}_174+="<div class=\"header-left\">";_174+="<select onchange=\"Lichen.MessageList.withSelected(this)\">";_174+="<option value=\"noop\" selected=\"selected\">"+_("move selected to ...")+"</option>";if(!window.ie){mailboxes=this.dataStore.fetchMailboxList(true);}if(mailboxes){for(var i=0;i<mailboxes.length;i++){_174+="<option value=\"move-"+mailboxes[i].fullboxname+"\">";for(var j=0;j<mailboxes[i].folderdepth;j++){_174+="-";}_174+=mailboxes[i].mailbox;_174+="</option>";}}_174+="</select>";_174+=" &nbsp; <input type=\"button\" onclick=\"Lichen.MessageList.deleteMessages();return false\" value=\""+_("delete")+"\" />";_174+=" &nbsp; <input type=\"button\" onclick=\"Lichen.MessageList.withSelected(null, 'flag');return false\" value=\""+_("flag")+"\" />";_174+=" &nbsp; <input type=\"button\" onclick=\"Lichen.MessageList.withSelected(null, 'markseen');return false\" value=\""+_("mark read")+"\" /><br />";if(!_173){_174+="select: <a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(1);return false\">"+_("all")+"</a> | ";_174+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(2);return false\">"+_("none")+"</a> | ";_174+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(3);return false\">"+_("read")+"</a> | ";_174+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(4);return false\">"+_("unread")+"</a> | ";_174+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(5);return false\">"+_("flagged")+"</a> | ";_174+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(6);return false\">"+_("unflagged")+"</a> | ";_174+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(0);return false\">"+_("invert")+"</a>";}_174+="</div><div class=\"header-right\">";if(_172.numberpages>1){var _17a=_("previous");var _17b=_("next");if(this.sort=="date"){if(this.sortAsc){_17a=_("earlier");_17b=_("later");}else{_17a=_("later");_17b=_("earlier");}}if(_175>1){_174+="<a href=\"#\" onclick=\"Lichen.MessageList.previousPage(); return false\">"+_17a+"</a> | ";}_174+="<select onchange=\"Lichen.MessageList.setPage(this.value);\">";var _17c=_172.pagesize;var _17d=_172.numbermessages;var _17e=0;for(var i=1;i<=_172.numbermessages;i+=_17c){_174+="<option value=\""+_17e+"\"";if(_175==(_17e+1)){_174+=" selected=\"selected\"";}_174+=">"+i+" to ";if((_17e+1)*_17c>_17d){_174+=_17d;}else{_174+=(_17e+1)*_17c;}_174+="</option>";_17e++;}_174+="</select>";_174+=" of "+_172.numbermessages;if(_176-_175>0){_174+=" | <a href=\"#\" onclick=\"Lichen.MessageList.nextPage(); return false\">"+_17b+"</a>";}}else{if(_172.numbermessages>0&&!_173){_174+=_("showing 1 to ")+_172.numbermessages+_(" of ")+_172.numbermessages;}}_174+="</div></div>";return _174;},getSelectedMessages:function(){var _17f=new Array();var _180=$A($(this.wrapper).getElementsByTagName("input"));for(var i=0;i<_180.length;i++){if(_180[i].type!="checkbox"){continue;}if(_180[i].checked){_17f.push(_180[i].value);}}return _17f;},messageCheckboxClicked:function(_182){this.allSelectedStatus=0;this.allSelectedDisplay();this.setRowActive(_182);return false;},setRowActive:function(_183){var _184=$("mr-"+_183.value);if(_183.checked){_184.addClass("active");}else{_184.removeClass("active");}},allSelectedDisplay:function(_185){var _186="";if(this.allSelectedStatus==0){if(!_185){$("select-all-notification").setStyle("display","none");}}else{if(this.allSelectedStatus==1){_186+=_("Only the ")+"<b>"+this.messagesOnThisPage+"</b>"+_(" messages on this page have been selected. ");_186+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(7);\">";if(this.getSearch()==""){_186+=_("Select all messages in this mailbox");}else{_186+=_("Select all messages from this search");}_186+="</a>.";}else{_186+=_("All ")+"<b>"+this.messagesInMailbox+"</b>"+_(" messages ");if(this.getSearch()==""){_186+=_("in this mailbox have been selected. ");}else{_186+=_("from this search have been selected. ");}_186+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(1);\">";_186+=_("Select only the messages on this page");_186+="</a>.";}if(!_185){$("select-all-notification").setHTML(_186);$("select-all-notification").setStyle("display","block");}}return _186;},allSelectedServerNotify:function(_187){if(this.allSelectedStatus==2){Lichen.Messages.nextOperationOnAllMessages(this.getMailbox(),this.getSearch());}else{Lichen.Messages.clearOperationOnAllMessages();}if(_187){this.allSelectedStatus=0;Lichen.Messages.clearOperationOnAllMessages();}},selectMessages:function(mode){var _189=$A($("list-data-tbl").getElementsByTagName("input"));this.allSelectedStatus=0;if(mode==1){this.allSelectedStatus=1;}else{if(mode==7){this.allSelectedStatus=2;}}for(var i=1;i<_189.length;i++){var _18b=_189[i].value;switch(mode){case 1:case 7:_189[i].checked=true;break;case 2:_189[i].checked=false;break;case 3:_189[i].checked=!$("mr-"+_18b).hasClass("new");break;case 4:_189[i].checked=$("mr-"+_18b).hasClass("new");break;case 5:_189[i].checked=!($("f-"+_18b).src.substring($("f-"+_18b).src.length-12)=="flag_off.png");break;case 6:_189[i].checked=($("f-"+_18b).src.substring($("f-"+_18b).src.length-12)=="flag_off.png");break;default:_189[i].checked=!_189[i].checked;break;}this.setRowActive(_189[i]);}this.allSelectedDisplay();},withSelected:function(_18c,_18d){var _18e=this.getSelectedMessages();var _18f="noop";if(!_18c&&_18d){_18f=_18d;}else{_18f=_18c.value;}var _190="";if(_18f.substr(0,5)=="move-"){_190=_18f.substr(5);_18f="move";}this.allSelectedServerNotify();switch(_18f){case "noop":break;case "markseen":this.twiddleFlag(_18e.join(","),"seen","true");break;case "markunseen":this.twiddleFlag(_18e.join(","),"seen","false");break;case "flag":this.twiddleFlag(_18e.join(","),"flagged","true");break;case "unflag":this.twiddleFlag(_18e.join(","),"flagged","false");break;case "move":this.moveMessages(_190);break;}if(_18c){_18c.selectedIndex=0;}},twiddleFlag:function(uid,flag,_193){Lichen.Messages.twiddleFlag(this.getMailbox(),uid,flag,_193,this.twiddleFlagCB.bind(this));},twiddleFlagCB:function(_194){var _195=_194.uid.split(",");if(_194.flag=="seen"){for(var i=0;i<_195.length;i++){var _197=$("mr-"+_195[i]);if(_197){if(!_194.state){_197.addClass("new");}else{_197.removeClass("new");}}}}if(_194.flag=="flagged"){for(var i=0;i<_195.length;i++){var _198=$("f-"+_195[i]);if(_198){if(_194.state){_198.src="themes/"+userSettings.theme+"/icons/flag.png";}else{_198.src="themes/"+userSettings.theme+"/icons/flag_off.png";}}}}if(_195.length>1){Lichen.Flash.flashMessage(_("Updated ")+_195.length+_(" messages."));}},moveMessages:function(_199){var _19a=this.getSelectedMessages();var _19b=_19a.length;_19a=_19a.join(",");this.allSelectedServerNotify();Lichen.Messages.moveMessage(this.getMailbox(),_199,_19a,this.moveMessagesCB.bind(this));this.allSelectedServerNotify(true);},deleteMessages:function(){var _19c=this.getSelectedMessages();var _19d=_19c.length;_19c=_19c.join(",");this.allSelectedServerNotify();Lichen.Messages.deleteMessage(this.getMailbox(),_19c,this.moveMessagesCB.bind(this));this.allSelectedServerNotify(true);},moveMessagesCB:function(_19e){Lichen.Flash.flashMessage(_19e.message);this.listUpdate();},threadTest:function(){new Ajax("ajax.php",{postBody:"request=getThreadedList&mailbox="+encodeURIComponent(this.getMailbox()),onComplete:this.threadTestCB.bind(this),onFailure:if_remoteRequestFailed}).request();},threadTestCB:function(_19f){var _1a0=if_checkRemoteResult(_19f);if(!_1a0){return;}$(this.wrapper).setHTML(_1a0.htmlFragment);}});var IMAPServerConnector=new Class({initialize:function(_1a1){this.dataStore=_1a1;this.allMessagesMailbox=null;this.allMessagesSearch=null;},nextOperationOnAllMessages:function(_1a2,_1a3){this.allMessagesMailbox=_1a2;this.allMessagesSearch=_1a3;},clearOperationOnAllMessages:function(){this.allMessagesMailbox=null;this.allMessagesSearch=null;},getOperationOnAllMessages:function(){if(this.allMessagesMailbox!=null&&this.allMessagesSearch!=null){return "&allmailbox="+encodeURIComponent(this.allMessagesMailbox)+"&allsearch="+encodeURIComponent(this.allMessagesSearch);}else{return "";}},messageList:function(_1a4,_1a5,page,sort,_1a8,_1a9){if(_1a9==null){_1a9=false;}new Ajax("ajax.php",{postBody:"request=mailboxContentsList&mailbox="+encodeURIComponent(_1a4)+"&page="+page+"&search="+encodeURIComponent(_1a5)+"&sort="+encodeURIComponent(sort)+"&validity="+encodeURIComponent(_1a8)+"&cacheonly="+encodeURIComponent(_1a9),onComplete:this.messageListCB.bind(this),onFailure:if_remoteRequestFailed}).request();},messageListCB:function(_1aa){var _1ab=if_checkRemoteResult(_1aa);if(!_1ab){return null;}this.dataStore.fetchMessageListCB(_1ab,_1ab.data.mailbox,_1ab.data.search,_1ab.data.thispage,_1ab.data.sort,_1ab.validity,_1ab.cacheonly);},mailboxList:function(_1ac){new Ajax("ajax.php",{postBody:"request=getMailboxList&validity="+encodeURIComponent(_1ac),onComplete:this.mailboxListCB.bind(this),onFailure:if_remoteRequestFailed}).request();},mailboxListCB:function(_1ad){var _1ae=if_checkRemoteResult(_1ad);if(!_1ae){return null;}this.dataStore.fetchMailboxListCB(_1ae);},messageBody:function(_1af,uid,mode){new Ajax("ajax.php",{postBody:"request=getMessage&mailbox="+encodeURIComponent(_1af)+"&msg="+encodeURIComponent(uid)+"&mode="+encodeURIComponent(mode),onComplete:this.messageBodyCB.bind(this),onFailure:if_remoteRequestFailed}).request();},messageBodyCB:function(_1b2){var _1b3=if_checkRemoteResult(_1b2);if(!_1b3){return null;}this.dataStore.fetchMessageCB(_1b3,_1b3.data.mailbox,_1b3.data.uid);},fetchLargePart:function(_1b4,uid,part){var _1b7=new XHR({method:"get",async:false});var url="message.php?mailbox="+encodeURIComponent(_1b4)+"&uid="+encodeURIComponent(uid)+"&filename=part:"+encodeURIComponent(part);_1b7.send(url,null);return _1b7.response.text;},moveMessage:function(_1b9,_1ba,uid,_1bc){new Ajax("ajax.php",{postBody:"request=moveMessage&mailbox="+encodeURIComponent(_1b9)+"&destbox="+encodeURIComponent(_1ba)+"&uid="+encodeURIComponent(uid)+this.getOperationOnAllMessages(),onComplete:this.moveMessageCB.bind(this),onFailure:if_remoteRequestFailed}).request();},moveMessageCB:function(_1bd){var _1be=if_checkRemoteResult(_1bd);if(_1be){this.dataStore.moveMessageCB(_1be,false);}else{this.dataStore.moveMessageCB(_1be,true);}},deleteMessage:function(_1bf,uid){new Ajax("ajax.php",{postBody:"request=deleteMessage&mailbox="+encodeURIComponent(_1bf)+"&uid="+encodeURIComponent(uid)+this.getOperationOnAllMessages(),onComplete:this.deleteMessageCB.bind(this),onFailure:if_remoteRequestFailed}).request();},deleteMessageCB:function(_1c1){var _1c2=if_checkRemoteResult(_1c1);if(_1c2){this.dataStore.deleteMessageCB(_1c2,false);}else{this.dataStore.deleteMessageCB(_1c2,true);}},twiddleFlag:function(_1c3,uid,flag,_1c6){var _1c7="request=setFlag";_1c7+="&flag="+encodeURIComponent(flag);_1c7+="&mailbox="+encodeURIComponent(_1c3);_1c7+="&uid="+encodeURIComponent(uid);_1c7+=this.getOperationOnAllMessages();if(_1c6){_1c7+="&state="+_1c6;}new Ajax("ajax.php",{postBody:_1c7,onComplete:this.twiddleFlagCB.bind(this),onFailure:if_remoteRequestFailed}).request();},twiddleFlagCB:function(_1c8){var _1c9=if_checkRemoteResult(_1c8);if(_1c9){this.dataStore.twiddleFlagCB(_1c9,false);}else{this.dataStore.twiddleFlagCB(_1c9,true);}},addressBookList:function(_1ca,_1cb){var _1cc="request=addressBookList";if(_1ca){_1cc+="&searchin="+encodeURIComponent(_1ca);}if(_1cb){_1cc+="&searchterm="+encodeURIComponent(_1cb);}new Ajax("ajax.php",{postBody:_1cc,onComplete:this.addressBookListCB.bind(this),onFailure:if_remoteRequestFailed}).request();},addressBookListCB:function(_1cd){var _1ce=if_checkRemoteResult(_1cd);if(_1ce){this.dataStore.addressBookListCB(_1ce,false);}else{this.dataStore.addressBookListCB(_1ce,true);}},addressBookEdit:function(_1cf,name,_1d1,_1d2){var _1d3="request=addressBookEdit";_1d3+="&original="+encodeURIComponent(_1cf);_1d3+="&name="+encodeURIComponent(name);_1d3+="&email="+encodeURIComponent(_1d1);_1d3+="&notes="+encodeURIComponent(_1d2);new Ajax("ajax.php",{postBody:_1d3,onComplete:this.addressBookEditCB.bind(this),onFailure:if_remoteRequestFailed}).request();},addressBookEditCB:function(_1d4){var _1d5=if_checkRemoteResult(_1d4);if(_1d5){this.dataStore.addressBookEditCB(_1d5,false);}else{this.dataStore.addressBookEditCB(_1d5,true);}},addressBookDelete:function(_1d6){var _1d7="request=addressBookDelete";_1d7+="&email="+encodeURIComponent(_1d6);new Ajax("ajax.php",{postBody:_1d7,onComplete:this.addressBookDeleteCB.bind(this),onFailure:if_remoteRequestFailed}).request();},addressBookDeleteCB:function(_1d8){var _1d9=if_checkRemoteResult(_1d8);if(_1d9){this.dataStore.addressBookDeleteCB(_1d9,false);}else{this.dataStore.addressBookDeleteCB(_1d9,true);}}});var OptionsEditorClass=new Class({initialize:function(_1da){this.wrapper=_1da;this.identityCache=null;},getWindowTitle:function(){return _("Lichen - Settings");},showEditor:function(_1db){if_remoteRequestStart();Lichen.busy();new Ajax("ajax.php",{postBody:"request=settingsPanel&tab="+encodeURIComponent(_1db),onComplete:this.showEditorCBStub.bind(this),onFailure:if_remoteRequestFailed}).request();},showEditorCBStub:function(_1dc){Lichen.action("options","OptionsEditor","showEditorCB",[_1dc]);Lichen.notbusy();},showEditorCB:function(_1dd){var _1de=if_checkRemoteResult(_1dd);if(!_1de){return;}$(this.wrapper).setHTML(_1de.htmlFragment);if(_1de.mailboxes){Lichen.MailboxManager.mailboxCache=_1de.mailboxes;}if(_1de.identities){this.identityCache=_1de.identities;}},closePanel:function(){Lichen.MailboxList.listUpdate();Lichen.action("list","MessageList","listUpdate");},generateQueryString:function(_1df){var _1e0=$A($(_1df).getElementsByTagName("input"));_1e0.extend($A($(_1df).getElementsByTagName("select")));var _1e1=new Array();for(var i=0;i<_1e0.length;i++){var _1e3="";switch(_1e0[i].type){case "checkbox":if(_1e0[i].checked){_1e3="true";}else{_1e3="false";}break;default:_1e3=_1e0[i].value;break;}_1e1.push(_1e0[i].id+"="+encodeURIComponent(_1e3));}return _1e1.join("&");},saveOptions:function(){if_remoteRequestStart();Lichen.busy();new Ajax("ajax.php",{postBody:"request=settingsPanelSave&"+this.generateQueryString("opts-settings"),onComplete:this.saveOptionsCB.bind(this),onFailure:if_remoteRequestFailed}).request();},saveOptionsCB:function(_1e4){Lichen.notbusy();var _1e5=if_checkRemoteResult(_1e4);if(!_1e5){return;}if(_1e5.errors&&_1e5.errors.length>0){alert(_("There were some errors saving your settings.\nAny valid settings were saved.\n\n")+_1e5.errors.join("\n"));}else{this.closePanel();}opts_getCB(_1e5);},identity_findInCache:function(_1e6){for(var i=0;i<this.identityCache.length;i++){if(_1e6==this.identityCache[i].address){return this.identityCache[i];}}return null;},identity_add:function(){$("opts-identity-name").value="";$("opts-identity-address").value="";$("opts-identity-sig").value="";if(!$("opts-identity-new")){var _1e8=new Element("option",{"id":"opts-identity-new"});_1e8.appendText("new identity");$("opts-identity-list").adopt(_1e8);$("opts-identity-list").value="new identity";}$("opts-identity-save").onclick=Lichen.OptionsEditor.identity_add_done.bind(this);return false;},identity_add_done:function(){var _1e9=$("opts-identity-name").value;var _1ea=$("opts-identity-address").value;var _1eb=$("opts-identity-sig").value;if(_1e9==""||_1ea==""){Lichen.Flash.flashMessage(_("Can't add an identity with a blank name or blank e-mail."));return false;}new Ajax("ajax.php",{postBody:"request=identityEditor&action=add&idname="+encodeURIComponent(_1e9)+"&idemail="+encodeURIComponent(_1ea)+"&idsig="+encodeURIComponent(_1eb),onComplete:this.identity_actionCB.bind(this),onFailure:if_remoteRequestFailed}).request();return false;},identity_edit:function(){if($("opts-identity-new")){$("opts-identity-new").remove();}var _1ec=$("opts-identity-list");if(_1ec.value==""){return false;}var _1ed=this.identity_findInCache(_1ec.value);$("opts-identity-name").value=_1ed.name;$("opts-identity-address").value=_1ed.address;$("opts-identity-sig").value=_1ed.signature;$("opts-identity-save").onclick=function(){return Lichen.OptionsEditor.identity_edit_done(_1ed.address);};return false;},identity_edit_done:function(_1ee){var _1ef=$("opts-identity-name").value;var _1f0=$("opts-identity-address").value;var _1f1=$("opts-identity-sig").value;if(_1ef==""||_1f0==""){Lichen.Flash.flashMessage(_("Can't edit an identity to have a blank name or blank e-mail."));return false;}new Ajax("ajax.php",{postBody:"request=identityEditor&action=edit&idname="+encodeURIComponent(_1ef)+"&idemail="+encodeURIComponent(_1f0)+"&oldid="+encodeURIComponent(_1ee)+"&idsig="+encodeURIComponent(_1f1),onComplete:this.identity_actionCB.bind(this),onFailure:if_remoteRequestFailed}).request();return false;},identity_setdefault:function(){var _1f2=$("opts-identity-list");if(_1f2.value==""){return false;}new Ajax("ajax.php",{postBody:"request=identityEditor&action=setdefault&oldid="+encodeURIComponent(_1f2.value),onComplete:this.identity_actionCB.bind(this),onFailure:if_remoteRequestFailed}).request();return false;},identity_remove:function(){var _1f3=$("opts-identity-list");if(_1f3.value==""){return false;}new Ajax("ajax.php",{postBody:"request=identityEditor&action=delete&oldid="+encodeURIComponent(_1f3.value),onComplete:this.identity_actionCB.bind(this),onFailure:if_remoteRequestFailed}).request();return false;},identity_actionCB:function(_1f4){var _1f5=if_checkRemoteResult(_1f4);if(!_1f5){return;}Lichen.action("options","OptionsEditor","showEditor",["identities"]);}});function opts_get(){new Ajax("ajax.php",{postBody:"request=getUserSettings",onComplete:opts_getCB,onFailure:if_remoteRequestFailed}).request();}function opts_getCB(_1f6){var _1f7=if_checkRemoteResult(_1f6);if(!_1f7){return;}userSettings=_1f7.settings;}