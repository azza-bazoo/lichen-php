window.onload=if_init;var activeFadeEffect=false;var userSettings;var Lichen;function if_init(){Lichen.onLoadInit();}function _(_1){return _1;}var FlashArea=new Class({initialize:function(_2){this.wrapper=_2;this.messages=new Array();this.timeouts=new Array();this.onscreen=false;},flashMessage:function(_3,_4){if(_4){this.messages.push(_3+"<div class=\"detail\">"+_4+"</div>");}else{this.messages.push(_3);}this.renderFlash();if(!this.onscreen){$(this.wrapper).setStyle("display","block");this.onscreen=true;}this.timeouts.push(window.setTimeout(this.clearFlash.bind(this),7500));},renderFlash:function(){var _5=this.messages.join("<br />");$(this.wrapper).setHTML(_5);},clearFlash:function(){this.messages.shift();this.timeouts.shift();if(this.messages.length==0){$(this.wrapper).setStyle("display","none");this.onscreen=false;}else{this.renderFlash();}},hideFlash:function(){this.messages=new Array();for(var i=0;i<this.timeouts.length;i++){window.clearTimeout(this.timeouts[i]);}this.timeouts=new Array();this.renderFlash();this.onscreen=false;$(this.wrapper).setStyle("display","none");}});var PaneTransition=new Class({initialize:function(_7){this.fadeOut=new Fx.Style(_7,"opacity",{duration:1500});this.elementID=_7;this.fadeOut.start(0.9,0);},end:function(){this.fadeOut.stop();$(this.elementID).style.display="none";$(this.elementID).setStyle("opacity",1);}});function if_remoteRequestStart(){}function if_remoteRequestEnd(){}function if_checkRemoteResult(_8){var _9="";if($type(_8)!="string"){return _8;}_9=Json.evaluate(_8,true);if(!_9){alert(_("Unable to Json decode what the server sent back.\n The server sent us:")+" '"+_8+"'\n");if_remoteRequestEnd();return null;}if_remoteRequestEnd();if(_9.resultCode!="OK"){if(_9.resultCode=="AUTH"){if($("relogin_pass")==null){var _a=$("opts-wrapper");var _b="";_b+="<h3>"+_("You were logged out.")+"</h3>";_b+="<p>"+_("The server said:")+" "+_9.errorMessage+"</p>";_b+="<p>"+_("Enter your password to login again:")+"</p>";_b+="<input type=\"password\" name=\"relogin_pass\" id=\"relogin_pass\" />";_b+="<button onclick=\"if_relogin(); return false\">"+_("Login")+"</button>";_a.setHTML(_b);_a.setStyle("display","block");$("relogin_pass").focus();}}else{if(_9.imapNotices!=""){Lichen.Flash.flashMessage(_9.errorMessage,_("IMAP messages: ")+_9.imapNotices);}else{Lichen.Flash.flashMessage(_9.errorMessage,"");}return null;}}else{return _9;}}function if_remoteRequestFailed(_c){if_remoteRequestEnd();Lichen.Flash.flashMessage(_c);Lichen.Messages.getCallback(true);}function if_relogin(){var _d=$("relogin_pass").value;new Ajax("index.php",{postBody:"action=relogin&user="+encodeURIComponent(serverUser)+"&pass="+encodeURIComponent(_d),onComplete:if_reloginCB,onFailure:if_remoteRequestFailed}).request();}function if_reloginCB(_e){var _f=if_checkRemoteResult(_e);if(!_f){return;}if(_f.error){Lichen.Flash.flashMessage(_f.error);}else{$("opts-wrapper").setStyle("display","none");$("opts-wrapper").empty();}}function if_logoutSilent(){new Ajax("index.php",{postBody:"logout=0&silent=0",onComplete:if_logoutSilentCB,onFailure:if_remoteRequestFailed}).request();}function if_logoutSilentCB(_10){var _11=if_checkRemoteResult(_10);if(!_11){return;}Lichen.Flash.flashMessage(_("Silently logged out."));}function if_newWin(_12){var nw=window.open(_12);return !nw;}var MailboxManagerClass=new Class({initialize:function(_14){this.mailboxCache=null;this.dataStore=_14;},renameInline:function(_15,_16){if($("mbm-namearea-"+_15)){var _17="<input id=\"mbm-rename-"+_15+"\" type=\"text\" size=\"20\" value=\""+_16+"\" />";_17+="<button onclick=\"Lichen.MailboxManager.renameDone('"+_15+"', '"+_16+"');return false\">"+_("save")+"</button> <button onclick=\"Lichen.MailboxManager.renameCancel('"+_15+"');return false\">"+_("cancel")+"</button> ";$("mbm-namearea-"+_15).setHTML(_17);var _18=$("mbm-rename-"+_15);if(_18){_18.focus();}}},renameDone:function(_19,_1a){var _1b=$("mbm-rename-"+_19);if(_1b){var _1c=_1b.value;if(_1c&&_1c!=""){if(_1c==_1a){this.serverActionCB({action:"rename",mailbox1:_19,mailbox2:_19});}else{_1c=_19.substr(0,_19.length-_1a.length)+_1c;new Ajax("ajax.php",{postBody:"request=mailboxAction&action=rename&mailbox1="+encodeURIComponent(_19)+"&mailbox2="+encodeURIComponent(_1c),onComplete:this.serverActionCB.bind(this),onFailure:if_remoteRequestFailed}).request();}}}},renameCancel:function(_1d){var _1e=$("mbm-rename-"+_1d);if(_1e){this.serverActionCB({action:"rename",mailbox1:_1d,mailbox2:_1d});}},mailboxDelete:function(_1f,_20){if(confirm(_("Are you sure you want to delete '")+_20+_("'?\nAll messages in this mailbox will be deleted.\nThis cannot be undone."))){new Ajax("ajax.php",{postBody:"request=mailboxAction&action=delete&mailbox1="+encodeURIComponent(_1f),onComplete:this.serverActionCB.bind(this),onFailure:if_remoteRequestFailed}).request();}},newChild:function(_21){var _22=$("mbm-changearea-"+_21);if(_22){var _23="<div id=\"mbm-newchild-wrapper-"+_21+"\">";_23+=_("New Subfolder:")+" <input id=\"mbm-newchild-"+_21+"\" type=\"text\" size=\"20\" />";_23+="<button onclick=\"Lichen.MailboxManager.newChildSubmit('"+_21+"'); return false\">"+_("Add")+"</button>";_23+="<button onclick=\"Lichen.MailboxManager.newChildCancel('"+_21+"'); return false\">"+_("Cancel")+"</button>";_23+="</div>";_22.setHTML(_23);var _24=$("mbm-newchild-"+_21);if(_24){_24.focus();}}},newChildSubmit:function(_25){var _26=$("mbm-newchild-"+_25);if(_26&&_26.value!=""){new Ajax("ajax.php",{postBody:"request=mailboxAction&action=create&mailbox1="+encodeURIComponent(_25)+"&mailbox2="+encodeURIComponent(_26.value),onComplete:this.serverActionCB.bind(this),onFailure:if_remoteRequestFailed}).request();}},newChildCancel:function(_27){var _28=$("mbm-newchild-wrapper-"+_27);if(_28){_28.remove();}},changeParentInline:function(_29,_2a){var _2b=$("mbm-changearea-"+_29);if(_2b){var _2c="<div id=\"mbm-changeparent-wrapper-"+_29+"\">";_2c+=_("Move to subfolder of: ");_2c+="<select id=\"mbm-changeparent-"+_29+"\">";_2c+="<option value=\"\">"+_("[Top Level]")+"</option>";for(var i=0;i<this.mailboxCache.length;i++){var _2e=this.mailboxCache[i];_2c+="<option value=\""+_2e.fullboxname+"\"";if(_2a==_2e.mailbox){_2c+=" selected=\"selected\">";}else{_2c+=">";}for(var j=0;j<_2e.folderdepth;j++){_2c+="-";}_2c+=_2e.mailbox+"</option>";}_2c+="</select>";_2c+="<button onclick=\"Lichen.MailboxManager.changeParentSubmit('"+_29+"', '"+_2a+"'); return false\">"+_("Move")+"</button>";_2c+="<button onclick=\"Lichen.MailboxManager.changeParentCancel('"+_29+"', '"+_2a+"'); return false\">"+_("Cancel")+"</button>";_2c+="</div>";_2b.setHTML(_2c);}},changeParentSubmit:function(_30,_31){var _32=$("mbm-changeparent-"+_30);if(_32&&_32.value!=_31){new Ajax("ajax.php",{postBody:"request=mailboxAction&action=move&mailbox1="+encodeURIComponent(_30)+"&mailbox2="+encodeURIComponent(_32.value),onComplete:this.serverActionCB.bind(this),onFailure:if_remoteRequestFailed}).request();}},changeParentCancel:function(_33,_34){var _35=$("mbm-changeparent-wrapper-"+_33);if(_35){_35.remove();}},serverActionCB:function(_36){var _37=if_checkRemoteResult(_36);if(!_37){return;}Lichen.action("options","OptionsEditor","showEditor",["mailboxes"]);if(_37.mailboxes){this.mailboxCache=_37.mailboxes;}}});var MailboxLister=new Class({initialize:function(_38){this.wrapper=_38;this.mailboxCount=0;this.lastUIDconst=-1;this.mailboxCount=-1;this.msgCount=-1;this.openMailboxes=new Array();this.listCache=null;},isMailboxOpen:function(_39){for(var i=0;i<this.openMailboxes.length;i++){if(this.openMailboxes[i]==_39){return i;}}return -1;},listUpdate:function(){Lichen.Messages.fetchMailboxList();},listUpdateCB:function(_3b){var _3c=_3b;this.listCache=_3b;if(this.mailboxCount!=_3c.length){this._render(_3c);this.mailboxCount=_3c.length;}var i=0;for(i=0;i<_3c.length;i++){if(Lichen.MessageList.getMailbox()==_3c[i].fullboxname){if(this.lastUIDconst!=-1&&this.lastUIDconst!=_3c[i].uidConst){Lichen.action("list","MessageList","listUpdate");}else{if(this.msgCount!=-1&&this.msgCount!=_3c[i].messages){Lichen.action("list","MessageList","listUpdate");}}this.lastUIDconst=_3c[i].uidConst;this.msgCount=_3c[i].messages;$("mb-"+Lichen.MessageList.getMailbox()).addClass("mb-active");}var _3e="";if(_3c[i].unseen>0||userSettings.boxlist_showtotal){_3e="("+_3c[i].unseen;if(userSettings.boxlist_showtotal){_3e+="/"+_3c[i].messages;}_3e+=")";}if($("mb-unread-"+_3c[i].fullboxname)){$("mb-unread-"+_3c[i].fullboxname).setHTML(_3e);}else{this._render(_3c);return;}}this.mailboxCount=_3b.length;},_render:function(_3f){$(this.wrapper).empty();var _40="<li id=\"mb-header\"><span class=\"s-head\">"+_("Mailboxes")+"</span> [<a href=\"#manage-mailboxes\" onclick=\"return Lichen.action('options','OptionsEditor','showEditor',['mailboxes'])\">"+_("edit")+"</a>]</li>";var _41=new Array();for(var i=0;i<_3f.length;i++){if(_41.length>0){var _43=_41[_41.length-1];if(_3f[i].fullboxname.substr(0,_43.length)==_43){continue;}else{_41.pop();}}_40+="<li id=\"mb-"+_3f[i].fullboxname;if(Lichen.MessageList.getMailbox()==_3f[i].fullboxname){_40+="\" class=\"mb-active";}_40+="\">";if(_3f[i].haschildren){_40+=" <a href=\"#\" style=\"float:right;\" onclick=\"return Lichen.MailboxList.viewToggle('"+_3f[i].fullboxname+"');\">";if(this.isMailboxOpen(_3f[i].fullboxname)!=-1){_40+="<img width=\"8\" height=\"8\" src=\"themes/"+userSettings.theme+"/icons/folder_contract.png\" alt=\""+_("[contract]")+"\" />";}else{_41.push(_3f[i].fullboxname+_3f[i].delimiter);_40+="<img width=\"8\" height=\"8\" src=\"themes/"+userSettings.theme+"/icons/folder_expand.png\" alt=\""+_("[expand]")+"\" />";}_40+="</a>";}if(_3f[i].selectable){_40+="<a href=\"#\" onclick=\"return Lichen.action('list', 'MailboxList', 'selectMailbox', ['"+_3f[i].fullboxname+"'])\" class=\"mb-click\">";}else{_40+="<div class=\"mb-noclick\">";}for(var j=0;j<_3f[i].folderdepth;j++){_40+="&nbsp;&nbsp;";}_40+="<span class=\"mailbox\">"+_3f[i].mailbox;_40+=" <span id=\"mb-unread-"+_3f[i].fullboxname+"\">";if(_3f[i].unseen>0||userSettings.boxlist_showtotal){_40+="("+_3f[i].unseen;if(userSettings.boxlist_showtotal){_40+="/"+_3f[i].messages;}_40+=")";}_40+="</span>";_40+="</span>";if(_3f[i].selectable){_40+="</a>";}else{_40+="</div>";}_40+="</li>";}$(this.wrapper).setHTML(_40);},selectMailbox:function(_45){this.lastUIDconst="";this.msgCount=0;var _46=$("mb-"+Lichen.MessageList.getMailbox());if(_46){_46.removeClass("mb-active");}Lichen.action("list","MessageList","setMailbox",[_45]);$("mb-"+Lichen.MessageList.getMailbox()).addClass("mb-active");return false;},viewToggle:function(_47){var _48=this.isMailboxOpen(_47);if(_48==-1){this.openMailboxes.push(_47);this._render(this.listCache);}else{this.openMailboxes.splice(_48,1);this._render(this.listCache);}return false;}});var MessagesDatastore=new Class({initialize:function(_49){this.online=_49;this.server=new IMAPServerConnector(this);this.cache=new HashCacheConnector(this,serverUser);this.callbacks=new Array();this.allMessagesMailbox=null;this.allMessagesSearch=null;},addCallback:function(_4a){this.callbacks.push(_4a);},getCallback:function(_4b){var _4c=this.callbacks.shift();if(_4b){_4c=null;}return _4c;},fetchMessageList:function(_4d,_4e,_4f,_50){var _51=this.cache.getMessageListValidity(_4d,_4e,_4f,_50);var _52=this.cache.getMessageList(_4d,_4e,_4f,_50,_51);if(_52){Lichen.action("list","MessageList","listUpdateCB",[_52]);}if(this.online){this.server.messageList(_4d,_4e,_4f,_50,_51);}if(!this.online&&!_52){Lichen.Flash.flashMessage(_("Not online, and that data is not cached."));}},fetchMessageListCB:function(_53,_54,_55,_56,_57,_58,_59){if(_56==-1){return;}var _5a=this.cache.getMessageList(_54,_55,_56,_57,_58);if(_5a==null){var _5a=this.cache.storeMessageList(_54,_55,_56,_57,_53.data,_53.validityKey);if(_59!="true"&&Lichen.getMode()=="list"){Lichen.action("list","MessageList","listUpdateCB",[_5a]);}if(this.online&&_59!="true"){if(_56!=0&&!this.cache.haveCachedMessageList(_54,_55,_56-1,_57)){this.server.messageList(_54,_55,_56-1,_57,this.cache.getMessageListValidity(_54,_55,_56-1,_57),true);}if(_5a.numberpages>(_56+1)&&!this.cache.haveCachedMessageList(_54,_55,_56+1,_57)){this.server.messageList(_54,_55,_56+1,_57,this.cache.getMessageListValidity(_54,_55,_56+1,_57),true);}}}},fetchAdjacentMessages:function(_5b,_5c,_5d,_5e,uid){var _60=-1;var _61=-1;var _62=-1;var _63=null;var _64=null;var _65=new Array();_65.push(this.cache.getMessageList(_5b,_5c,_5d,_5e,this.cache.getMessageListValidity(_5b,_5c,_5d,_5e)));_65.push(this.cache.getMessageList(_5b,_5c,_5d+1,_5e,this.cache.getMessageListValidity(_5b,_5c,_5d+1,_5e)));_65.push(this.cache.getMessageList(_5b,_5c,_5d-1,_5e,this.cache.getMessageListValidity(_5b,_5c,_5d-1,_5e)));for(var j=0;j<_65.length;j++){if(_65[j]==null){continue;}for(var i=0;i<_65[j].messages.length;i++){if(_65[j].messages[i].uid==uid){_60=i;_61=_65[j].thispage.toInt();_62=j;break;}}if(_60!=-1){break;}}if(_61!=_5d){return this.fetchAdjacentMessages(_5b,_5c,_61,_5e,uid);}if(_60!=-1&&_61!=-1){if(_60>0){_63=_65[_62].messages[_60-1];}if(_60==0){if(_65[2]!=null){_63=_65[2].messages[_65[2].messages.length-1];}}if(_60<(_65[_62].messages.length-1)){_64=_65[_62].messages[_60+1];}if(_60==(_65[_62].messages.length-1)){if(_65[1]!=null){_64=_65[1].messages[0];}}}if(_61!=-1&&_61!=Lichen.MessageList.getPage()){Lichen.MessageList.setPage(_61,true);if(this.online){if(_61!=0){var _68=this.cache.getMessageListValidity(_5b,_5c,_61-1,_5e);if(!this.cache.getMessageList(_5b,_5c,_61-1,_5e,_68)){this.server.messageList(_5b,_5c,_61-1,_5e,_68,true);}}var _68=this.cache.getMessageListValidity(_5b,_5c,_61+1,_5e);if(!this.cache.getMessageList(_5b,_5c,_61+1,_5e,_68)){this.server.messageList(_5b,_5c,_61+1,_5e,_68,true);}}}var _69={};_69.previous=_63;_69.next=_64;return _69;},fetchMailboxList:function(_6a){var _6b=this.cache.getMailboxListValidity();var _6c=this.cache.getMailboxList(_6b);if(_6a){return _6c;}if(this.online){this.server.mailboxList(_6b);}else{if(_6c){Lichen.MailboxList.listUpdateCB(_6c);}else{Lichen.Flash.flashMessage(_("Unable to fetch mailbox list: not online and not cached."));}}},fetchMailboxListCB:function(_6d){var _6e=this.cache.storeMailboxList(_6d.data,_6d.validity);Lichen.MailboxList.listUpdateCB(_6e);},fetchMailboxStatus:function(_6f){var _70=this.cache.getMailboxListValidity();var _71=this.cache.getMailboxList(_70);var _72=null;if(_71){for(var i=0;i<_71.length;i++){if(_71[i].fullboxname==_6f){_72=_71[i];}}}else{}return _72;},fetchMessage:function(_74,uid,_76){var _77=this.cache.getMessage(_74,uid,_76,true);if(_77){Lichen.action("display","MessageDisplayer","showMessageCB",[_77]);}else{if(this.online){this.server.messageBody(_74,uid,_76);}else{Lichen.Flash.flashMessage(_("Unable to view message: in offline mode, and not cached."));}}},fetchMessageCB:function(_78,_79,uid){var _7b=this.cache.storeMessage(_79,uid,_78.data);Lichen.action("display","MessageDisplayer","showMessageCB",[_78.data]);},fetchLargePart:function(_7c,uid,_7e,_7f){if(this.online){var _80=this.server.fetchLargePart(_7c,uid,_7e);_80="<pre>"+_80+"</pre>";this.cache.storeLargePart(_7c,uid,_7f,_80);return _80;}else{return _("Not online - unable to fetch that part of the message.");}},nextOperationOnAllMessages:function(_81,_82){this.allMessagesMailbox=_81;this.allMessagesSearch=_82;if(this.online){this.server.nextOperationOnAllMessages(_81,_82);}else{}},clearOperationOnAllMessages:function(){if(this.online){this.server.clearOperationOnAllMessages();}this.allMessagesMailbox=null;this.allMessagesSearch=null;},moveMessage:function(_83,_84,uid,_86){this.addCallback(_86);this.server.moveMessage(_83,_84,uid);},moveMessageCB:function(_87,_88){this.genericServerCallback(_87,_88);},deleteMessage:function(_89,uid,_8b){this.addCallback(_8b);this.server.deleteMessage(_89,uid);},deleteMessageCB:function(_8c,_8d){this.genericServerCallback(_8c,_8d);},twiddleFlag:function(_8e,uid,_90,_91,_92){this.addCallback(_92);this.server.twiddleFlag(_8e,uid,_90,_91);},twiddleFlagCB:function(_93,_94){if(!_94){this.cache.updateFlagStatus(Lichen.MessageList.getMailbox(),Lichen.MessageList.getSearch(),Lichen.MessageList.getPage(),Lichen.MessageList.getSortStr(),_93.uid,_93.flag,_93.state);}this.genericServerCallback(_93,_94);},addressBookList:function(_95,_96,_97){this.addCallback(_97);this.server.addressBookList(_95,_96);},addressBookListCB:function(_98,_99){if(!_99){}this.genericServerCallback(_98,_99);},addressBookEdit:function(_9a,_9b,_9c,_9d,_9e){this.addCallback(_9e);this.server.addressBookEdit(_9a,_9b,_9c,_9d);},addressBookEditCB:function(_9f,_a0){this.genericServerCallback(_9f,_a0);},addressBookDelete:function(_a1,_a2){this.addCallback(_a2);this.server.addressBookDelete(_a1);},addressBookDeleteCB:function(_a3,_a4){this.genericServerCallback(_a3,_a4);},genericServerCallback:function(_a5,_a6){var _a7=this.getCallback(_a6);if(_a7){_a7(_a5);}}});var GoogleCacheConnector=new Class({initialize:function(_a8,_a9){}});var HashCacheConnector=new Class({initialize:function(_aa,_ab){this.messagelists={};this.messagelistsvalidity={};this.messages={};this.mailboxlist={};this.mailboxlistvalidity=null;this.dataStore=_aa;},storeMessageList:function(_ac,_ad,_ae,_af,_b0,_b1){var _b2=_ac+_ad+_ae+_af;if(_b1&&this.messagelistsvalidity[_b2]&&_b1==this.messagelistsvalidity[_b2]){return this.messagelists[_b2];}else{this.messagelists[_b2]=_b0;this.messagelistsvalidity[_b2]=_b1;return _b0;}},getMessageList:function(_b3,_b4,_b5,_b6,_b7){var _b8=_b3+_b4+_b5+_b6;if(this.messagelists[_b8]&&this.messagelistsvalidity[_b8]&&_b7&&this.messagelistsvalidity[_b8]==_b7){return this.messagelists[_b8];}else{return null;}},getMessageListValidity:function(_b9,_ba,_bb,_bc){var _bd=_b9+_ba+_bb+_bc;if(this.messagelistsvalidity[_bd]!=null){return this.messagelistsvalidity[_bd];}else{return null;}},haveCachedMessageList:function(_be,_bf,_c0,_c1){if(this.getMessageList(_be,_bf,_c0,_c1,this.getMessageListValidity(_be,_bf,_c0,_c1))){return true;}return false;},updateFlagStatus:function(_c2,_c3,_c4,_c5,uid,_c7,_c8){var _c9=_c2+_c3+_c4+_c5;var _ca=uid.toInt();if(this.messagelists[_c9]){for(var i=0;i<this.messagelists[_c9].messages.length;i++){if(this.messagelists[_c9].messages[i].uid==_ca){switch(_c7){case "flagged":this.messagelists[_c9].messages[i].flagged=_c8;break;case "seen":if(_c8){this.messagelists[_c9].messages[i].readStatus="R";}else{this.messagelists[_c9].messages[i].readStatus="U";}break;}}}}},storeMessage:function(_cc,uid,_ce,_cf){var _d0=_cc+uid;if(this.messages[_d0]){var _d1=this.messages[_d0];if(_d1.texthtmlpresent&&_d1.texthtml.length==0&&_ce.texthtml.length>0){_d1.texthtml=_ce.texthtml;}if(_d1.textplainpresent&&_d1.textplain.length==0&&_ce.textplain.length>0){_d1.textplain=_ce.textplain;}if(_d1.source==null&&_ce.source!=null){_d1.source=_ce.source;}}else{this.messages[_d0]=_ce;}return this.messages[_d0];},storeLargePart:function(_d2,uid,_d4,_d5){var _d6=_d2+uid;if(this.messages[_d6]){this.messages[_d6].textplain[_d4]=_d5;}},getMessage:function(_d7,uid,_d9,_da){var _db=_d7+uid;var _dc=null;if(this.messages[_db]&&_da){var _dd=false;var _de=this.messages[_db];switch(_d9){case "html":if(_de.texthtmlpresent&&_de.texthtml.length!=0){_dd=true;}break;case "text":if(_de.textplainpresent&&_de.textplain.length!=0){_dd=true;}break;case "source":if(_de.source){_dd=true;}break;case "all":break;default:_dd=true;break;}if(_dd){_dc=this.messages[_db];}}return _dc;},storeMailboxList:function(_df,_e0){if(_e0&&_e0==this.mailboxlistvalidity){return this.mailboxlist;}else{this.mailboxlist=_df;this.mailboxlistvalidity=_e0;return _df;}},getMailboxList:function(_e1){if(_e1&&_e1==this.mailboxlistvalidity){return this.mailboxlist;}else{return null;}},getMailboxListValidity:function(){return this.mailboxlistvalidity;}});var IMAPServerConnector=new Class({initialize:function(_e2){this.dataStore=_e2;this.allMessagesMailbox=null;this.allMessagesSearch=null;},nextOperationOnAllMessages:function(_e3,_e4){this.allMessagesMailbox=_e3;this.allMessagesSearch=_e4;},clearOperationOnAllMessages:function(){this.allMessagesMailbox=null;this.allMessagesSearch=null;},getOperationOnAllMessages:function(){if(this.allMessagesMailbox!=null&&this.allMessagesSearch!=null){return "&allmailbox="+encodeURIComponent(this.allMessagesMailbox)+"&allsearch="+encodeURIComponent(this.allMessagesSearch);}else{return "";}},messageList:function(_e5,_e6,_e7,_e8,_e9,_ea){if(_ea==null){_ea=false;}new Ajax("ajax.php",{postBody:"request=mailboxContentsList&mailbox="+encodeURIComponent(_e5)+"&page="+_e7+"&search="+encodeURIComponent(_e6)+"&sort="+encodeURIComponent(_e8)+"&validity="+encodeURIComponent(_e9)+"&cacheonly="+encodeURIComponent(_ea),onComplete:this.messageListCB.bind(this),onFailure:if_remoteRequestFailed}).request();},messageListCB:function(_eb){var _ec=if_checkRemoteResult(_eb);if(!_ec){return null;}this.dataStore.fetchMessageListCB(_ec,_ec.data.mailbox,_ec.data.search,_ec.data.thispage,_ec.data.sort,_ec.validity,_ec.cacheonly);},mailboxList:function(_ed){new Ajax("ajax.php",{postBody:"request=getMailboxList&validity="+encodeURIComponent(_ed),onComplete:this.mailboxListCB.bind(this),onFailure:if_remoteRequestFailed}).request();},mailboxListCB:function(_ee){var _ef=if_checkRemoteResult(_ee);if(!_ef){return null;}this.dataStore.fetchMailboxListCB(_ef);},messageBody:function(_f0,uid,_f2){new Ajax("ajax.php",{postBody:"request=getMessage&mailbox="+encodeURIComponent(_f0)+"&msg="+encodeURIComponent(uid)+"&mode="+encodeURIComponent(_f2),onComplete:this.messageBodyCB.bind(this),onFailure:if_remoteRequestFailed}).request();},messageBodyCB:function(_f3){var _f4=if_checkRemoteResult(_f3);if(!_f4){return null;}this.dataStore.fetchMessageCB(_f4,_f4.data.mailbox,_f4.data.uid);},fetchLargePart:function(_f5,uid,_f7){var _f8=new XHR({method:"get",async:false});var url="message.php?mailbox="+encodeURIComponent(_f5)+"&uid="+encodeURIComponent(uid)+"&filename=part:"+encodeURIComponent(_f7);_f8.send(url,null);return _f8.response.text;},moveMessage:function(_fa,_fb,uid,_fd){new Ajax("ajax.php",{postBody:"request=moveMessage&mailbox="+encodeURIComponent(_fa)+"&destbox="+encodeURIComponent(_fb)+"&uid="+encodeURIComponent(uid)+this.getOperationOnAllMessages(),onComplete:this.moveMessageCB.bind(this),onFailure:if_remoteRequestFailed}).request();},moveMessageCB:function(_fe){var _ff=if_checkRemoteResult(_fe);if(_ff){this.dataStore.moveMessageCB(_ff,false);}else{this.dataStore.moveMessageCB(_ff,true);}},deleteMessage:function(_100,uid){new Ajax("ajax.php",{postBody:"request=deleteMessage&mailbox="+encodeURIComponent(_100)+"&uid="+encodeURIComponent(uid)+this.getOperationOnAllMessages(),onComplete:this.deleteMessageCB.bind(this),onFailure:if_remoteRequestFailed}).request();},deleteMessageCB:function(_102){var _103=if_checkRemoteResult(_102);if(_103){this.dataStore.deleteMessageCB(_103,false);}else{this.dataStore.deleteMessageCB(_103,true);}},twiddleFlag:function(_104,uid,flag,_107){var _108="request=setFlag";_108+="&flag="+encodeURIComponent(flag);_108+="&mailbox="+encodeURIComponent(_104);_108+="&uid="+encodeURIComponent(uid);_108+=this.getOperationOnAllMessages();if(_107){_108+="&state="+_107;}new Ajax("ajax.php",{postBody:_108,onComplete:this.twiddleFlagCB.bind(this),onFailure:if_remoteRequestFailed}).request();},twiddleFlagCB:function(_109){var _10a=if_checkRemoteResult(_109);if(_10a){this.dataStore.twiddleFlagCB(_10a,false);}else{this.dataStore.twiddleFlagCB(_10a,true);}},addressBookList:function(_10b,_10c){var _10d="request=addressBookList";if(_10b){_10d+="&searchin="+encodeURIComponent(_10b);}if(_10c){_10d+="&searchterm="+encodeURIComponent(_10c);}new Ajax("ajax.php",{postBody:_10d,onComplete:this.addressBookListCB.bind(this),onFailure:if_remoteRequestFailed}).request();},addressBookListCB:function(_10e){var _10f=if_checkRemoteResult(_10e);if(_10f){this.dataStore.addressBookListCB(_10f,false);}else{this.dataStore.addressBookListCB(_10f,true);}},addressBookEdit:function(_110,name,_112,_113){var _114="request=addressBookEdit";_114+="&original="+encodeURIComponent(_110);_114+="&name="+encodeURIComponent(name);_114+="&email="+encodeURIComponent(_112);_114+="&notes="+encodeURIComponent(_113);new Ajax("ajax.php",{postBody:_114,onComplete:this.addressBookEditCB.bind(this),onFailure:if_remoteRequestFailed}).request();},addressBookEditCB:function(_115){var _116=if_checkRemoteResult(_115);if(_116){this.dataStore.addressBookEditCB(_116,false);}else{this.dataStore.addressBookEditCB(_116,true);}},addressBookDelete:function(_117){var _118="request=addressBookDelete";_118+="&email="+encodeURIComponent(_117);new Ajax("ajax.php",{postBody:_118,onComplete:this.addressBookDeleteCB.bind(this),onFailure:if_remoteRequestFailed}).request();},addressBookDeleteCB:function(_119){var _11a=if_checkRemoteResult(_119);if(_11a){this.dataStore.addressBookDeleteCB(_11a,false);}else{this.dataStore.addressBookDeleteCB(_11a,true);}}});var MessageLister=new Class({initialize:function(_11b,_11c){this.parseSort(userSettings.list_sortmode);this.mailbox=specialFolders.inbox;this.page=0;this.search="";this.wrapper=_11c;this.dataStore=_11b;this.numberPages=1;this.messagesOnThisPage=0;this.messagesInMailbox=0;this.unreadMessages=0;this.allSelectedStatus=0;},getWindowTitle:function(){var _11d=this.mailbox+" (";_11d+=this.unreadMessages+_(" unread, ");_11d+=this.messagesInMailbox+_(" total");_11d+=")";return _11d;},setSort:function(_11e,_11f){$("list-sort-"+this.sort).getParent().getElementsByTagName("img")[0].remove();if(_11e==this.sort){this.sortAsc=!this.sortAsc;}else{this.sort=_11e;this.sortAsc=true;}userSettings.list_sortmode=this.getSortStr();if(!_11f){this.listUpdate();}},getSortStr:function(){return this.sort+(this.sortAsc?"":"_r");},getSort:function(){return this.sort;},getSortAsc:function(){return this.sortAsc;},parseSort:function(_120){if(_120){if(_120.substr(_120.length-2,2)=="_r"){this.sort=_120.substr(0,_120.length-2);this.sortAsc=false;}else{this.sort=_120;this.sortAsc=true;}}else{this.sort="date";this.sortAsc=false;}},setSearch:function(_121,_122){if(this.search!=_121){this.search=_121;this.page=0;this.allSelectedStatus=0;if(!_122){this.listUpdate();}}if(_121==""){if($("qsearch")){$("qsearch").value="";}}return false;},getSearch:function(){return this.search;},setMailbox:function(_123,_124){if(this.mailbox!=_123){this.mailbox=_123;this.page=0;this.search="";this.allSelectedStatus=0;}if(!_124){this.listUpdate();}return false;},getMailbox:function(){return this.mailbox;},setPage:function(_125,_126){if(this.page!=_125){if(_125>=0&&_125<=(this.numberPages-1)){if(this.allSelectedStatus!=2){this.allSelectedStatus=0;}this.page=_125;if(!_126){this.listUpdate();}}}return false;},nextPage:function(){return this.setPage(this.page+1);},previousPage:function(){return this.setPage(this.page-1);},firstPage:function(){return this.setPage(0);},lastPage:function(){return this.setPage(this.numberPages);},listUpdate:function(){Lichen.busy();this.dataStore.fetchMessageList(this.mailbox,this.search,this.page,this.getSortStr());},getPage:function(){return this.page;},listUpdateCB:function(_127){Lichen.notbusy();if(_127.mailbox!=this.mailbox||_127.search!=this.search||_127.sort!=this.getSortStr()||_127.thispage!=this.page){return;}if(_127.thispage>=_127.numberpages||_127.thispage==-1){this.setPage(_127.numberpages-1);return;}this.numberPages=_127.numberpages;if(_127.unreadmessages!=null){this.unreadMessages=_127.unreadmessages;}this._render(_127.messages,_127);this.dataStore.fetchMailboxList();},_render:function(_128,_129){var _12a=this.getSelectedMessages();$(this.wrapper).empty();var _12b="";_12b+=this._createPageBar(_129,true);if(this.search!=""){_12b+="<div class=\"list-notification\"><strong>"+_("Found ")+_129.numbermessages+_(" results for")+" &#8220;"+this.search+"&#8221;</strong> "+"[<a href=\"#clearsearch\" onclick=\"return Lichen.action('list','MessageList','setSearch',[''])\">"+_("clear search")+"</a>]</div>";this.messagesInMailbox=_129.numbermessages;}else{this.messagesInMailbox=_129.mailboxmessages;}this.messagesOnThisPage=_128.length;var _12c=this.allSelectedDisplay(true);_12b+="<div class=\"list-notification\" id=\"select-all-notification\" ";if(_12c==""){_12b+="style=\"display: none\">";}else{_12b+=">"+_12c;}_12b+="</div>";_12b+="<table id=\"list-data-tbl\" class=\"messagelist\">";var _12d=window.getWidth()-515;if(userSettings.list_showsize){_12d=window.getWidth()-590;}_12b+="<colgroup><col class=\"mcol-checkbox\" /><col class=\"mcol-flag\" /><col class=\"mcol-sender\" /><col class=\"mcol-subject\" style=\"width:"+_12d+"px\" />";if(userSettings.list_showsize){_12b+="<col class=\"mcol-size\" />";}_12b+="<col class=\"mcol-date\" /></colgroup>";_12b+="<thead><tr class=\"list-sortrow\">";_12b+="<th><input type=\"checkbox\" id=\"list-check-main\" value=\"0\" onclick=\"Lichen.MessageList.selectMessages(0)\" /></th><th></th>";_12b+="<th class=\"list-sortlabel\"><a href=\"#sort-from\" id=\"list-sort-from\" onclick=\"Lichen.MessageList.setSort('from');return false\">"+_("sender")+"</a></th>";_12b+="<th class=\"list-sortlabel\"><a href=\"#sort-subject\" id=\"list-sort-subject\" onclick=\"Lichen.MessageList.setSort('subject');return false\">"+_("subject")+"</a></th>";if(userSettings.list_showsize){_12b+="<th class=\"list-sortlabel\"><a href=\"#sort-size\" id=\"list-sort-size\" onclick=\"Lichen.MessageList.setSort('size');return false\">"+_("size")+"</a></th>";}_12b+="<th class=\"list-sortlabel\"><a href=\"#sort-date\" id=\"list-sort-date\" onclick=\"Lichen.MessageList.setSort('date');return false\">"+_("date")+"</a></th>";_12b+="</tr></thead><tbody>";if(_128.length==0){_12b+="<tr><td colspan=\"5\" class=\"list-nothing\">"+_("No messages in this mailbox.")+"</td></tr>";}for(var i=0;i<_128.length;i++){var _12f=_128[i];var uid=_12f.uid;var _131="<tr id=\"mr-"+_12f.uid+"\" class=\"";if(i%2==1){_131+="odd";}else{_131+="even";}if(_12f.readStatus=="U"){_131+=" new";}if(this.allSelectedStatus==2){_131+=" active";}_131+="\">";_131+="<td><input type=\"checkbox\" class=\"msg-select\" name=\"s-"+_12f.uid+"\" id=\"s-"+_12f.uid+"\" value=\""+_12f.uid+"\" onclick=\"Lichen.MessageList.messageCheckboxClicked(this);\" /></td>";var _132=_12f.flagged?"/icons/flag.png":"/icons/flag_off.png";_131+="<td><img src=\"themes/"+userSettings.theme+_132+"\" id=\"f-"+_12f.uid+"\" alt=\"\" onclick=\"Lichen.MessageList.twiddleFlag('"+_12f.uid+"', 'flagged', 'toggle')\" title=\"Flag this message\" class=\"list-flag\" /></td>";_131+="<td class=\"sender\" onclick=\"Lichen.action('display','MessageDisplayer','showMessage',['"+this.mailbox+"','"+_12f.uid+"'])\"";if(_12f.fromName==""){if(_12f.fromAddr.length>22){_131+=" title=\""+_12f.fromAddr+"\"";}_131+="><div class=\"sender\">"+_12f.fromAddr;}else{_131+=" title=\""+_12f.fromAddr+"\"><div class=\"sender\">"+_12f.fromName;}_131+="</div></td>";_131+="<td class=\"subject\" onclick=\"Lichen.action('display','MessageDisplayer','showMessage',['"+this.mailbox+"','"+_12f.uid+"'])\"><div class=\"subject\">"+_12f.subject;if(userSettings.list_showpreviews){_131+="<span class=\"messagePreview\">"+_12f.preview+"</span>";}_131+="</div></td>";if(userSettings.list_showsize){_131+="<td class=\"size\"><div class=\"size\">"+_12f.size+"</div></td>";}_131+="<td class=\"date\"><div class=\"date\">"+_12f.dateString+"</div></td>";_131+="</tr>";_12b+=_131;}_12b+="</tbody></table>";_12b+=this._createPageBar(_129,false);$(this.wrapper).setHTML(_12b);var _133=null;if(!this.sortAsc){_133=new Element("img",{"class":"list-sort-marker","src":"themes/"+userSettings.theme+"/icons/sort_decrease.png"});}else{_133=new Element("img",{"class":"list-sort-marker","src":"themes/"+userSettings.theme+"/icons/sort_incr.png"});}$("list-sort-"+this.sort).getParent().adopt(_133);if(this.allSelectedStatus==2){this.selectMessages(7);}else{for(var i=0;i<_12a.length;i++){var _134=$("s-"+_12a[i]);if(_134){_134.checked=true;}}}},_createPageBar:function(_135,_136){var _137="";if(_136){_137+="<div class=\"list-header-bar\"><img src=\"themes/"+userSettings.theme+"/top-corner.png\" alt=\"\" class=\"top-corner\" />";}else{_137+="<div class=\"list-footer-bar\"><img src=\"themes/"+userSettings.theme+"/bottom-corner.png\" alt=\"\" class=\"bottom-corner\" />";}var _138=_135.thispage+1;var _139=_135.numberpages;var _13a=_138*_135.pagesize;if(_13a>_135.numbermessages){_13a=_135.numbermessages;}_137+="<div class=\"header-left\">";_137+="<select onchange=\"Lichen.MessageList.withSelected(this)\">";_137+="<option value=\"noop\" selected=\"selected\">"+_("move selected to ...")+"</option>";if(!window.ie){mailboxes=this.dataStore.fetchMailboxList(true);}if(mailboxes){for(var i=0;i<mailboxes.length;i++){_137+="<option value=\"move-"+mailboxes[i].fullboxname+"\">";for(var j=0;j<mailboxes[i].folderdepth;j++){_137+="-";}_137+=mailboxes[i].mailbox;_137+="</option>";}}_137+="</select>";_137+=" &nbsp; <input type=\"button\" onclick=\"Lichen.MessageList.deleteMessages();return false\" value=\""+_("delete")+"\" />";_137+=" &nbsp; <input type=\"button\" onclick=\"Lichen.MessageList.withSelected(null, 'flag');return false\" value=\""+_("flag")+"\" />";_137+=" &nbsp; <input type=\"button\" onclick=\"Lichen.MessageList.withSelected(null, 'markseen');return false\" value=\""+_("mark read")+"\" /><br />";if(!_136){_137+="select: <a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(1);return false\">"+_("all")+"</a> | ";_137+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(2);return false\">"+_("none")+"</a> | ";_137+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(3);return false\">"+_("read")+"</a> | ";_137+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(4);return false\">"+_("unread")+"</a> | ";_137+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(5);return false\">"+_("flagged")+"</a> | ";_137+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(6);return false\">"+_("unflagged")+"</a> | ";_137+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(0);return false\">"+_("invert")+"</a>";}_137+="</div><div class=\"header-right\">";if(_135.numberpages>1){var _13d=_("previous");var _13e=_("next");if(this.sort=="date"){if(this.sortAsc){_13d=_("earlier");_13e=_("later");}else{_13d=_("later");_13e=_("earlier");}}if(_138>1){_137+="<a href=\"#\" onclick=\"Lichen.MessageList.previousPage(); return false\">"+_13d+"</a> | ";}_137+="<select onchange=\"Lichen.MessageList.setPage(this.value);\">";var _13f=_135.pagesize;var _140=_135.numbermessages;var _141=0;for(var i=1;i<=_135.numbermessages;i+=_13f){_137+="<option value=\""+_141+"\"";if(_138==(_141+1)){_137+=" selected=\"selected\"";}_137+=">"+i+" to ";if((_141+1)*_13f>_140){_137+=_140;}else{_137+=(_141+1)*_13f;}_137+="</option>";_141++;}_137+="</select>";_137+=" of "+_135.numbermessages;if(_139-_138>0){_137+=" | <a href=\"#\" onclick=\"Lichen.MessageList.nextPage(); return false\">"+_13e+"</a>";}}else{if(_135.numbermessages>0&&!_136){_137+=_("showing 1 to ")+_135.numbermessages+_(" of ")+_135.numbermessages;}}_137+="</div></div>";return _137;},getSelectedMessages:function(){var _142=new Array();var _143=$A($(this.wrapper).getElementsByTagName("input"));for(var i=0;i<_143.length;i++){if(_143[i].type!="checkbox"){continue;}if(_143[i].checked){_142.push(_143[i].value);}}return _142;},messageCheckboxClicked:function(_145){this.allSelectedStatus=0;this.allSelectedDisplay();this.setRowActive(_145);return false;},setRowActive:function(_146){var _147=$("mr-"+_146.value);if(_146.checked){_147.addClass("active");}else{_147.removeClass("active");}},allSelectedDisplay:function(_148){var _149="";if(this.allSelectedStatus==0){if(!_148){$("select-all-notification").setStyle("display","none");}}else{if(this.allSelectedStatus==1){_149+=_("Only the ")+"<b>"+this.messagesOnThisPage+"</b>"+_(" messages on this page have been selected. ");_149+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(7);\">";if(this.getSearch()==""){_149+=_("Select all messages in this mailbox");}else{_149+=_("Select all messages from this search");}_149+="</a>.";}else{_149+=_("All ")+"<b>"+this.messagesInMailbox+"</b>"+_(" messages ");if(this.getSearch()==""){_149+=_("in this mailbox have been selected. ");}else{_149+=_("from this search have been selected. ");}_149+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(1);\">";_149+=_("Select only the messages on this page");_149+="</a>.";}if(!_148){$("select-all-notification").setHTML(_149);$("select-all-notification").setStyle("display","block");}}return _149;},allSelectedServerNotify:function(_14a){if(this.allSelectedStatus==2){Lichen.Messages.nextOperationOnAllMessages(this.getMailbox(),this.getSearch());}else{Lichen.Messages.clearOperationOnAllMessages();}if(_14a){this.allSelectedStatus=0;Lichen.Messages.clearOperationOnAllMessages();}},selectMessages:function(mode){var _14c=$A($("list-data-tbl").getElementsByTagName("input"));this.allSelectedStatus=0;if(mode==1){this.allSelectedStatus=1;}else{if(mode==7){this.allSelectedStatus=2;}}for(var i=1;i<_14c.length;i++){var _14e=_14c[i].value;switch(mode){case 1:case 7:_14c[i].checked=true;break;case 2:_14c[i].checked=false;break;case 3:_14c[i].checked=!$("mr-"+_14e).hasClass("new");break;case 4:_14c[i].checked=$("mr-"+_14e).hasClass("new");break;case 5:_14c[i].checked=!($("f-"+_14e).src.substring($("f-"+_14e).src.length-12)=="flag_off.png");break;case 6:_14c[i].checked=($("f-"+_14e).src.substring($("f-"+_14e).src.length-12)=="flag_off.png");break;default:_14c[i].checked=!_14c[i].checked;break;}this.setRowActive(_14c[i]);}this.allSelectedDisplay();},withSelected:function(_14f,_150){var _151=this.getSelectedMessages();var _152="noop";if(!_14f&&_150){_152=_150;}else{_152=_14f.value;}var _153="";if(_152.substr(0,5)=="move-"){_153=_152.substr(5);_152="move";}this.allSelectedServerNotify();switch(_152){case "noop":break;case "markseen":this.twiddleFlag(_151.join(","),"seen","true");break;case "markunseen":this.twiddleFlag(_151.join(","),"seen","false");break;case "flag":this.twiddleFlag(_151.join(","),"flagged","true");break;case "unflag":this.twiddleFlag(_151.join(","),"flagged","false");break;case "move":this.moveMessages(_153);break;}if(_14f){_14f.selectedIndex=0;}},twiddleFlag:function(uid,flag,_156){Lichen.Messages.twiddleFlag(this.getMailbox(),uid,flag,_156,this.twiddleFlagCB.bind(this));},twiddleFlagCB:function(_157){var _158=_157.uid.split(",");if(_157.flag=="seen"){for(var i=0;i<_158.length;i++){var _15a=$("mr-"+_158[i]);if(_15a){if(!_157.state){_15a.addClass("new");}else{_15a.removeClass("new");}}}}if(_157.flag=="flagged"){for(var i=0;i<_158.length;i++){var _15b=$("f-"+_158[i]);if(_15b){if(_157.state){_15b.src="themes/"+userSettings.theme+"/icons/flag.png";}else{_15b.src="themes/"+userSettings.theme+"/icons/flag_off.png";}}}}if(_158.length>1){Lichen.Flash.flashMessage(_("Updated ")+_158.length+_(" messages."));}},moveMessages:function(_15c){var _15d=this.getSelectedMessages();var _15e=_15d.length;_15d=_15d.join(",");this.allSelectedServerNotify();Lichen.Messages.moveMessage(this.getMailbox(),_15c,_15d,this.moveMessagesCB.bind(this));this.allSelectedServerNotify(true);},deleteMessages:function(){var _15f=this.getSelectedMessages();var _160=_15f.length;_15f=_15f.join(",");this.allSelectedServerNotify();Lichen.Messages.deleteMessage(this.getMailbox(),_15f,this.moveMessagesCB.bind(this));this.allSelectedServerNotify(true);},moveMessagesCB:function(_161){Lichen.Flash.flashMessage(_161.message);this.listUpdate();},threadTest:function(){new Ajax("ajax.php",{postBody:"request=getThreadedList&mailbox="+encodeURIComponent(this.getMailbox()),onComplete:this.threadTestCB.bind(this),onFailure:if_remoteRequestFailed}).request();},threadTestCB:function(_162){var _163=if_checkRemoteResult(_162);if(!_163){return;}$(this.wrapper).setHTML(_163.htmlFragment);}});var MessageDisplay=new Class({initialize:function(_164,_165){this.dataStore=_164;this.wrapperdiv=_165;this.displayMode="";this.displayModeUID="";this.lastShownUID="";this.messageData=null;},getViewedUID:function(){return this.lastShownUID;},getWindowTitle:function(){if(this.messageData){return this.messageData.subject+_(" - Message Display");}else{return _("Message Display");}},showMessage:function(_166,uid,mode){this.displayMode=mode;this.displayModeUID=uid;var _169=mode;if(mode=="monospace"){_169="text";}this.dataStore.fetchMessage(_166,uid,_169);return false;},showMessageCB:function(_16a,mode){if($("mr-"+_16a.uid)){$("mr-"+_16a.uid).removeClass("new");}if(!mode&&this.displayModeUID==_16a.uid){mode=this.displayMode;}$(this.wrapperdiv).empty();$(this.wrapperdiv).setHTML(this._render(_16a,mode));$(this.wrapperdiv).style.display="block";$("msg-bar").style.display="block";this.lastShownUID=_16a.uid;var _16c=$("btn-draft");if(Lichen.MessageList.getMailbox()==specialFolders.drafts){_16c.setStyle("display","inline");}else{_16c.setStyle("display","none");}},_render:function(_16d,_16e){var _16f=this.dataStore.fetchAdjacentMessages(Lichen.MessageList.getMailbox(),Lichen.MessageList.getSearch(),Lichen.MessageList.getPage(),Lichen.MessageList.getSortStr(),_16d.uid);var _170="<div class=\"list-header-bar\"><img src=\"themes/"+userSettings.theme+"/top-corner.png\" alt=\"\" class=\"top-corner\" />";var _171="<div class=\"header-left\"><a class=\"list-return\" href=\"#inbox\" onclick=\"Lichen.action('list','MessageList','listUpdate');return false\">"+_("back to ")+Lichen.MessageList.getMailbox()+"</a></div>";_171+="<div class=\"header-right\">";if(_16f.previous){_171+="<a href=\"#\" onclick=\"return Lichen.action('display','MessageDisplayer','showMessage',['"+_16d.mailbox+"','"+_16f.previous.uid+"'])\">"+"&laquo; ";if(_16f.previous.subject.length>24){_171+=_16f.previous.subject.substr(0,24)+"...";}else{_171+=_16f.previous.subject;}if(_16f.next){_171+="</a> | ";}else{_171+="</a>";}}if(_16f.next){_171+="<a href=\"#\" onclick=\"return Lichen.action('display','MessageDisplayer','showMessage',['"+_16d.mailbox+"','"+_16f.next.uid+"'])\">";if(_16f.next.subject.length>24){_171+=_16f.next.subject.substr(0,24)+"...";}else{_171+=_16f.next.subject;}_171+=" &raquo;"+"</a>";}_171+="</div>";_171+="<div class=\"header-left\">";_171+="<select onchange=\"Lichen.MessageDisplayer.moveMessage(this)\">";_171+="<option value=\"noop\" selected=\"selected\">"+_("move message to ...")+"</option>";if(!window.ie){mailboxes=this.dataStore.fetchMailboxList(true);}if(mailboxes){for(var i=0;i<mailboxes.length;i++){_171+="<option value=\"move-"+mailboxes[i].fullboxname+"\">";for(var j=0;j<mailboxes[i].folderdepth;j++){_171+="-";}_171+=mailboxes[i].mailbox;_171+="</option>";}}_171+="</select>";_171+=" &nbsp; <input type=\"button\" onclick=\"Lichen.MessageDisplayer.deleteMessage();return false\" value=\""+_("delete message")+"\" />";_171+="</div>";_171+="</div>";_170+=_171;_170+="<select id=\"msg-switch-view\" onchange=\"return Lichen.action('display','MessageDisplayer','switchView',[this.value])\">";_170+="<option value=\"noop\">"+_("switch view ...")+"</option>";if(_16d.texthtml.length>0||_16d.texthtmlpresent){_170+="<option value=\"html\">"+_("HTML part")+"</option>";}if(_16d.textplain.length>0||_16d.textplainpresent){_170+="<option value=\"text\">"+_("text part")+"</option>";_170+="<option value=\"text-mono\">"+_("monospace text")+"</option>";}_170+="<option value=\"source\">"+_("message source")+"</option>";_170+="</select>";_170+="<h1 class=\"msg-head-subject\">"+_16d.subject_html+"</h1>";_170+="<p class=\"msg-head-line2\" id=\"msg-details-short\">";_170+=_("to")+" <span class=\"msg-head-sender\">"+_16d.to_html+"</span><br />";_170+=_("from")+" <span class=\"msg-head-sender\">"+_16d.from_html+"</span> ";_170+="at <span class=\"msg-head-date\">"+_16d.localdate+"</span> ";_170+="</p>";if(_16d.htmlhasremoteimages){_170+="<div class=\"msg-notification\" id=\"msg-remoteimagesnotify\">";_170+=_("Remote images are not displayed.")+" [<a href=\"#\" onclick=\"return Lichen.MessageDisplayer.enableRemoteContent()\">"+_("show images")+"</a>]";_170+="</div>";}if(_16d.texthtml.length>0&&_16e!="text"&&_16e!="monospace"&&_16e!="source"){for(var i=0;i<_16d.texthtml.length;i++){_170+="<div class=\"html-message\">";_170+=_16d.texthtml[i];_170+="</div>";}}else{for(var i=0;i<_16d.textplain.length;i++){_170+="<div id=\"plainmsg-"+i+"\" class=\"plain-message";if(_16e=="monospace"){_170+=" plain-message-monospace";}_170+="\">";if(_16d.textplain[i].substr(0,14)=="LICHENTOOLARGE"){var _174=_16d.textplain[i].substr(15).split(")")[0];_170+="<a href=\"#\" onclick=\"Lichen.MessageDisplayer.getLargePart('"+_16d.uid+"', '"+_16d.mailbox+"','"+_174+"',"+i+");return false\">"+("This message part was too large to return directly. Click here to load it.")+"</a>";}else{_170+=_16d.textplain[i];}_170+="</div>";}}if(_16d.attachments.length>0&&_16e!="source"){_170+="<ul class=\"attachments\">";for(var i=0;i<_16d.attachments.length;i++){var _175=_16d.attachments[i];if(_175.filename==""){continue;}_170+="<li>";var _176="message.php?mailbox="+encodeURIComponent(_16d.mailbox)+"&uid="+encodeURIComponent(_16d.uid)+"&filename="+encodeURIComponent(_175.filename);_170+="<a href=\""+_176+"\" onclick=\"return if_newWin('"+_176+"')\">";_170+=_175.filename+"</a>";_170+=" <span class=\"msg-attach-meta\">type "+_175.type+", size ~"+_175.size+" bytes</span>";if(_175.type.substr(0,5)=="image"){_170+="<br />";_170+="<img src=\""+_176+"\" alt=\""+_176+"\" />";}}_170+="</ul>";}_170+="<div class=\"footer-bar\"><img src=\"themes/"+userSettings.theme+"/bottom-corner.png\" alt=\"\" class=\"bottom-corner\" />"+_171+"</div>";this.messageData=_16d;return _170;},switchView:function(_177){switch(_177){case "html":this.showMessage(Lichen.MessageList.getMailbox(),this.lastShownUID,"html");break;case "text":this.showMessage(Lichen.MessageList.getMailbox(),this.lastShownUID,"text");break;case "text-mono":this.showMessage(Lichen.MessageList.getMailbox(),this.lastShownUID,"monospace");break;case "source":if_newWin("message.php?source&mailbox="+encodeURIComponent(Lichen.MessageList.getMailbox())+"&uid="+encodeURIComponent(this.lastShownUID));break;}return false;},alwaysEnableRemoteContent:function(){this.enableRemoteContent();},showFullDetails:function(){$("msg-details-short").setStyle("display","none");$("msg-details-long").setStyle("display","block");},enableRemoteContent:function(){if(this.messageData.htmlhasremoteimages){for(var i=0;i<this.messageData.remotecontent.length;i++){var _179=this.messageData.remotecontent[i];var _17a=$(_179.id);if(_17a){if(_179.attr=="style"){for(var j=0;j<_179.url.length;j++){_17a.setStyle(_179.url[j][0],_179.url[j][1]);}}else{_17a[_179.attr]=_179.url;}}}}$("msg-remoteimagesnotify").setStyle("display","none");return false;},getLargePart:function(uid,_17d,part,_17f){$("plainmsg-"+_17f).setHTML(_("Please wait... this might take a while..."));var _180=Lichen.Messages.fetchLargePart(_17d,uid,part,_17f);$("plainmsg-"+_17f).setHTML(_180);},moveMessage:function(_181){var _182=_181.value.substr(5);Lichen.Messages.moveMessage(Lichen.MessageList.getMailbox(),_182,this.displayModeUID,this.movedMessageCB.bind(this));},deleteMessage:function(){Lichen.Messages.deleteMessage(Lichen.MessageList.getMailbox(),this.displayModeUID,this.movedMessageCB.bind(this));},movedMessageCB:function(_183){Lichen.Flash.flashMessage(_183.message);var _184=this.dataStore.fetchAdjacentMessages(Lichen.MessageList.getMailbox(),Lichen.MessageList.getSearch(),Lichen.MessageList.getPage(),Lichen.MessageList.getSortStr(),this.displayModeUID);if(_184.next){this.showMessage(Lichen.MessageList.getMailbox(),_184.next.uid);}else{Lichen.action("list","MessageList","listUpdate");}}});var MessageComposer=new Class({initialize:function(_185){this.wrapper=_185;this.messageFormat="text/plain";this.sending=false;this.composerData=null;this.draftSaveTimer=null;},getWindowTitle:function(){var _186=_("Composer - ");if(this.composerData){switch(this.composerData.comp_mode){case "reply":case "replyall":_186+=_("Replying to ")+this.composerData.comp_subj;break;case "forwardinline":case "forwardasattach":_186+=_("Forwarding ")+this.composerData.comp_subj;break;case "draft":_186+=_("Editing draft ")+this.composerData.comp_subj;break;default:_186+=_("New message");break;}}else{_186+=_("New message");}return _186;},showComposer:function(mode,_188,_189){var _18a="request=getComposeData&mailbox="+encodeURIComponent(Lichen.MessageList.getMailbox());if(mode){_18a+="&mode="+mode;}if(_188){_18a+="&uid="+encodeURIComponent(_188);}if(_189){_18a+="&mailto="+encodeURIComponent(_189);}if_remoteRequestStart();new Ajax("ajax.php",{postBody:_18a,onComplete:this.showComposerCBStub.bind(this),onFailure:if_remoteRequestFailed}).request();},showComposerCBStub:function(_18b){Lichen.action("compose","MessageCompose","showComposerCB",[_18b]);},showComposerCB:function(_18c){var _18d=if_checkRemoteResult(_18c);if(!_18d){return;}this._render(_18d.composedata);this.composerData=_18d.composedata;},_render:function(_18e){var _18f="";var _190=_18e.comp_mode;_18f="<div class=\"header-bar\"><img src=\"themes/"+userSettings.theme+"/top-corner.png\" alt=\"\" class=\"top-corner\" /><div class=\"header-right\">&nbsp;</div><div class=\"comp-header\">"+_("New message")+"</div></div>";_18f+="<form action=\""+lichenURL+"\" method=\"post\" id=\"compose\" onsubmit=\"Lichen.MessageCompose.sendMessage();return false\">";_18f+="<input type=\"hidden\" name=\"comp_mode\" id=\"comp_mode\" value=\""+_18e.comp_mode+"\" />";if(_18e.comp_quoteuid){_18f+="<input type=\"hidden\" name=\"comp_quoteuid\" id=\"comp_quoteuid\" value=\""+_18e.comp_quoteuid+"\" />";_18f+="<input type=\"hidden\" name=\"comp_quotemailbox\" id=\"comp_quotemailbox\" value=\""+_18e.comp_quotemailbox+"\" />";}_18f+="<input type=\"hidden\" name=\"comp_draftuid\" id=\"comp_draftuid\" value=\"";if(_190=="draft"){_18f+=_18e.comp_draftuid;}_18f+="\" />";if(_18e.identities.length==1){_18f+="<input name=\"comp_identity\" id=\"comp_identity\" type=\"hidden\" value=\""+_18e.identities[0].address_html+"\" />";}else{_18f+="<label class=\"comp-label\" for=\"comp_identity\">"+_("From:")+"</label> ";_18f+="<select name=\"comp_identity\" id=\"comp_identity\" onchange=\"Lichen.MessageCompose.changeIdentity();\">";for(var i=0;i<_18e.identities.length;i++){var _192=_18e.identities[i];_18f+="<option value=\""+_192.address_html+"\"";if(_18e.identity.address==_18e.identities[i].address){_18f+=" selected=\"selected\"";}_18f+=">"+_192.name_html+" &lt;"+_192.address_html+"&gt;</option>";}_18f+="</select>";}_18f+="<div class=\"comp-label\"><label for=\"comp_to\">"+_("To:")+"</label>";_18f+="<p class=\"comp-add-fields\"><a id=\"comp-ccshow\" href=\"#\""+(_18e.show_cc?" style=\"display:none\"":"")+" onclick=\"$('comp-cceditor').style.display='block';$('comp-ccshow').style.display='none';return false\">"+_("add CC")+"</a>";_18f+=" <a id=\"comp-bccshow\" href=\"#\""+(_18e.show_bcc?" style=\"display:none\"":"")+" onclick=\"$('comp-bcceditor').style.display='block';$('comp-bccshow').style.display='none';return false\">"+_("add BCC")+"</a></p>";_18f+="</div> <textarea name=\"comp_to\" id=\"comp_to\">"+_18e.comp_to+"</textarea>";_18f+="<div id=\"comp-cceditor\" style=\"display: "+(_18e.show_cc?"block":"none")+";\">";_18f+="<label class=\"comp-label\" for=\"comp_cc\">"+_("CC:")+"</label> <textarea name=\"comp_cc\" id=\"comp_cc\">";_18f+=_18e.comp_cc;_18f+="</textarea></div>";_18f+="<div id=\"comp-bcceditor\" style=\"display: "+(_18e.show_bcc?"block":"none")+";\">";_18f+="<label class=\"comp-label\" for=\"comp_bcc\">"+_("BCC:")+"</label> <textarea name=\"comp_bcc\" id=\"comp_bcc\">";_18f+=_18e.comp_bcc;_18f+="</textarea></div>";_18f+="<label class=\"comp-label\" for=\"comp_subj\">"+_("Subject:")+"</label> <input type=\"text\" name=\"comp_subj\" id=\"comp_subj\" value=\"";_18f+=_18e.comp_subj+"\" />";_18f+="<textarea name=\"comp_msg\" id=\"comp_msg\" onchange=\"Lichen.MessageCompose.draftSaveTimeout();\">";_18f+=_18e.comp_msg;_18f+="</textarea>";if(_190=="forwardinline"){_18f+="<p><a href=\"#\" onclick=\"Lichen.MessageCompose.showComposer('forwardasattach',Lichen.MessageDisplayer.getViewedUID()); return false\">&raquo; "+_("forward message as attachment")+"</a></p>";}var _193="";for(var i=0;i<_18e.comp_attach.length;i++){var _194=_18e.comp_attach[i];_193+="<li>"+_194.filename+" ("+_194.type+", "+_194.size+") ";if(_194.isforwardedmessage){_193+="<a href=\"#\" onclick=\"Lichen.MessageCompose.showComposer('forwardinline',Lichen.MessageDisplayer.getViewedUID()); return false\">"+_("[forward inline]")+"</a>";}else{_193+="<a href=\"#\" onclick=\"Lichen.MessageCompose.removeAttachment('"+encodeURIComponent(_194.filename)+"');return false\">";_193+=_("[remove]")+"</a>";}_193+="</li>";_18f+="<input type=\"hidden\" name=\"comp_attach[]\" value=\""+_194.filename+"\" />";}_18f+="</form>";_18f+="<div class=\"sidebar-panel\" id=\"comp-attachments\">";_18f+="<h2 class=\"sidebar-head\"><img src=\"themes/"+userSettings.theme+"/icons/attach.png\" alt=\"\" /> "+_("attachments")+"</h2>";_18f+="<ul id=\"comp-attachlist\">";_18f+=_193;_18f+="</ul>";_18f+="<form enctype=\"multipart/form-data\" action=\"ajax.php\" id=\"comp-uploadform\" method=\"post\" onsubmit=\"return Lichen.MessageCompose.asyncUploadFile($('comp-uploadform'))\">";_18f+="<input type=\"hidden\" name=\"request\" id=\"request\" value=\"uploadAttachment\" />";_18f+="<input type=\"hidden\" name=\"MAX_FILE_SIZE\" value=\""+_18e.maxattachmentsize+"\" />";_18f+="<label for=\"comp_attachfile\">"+_("add new")+"</label><br />";_18f+="<input type=\"file\" name=\"comp_attachfile\" id=\"comp_attachfile\" />";_18f+="<div class=\"comp-attach-submit\"><input type=\"submit\" value=\""+_("upload file")+"\" /></div>";_18f+="<input type=\"hidden\" name=\"upattach\" value=\"1\" />";_18f+="</form></div>";$(this.wrapper).setHTML(_18f);},getIdentityFromCache:function(_195){if(this.composerData){for(var i=0;i<this.composerData.identities.length;i++){if(this.composerData.identities[i].address==_195){return this.composerData.identities[i];}}}return null;},changeIdentity:function(){var _197=this.getIdentityFromCache(this.composerData.identity.address);var _198=this.getIdentityFromCache($("comp_identity").value);var _199="";_199=$("comp_msg").value;var _19a=-1;if(_197.signature!=""){_19a=_199.indexOf(_197.signature);}if(_19a!=-1){_199=_199.substr(0,_19a)+_198.signature+_199.substr(_19a+_197.signature.length);}else{_199+="\n"+_198.signature;}this.composerData.identity=_198;$("comp_msg").value=_199;},sendMessage:function(_19b){Lichen.busy();if(this.sending){Lichen.Flash.flashMessage(_("The message is sending. Please wait."));return false;}else{this.sending=true;}if(_19b){Lichen.Flash.flashMessage(_("Saving draft ..."));}else{Lichen.Flash.flashMessage(_("Sending message ..."));}var _19c="request=sendMessage&";if(_19b){_19c+="draft=save&";}_19c+="format="+encodeURIComponent(this.messageFormat)+"&";_19c+=$("compose").toQueryString();new Ajax("ajax.php",{postBody:_19c,onComplete:this.sendMessageCB.bind(this),onFailure:if_remoteRequestFailed}).request();this.draftClearTimeout();},sendMessageCB:function(_19d){this.sending=false;Lichen.notbusy();var _19e=if_checkRemoteResult(_19d);if(!_19e){return;}if(_19e.draftMode){if($("comp_draftuid")){$("comp_draftuid").value=_19e.draftUid;}var d=new Date();var hr=d.getHours();var min=d.getMinutes();if(min<10){min="0"+min;}if(hr==0){hr="12";}if(hr>12){hr=hr-12;min+=" PM";}else{min+=" AM";}Lichen.Flash.flashMessage(_("Draft saved at")+" "+hr+":"+min);}else{this.cleanupComposer();Lichen.action("list","MessageList","listUpdate");Lichen.Flash.flashMessage(_19e.message);}},cleanupComposer:function(){this.draftClearTimeout();},draftSaveTimeout:function(){if(this.draftSaveTimer){clearTimeout(this.draftSaveTimer);}this.draftSaveTimer=setTimeout(this.draftSaveTimedout.bind(this),60*1000);},draftClearTimeout:function(){if(this.draftSaveTimer){clearTimeout(this.draftSaveTimer);this.draftSaveTimer=null;}},draftSaveTimedout:function(){this.sendMessage(true);},removeAttachment:function(_1a2){var _1a3=$A($("compose").getElementsByTagName("input"));var _1a4=$A($("comp-attachlist").getElementsByTagName("li"));var _1a5=false;_1a2=unescape(_1a2);for(var i=0;i<_1a3.length;i++){var _1a7=_1a3[i];if(_1a7.type=="hidden"&&_1a7.value==_1a2){_1a5=true;_1a7.remove();}}for(var i=0;i<_1a4.length;i++){var _1a7=_1a4[i];if(_1a7.getText().contains(_1a2)){_1a7.remove();}}if(_1a5){new Ajax("ajax.php",{postBody:"request=removeAttachment&filename="+encodeURIComponent(_1a2),onComplete:this.attachmentDeleted.bind(this),onFailure:if_remoteRequestFailed}).request();}},attachmentDeleted:function(_1a8){var _1a9=if_checkRemoteResult(_1a8);},asyncUploadFile:function(_1aa){var _1ab="asyncUpload"+Math.floor(Math.random()*99999);var _1ac=new Element("div");$(_1ac).setHTML("<iframe style='display: none;' src='about:blank' id='"+_1ab+"' name='"+_1ab+"' onload='Lichen.MessageCompose.asyncUploadCompleted(\""+_1ab+"\")'></iframe>");$("comp-wrapper").adopt(_1ac);$(_1aa).setProperty("target",_1ab);return true;},asyncUploadCompleted:function(_1ad){var _1ae=$(_1ad);if(_1ae==null){return;}if(_1ae.contentWindow!=null){_1ae=_1ae.contentWindow.document;}else{if(_1ae.contentDocument!=null){_1ae=_1ae.contentDocument;}else{_1ae=window.frames[_1ad].document;}}if(_1ae.location.href=="about:blank"){return;}_1ae.location.href="about:blank";var _1af=if_checkRemoteResult(_1ae.body.innerHTML);if(!_1af){return;}$(_1ad).getParent().remove();var _1b0=new Element("li");_1b0.setHTML(_1af.filename+" ("+_1af.type+", "+_1af.size+" bytes)"+" (<a href=\"#\" onclick=\"Lichen.MessageCompose.removeAttachment('"+escape(_1af.filename)+"');return false\">"+_("remove")+"</a>)");$("comp-attachlist").adopt(_1b0);var _1b1=new Element("input");_1b1.type="hidden";_1b1.name="comp_attach[]";_1b1.value=_1af.filename;$("compose").adopt(_1b1);$("comp_attachfile").value="";}});var OptionsEditorClass=new Class({initialize:function(_1b2){this.wrapper=_1b2;this.identityCache=null;},getWindowTitle:function(){return _("Lichen - Settings");},showEditor:function(_1b3){if_remoteRequestStart();Lichen.busy();new Ajax("ajax.php",{postBody:"request=settingsPanel&tab="+encodeURIComponent(_1b3),onComplete:this.showEditorCBStub.bind(this),onFailure:if_remoteRequestFailed}).request();},showEditorCBStub:function(_1b4){Lichen.action("options","OptionsEditor","showEditorCB",[_1b4]);Lichen.notbusy();},showEditorCB:function(_1b5){var _1b6=if_checkRemoteResult(_1b5);if(!_1b6){return;}$(this.wrapper).setHTML(_1b6.htmlFragment);if(_1b6.mailboxes){Lichen.MailboxManager.mailboxCache=_1b6.mailboxes;}if(_1b6.identities){this.identityCache=_1b6.identities;}},closePanel:function(){Lichen.MailboxList.listUpdate();Lichen.action("list","MessageList","listUpdate");},generateQueryString:function(_1b7){var _1b8=$A($(_1b7).getElementsByTagName("input"));_1b8.extend($A($(_1b7).getElementsByTagName("select")));var _1b9=new Array();for(var i=0;i<_1b8.length;i++){var _1bb="";switch(_1b8[i].type){case "checkbox":if(_1b8[i].checked){_1bb="true";}else{_1bb="false";}break;default:_1bb=_1b8[i].value;break;}_1b9.push(_1b8[i].id+"="+encodeURIComponent(_1bb));}return _1b9.join("&");},saveOptions:function(){if_remoteRequestStart();Lichen.busy();new Ajax("ajax.php",{postBody:"request=settingsPanelSave&"+this.generateQueryString("opts-settings"),onComplete:this.saveOptionsCB.bind(this),onFailure:if_remoteRequestFailed}).request();},saveOptionsCB:function(_1bc){Lichen.notbusy();var _1bd=if_checkRemoteResult(_1bc);if(!_1bd){return;}if(_1bd.errors&&_1bd.errors.length>0){alert(_("There were some errors saving your settings.\nAny valid settings were saved.\n\n")+_1bd.errors.join("\n"));}else{this.closePanel();}opts_getCB(_1bd);},identity_findInCache:function(_1be){for(var i=0;i<this.identityCache.length;i++){if(_1be==this.identityCache[i].address){return this.identityCache[i];}}return null;},identity_add:function(){$("opts-identity-name").value="";$("opts-identity-address").value="";$("opts-identity-sig").value="";if(!$("opts-identity-new")){var _1c0=new Element("option",{"id":"opts-identity-new"});_1c0.appendText("new identity");$("opts-identity-list").adopt(_1c0);$("opts-identity-list").value="new identity";}$("opts-identity-save").onclick=Lichen.OptionsEditor.identity_add_done.bind(this);return false;},identity_add_done:function(){var _1c1=$("opts-identity-name").value;var _1c2=$("opts-identity-address").value;var _1c3=$("opts-identity-sig").value;if(_1c1==""||_1c2==""){Lichen.Flash.flashMessage(_("Can't add an identity with a blank name or blank e-mail."));return false;}new Ajax("ajax.php",{postBody:"request=identityEditor&action=add&idname="+encodeURIComponent(_1c1)+"&idemail="+encodeURIComponent(_1c2)+"&idsig="+encodeURIComponent(_1c3),onComplete:this.identity_actionCB.bind(this),onFailure:if_remoteRequestFailed}).request();return false;},identity_edit:function(){if($("opts-identity-new")){$("opts-identity-new").remove();}var _1c4=$("opts-identity-list");if(_1c4.value==""){return false;}var _1c5=this.identity_findInCache(_1c4.value);$("opts-identity-name").value=_1c5.name;$("opts-identity-address").value=_1c5.address;$("opts-identity-sig").value=_1c5.signature;$("opts-identity-save").onclick=function(){return Lichen.OptionsEditor.identity_edit_done(_1c5.address);};return false;},identity_edit_done:function(_1c6){var _1c7=$("opts-identity-name").value;var _1c8=$("opts-identity-address").value;var _1c9=$("opts-identity-sig").value;if(_1c7==""||_1c8==""){Lichen.Flash.flashMessage(_("Can't edit an identity to have a blank name or blank e-mail."));return false;}new Ajax("ajax.php",{postBody:"request=identityEditor&action=edit&idname="+encodeURIComponent(_1c7)+"&idemail="+encodeURIComponent(_1c8)+"&oldid="+encodeURIComponent(_1c6)+"&idsig="+encodeURIComponent(_1c9),onComplete:this.identity_actionCB.bind(this),onFailure:if_remoteRequestFailed}).request();return false;},identity_setdefault:function(){var _1ca=$("opts-identity-list");if(_1ca.value==""){return false;}new Ajax("ajax.php",{postBody:"request=identityEditor&action=setdefault&oldid="+encodeURIComponent(_1ca.value),onComplete:this.identity_actionCB.bind(this),onFailure:if_remoteRequestFailed}).request();return false;},identity_remove:function(){var _1cb=$("opts-identity-list");if(_1cb.value==""){return false;}new Ajax("ajax.php",{postBody:"request=identityEditor&action=delete&oldid="+encodeURIComponent(_1cb.value),onComplete:this.identity_actionCB.bind(this),onFailure:if_remoteRequestFailed}).request();return false;},identity_actionCB:function(_1cc){var _1cd=if_checkRemoteResult(_1cc);if(!_1cd){return;}Lichen.action("options","OptionsEditor","showEditor",["identities"]);}});function opts_get(){new Ajax("ajax.php",{postBody:"request=getUserSettings",onComplete:opts_getCB,onFailure:if_remoteRequestFailed}).request();}function opts_getCB(_1ce){var _1cf=if_checkRemoteResult(_1ce);if(!_1cf){return;}userSettings=_1cf.settings;}var InterfaceController=new Class({initialize:function(){this.mode="list";this.Messages=new MessagesDatastore(true);this.OptionsEditor=new OptionsEditorClass("opts-wrapper");this.MailboxManager=new MailboxManagerClass(this.Messages);this.MessageDisplayer=new MessageDisplay(this.Messages,"msg-wrapper");this.Flash=new FlashArea("notification");this.MessageList=new MessageLister(this.Messages,"list-wrapper");this.MailboxList=new MailboxLister("mailboxes");this.MessageCompose=new MessageComposer("comp-wrapper");this.ActionCounter=1;this.historyTrail=new Array(Array("list","MessageList","listUpdate"));this.historyChecker=null;this.lastHash="";this.modeFeedback=null;this.busyCounter=0;this.busyDiv="loading-box";this.busyIFrame=new Element("iframe");this.busyIFrame.setStyle("display","none");this.loadInit=false;},onLoadInit:function(){this.checkCount();this.MessageList.listUpdate();if(window.khtml){var _1d0=(window.innerWidth-350)+"px";$("list-bar").style.width=_1d0;$("comp-bar").style.width=_1d0;$("opts-bar").style.width=_1d0;$("msg-bar").style.width=_1d0;}if(window.ie6){for(var i=0;i<document.images.length;i++){var img=document.images[i];var _1d3=img.src.toUpperCase();if(_1d3.substring(_1d3.length-3,_1d3.length)=="PNG"){var _1d4="<span style=\"width:22px;height:22px;cursor:hand;"+"display:inline-block;vertical-align:middle;"+"filter:progid:DXImageTransform.Microsoft.AlphaImageLoader"+"(src='"+img.src+"', sizingMethod='crop');\"></span>";img.outerHTML=_1d4;i=i-1;}}$("corner-bar").style.width=(document.body.clientWidth-128)+"px";}},checkCount:function(){this.Messages.fetchMailboxList();this.clearTimer();this.setTimer();},setTimer:function(){if(!this.refreshTimer&&userSettings["list_refreshtime"]!="disabled"){this.refreshTimer=setTimeout(this.checkCount.bind(this),userSettings["list_refreshtime"]*60*1000);}},clearTimer:function(){if(this.refreshTimer){clearTimeout(this.refreshTimer);this.refreshTimer=null;}},action:function(mode,_1d6,_1d7,data,_1d9){if(mode&&this.mode=="compose"&&mode!=this.mode){this.MessageCompose.cleanupComposer();}if(mode&&mode!=this.mode&&this.modeFeedback==null){this.modeFeedback=new PaneTransition(this.getWrapperName(this.mode));this.busy();}else{if(mode&&mode!=this.mode&&this.modeFeedback!=null){this.modeFeedback.end();this.modeFeedback=null;this.clearScreen();this.enterMode(mode);this.notbusy();}}if(mode&&mode!="list"){this.clearTimer();}else{if(mode=="list"){this.setTimer();}}if(this[_1d6]&&this[_1d6][_1d7]){if(data){this[_1d6][_1d7].apply(this[_1d6],data);}else{this[_1d6][_1d7].apply(this[_1d6],[]);}}if(this[_1d6]&&this[_1d6]["getWindowTitle"]){document.title=this[_1d6].getWindowTitle();}return false;},clearScreen:function(){$("list-bar").setStyle("display","none");$("comp-bar").setStyle("display","none");$("msg-bar").setStyle("display","none");$("opts-bar").setStyle("display","none");$("list-wrapper").setStyle("display","none");$("msg-wrapper").setStyle("display","none");$("opts-wrapper").setStyle("display","none");$("comp-wrapper").setStyle("display","none");$("addr-wrapper").setStyle("display","none");$("list-wrapper").empty();$("msg-wrapper").empty();$("opts-wrapper").empty();$("comp-wrapper").empty();$("addr-wrapper").setStyle("display","none");},getWrapperName:function(mode){var _1db="list-wrapper";switch(mode){case "list":_1db="list-wrapper";break;case "compose":_1db="comp-wrapper";break;case "display":_1db="msg-wrapper";break;case "options":_1db="opts-wrapper";break;case "abook":_1db="addr-wrapper";break;}return _1db;},enterMode:function(mode){if(mode!=this.mode){this.mode=mode;switch(mode){case "list":$("list-bar").setStyle("display","block");$("list-wrapper").setStyle("display","block");break;case "compose":$("comp-bar").setStyle("display","block");$("comp-wrapper").setStyle("display","block");break;case "display":$("msg-bar").setStyle("display","block");$("msg-wrapper").setStyle("display","block");break;case "options":$("opts-bar").setStyle("display","block");$("opts-wrapper").setStyle("display","block");break;case "abook":$("addr-wrapper").setStyle("display","block");break;default:this.enterMode("list");break;}}},getMode:function(){return this.mode;},busy:function(){if(!this.loadInit){$(this.busyDiv).adopt(this.busyIFrame);this.loadInit=true;}this.busyCounter+=1;if(this.busyCounter>0){this.busyIFrame.src="wait.php";}},notbusy:function(){if(this.busyCounter>0){this.busyCounter-=1;}if(this.busyCounter<1){this.busyIFrame.src="about:blank";}}});var Lichen=new InterfaceController();function HTMLToText(_1dd,_1de){var _1df=document.createElement("div");_1df.innerHTML=_1dd;var _1e0=_htt_parseNode(_1df,_1de);return _1e0;}function _htt_parseNode(node,_1e2,_1e3){var i=0;var _1e5="";for(i=0;i<node.childNodes.length;i++){if(node.childNodes[i].tagName=="A"){_1e5+=node.childNodes[i].href;}else{if(node.childNodes[i].tagName=="HR"){_1e5+="-------------------------\n\n";}else{if(node.childNodes[i].childNodes.length>0){_1e5+=_htt_parseNode(node.childNodes[i]);}else{if(node.childNodes[i].nodeType==3){_1e5+=node.childNodes[i].nodeValue;}}}}}switch(node.tagName){case "H1":case "H2":case "H3":case "H4":case "H5":case "H6":_1e5=_1e5.toUpperCase();_1e5+="\n\n";break;case "P":case "DIV":_1e5+="\n\n";break;}return _1e5;}