var GoogleCacheConnector=new Class({initialize:function(_1,_2){}});var HashCacheConnector=new Class({initialize:function(_3,_4){this.messagelists={};this.messagelistsvalidity={};this.messages={};this.mailboxlist={};this.mailboxlistvalidity=null;this.dataStore=_3;},storeMessageList:function(_5,_6,_7,_8,_9,_a){var _b=_5+_6+_7+_8;if(_a&&this.messagelistsvalidity[_b]&&_a==this.messagelistsvalidity[_b]){return this.messagelists[_b];}else{this.messagelists[_b]=_9;this.messagelistsvalidity[_b]=_a;return _9;}},getMessageList:function(_c,_d,_e,_f,_10){var _11=_c+_d+_e+_f;if(this.messagelists[_11]&&this.messagelistsvalidity[_11]&&_10&&this.messagelistsvalidity[_11]==_10){return this.messagelists[_11];}else{return null;}},getMessageListValidity:function(_12,_13,_14,_15){var _16=_12+_13+_14+_15;if(this.messagelistsvalidity[_16]!=null){return this.messagelistsvalidity[_16];}else{return null;}},haveCachedMessageList:function(_17,_18,_19,_1a){if(this.getMessageList(_17,_18,_19,_1a,this.getMessageListValidity(_17,_18,_19,_1a))){return true;}return false;},updateFlagStatus:function(_1b,_1c,_1d,_1e,uid,_20,_21){var _22=_1b+_1c+_1d+_1e;var _23=uid.toInt();if(this.messagelists[_22]){for(var i=0;i<this.messagelists[_22].messages.length;i++){if(this.messagelists[_22].messages[i].uid==_23){switch(_20){case "flagged":this.messagelists[_22].messages[i].flagged=_21;break;case "seen":if(_21){this.messagelists[_22].messages[i].readStatus="R";}else{this.messagelists[_22].messages[i].readStatus="U";}break;}}}}},storeMessage:function(_25,uid,_27,_28){var _29=_25+uid;if(this.messages[_29]){var _2a=this.messages[_29];if(_2a.texthtmlpresent&&_2a.texthtml.length==0&&_27.texthtml.length>0){_2a.texthtml=_27.texthtml;}if(_2a.textplainpresent&&_2a.textplain.length==0&&_27.textplain.length>0){_2a.textplain=_27.textplain;}if(_2a.source==null&&_27.source!=null){_2a.source=_27.source;}}else{this.messages[_29]=_27;}return this.messages[_29];},storeLargePart:function(_2b,uid,_2d,_2e){var _2f=_2b+uid;if(this.messages[_2f]){this.messages[_2f].textplain[_2d]=_2e;}},getMessage:function(_30,uid,_32,_33){var _34=_30+uid;var _35=null;if(this.messages[_34]&&_33){var _36=false;var _37=this.messages[_34];switch(_32){case "html":if(_37.texthtmlpresent&&_37.texthtml.length!=0){_36=true;}break;case "text":if(_37.textplainpresent&&_37.textplain.length!=0){_36=true;}break;case "source":if(_37.source){_36=true;}break;case "all":break;default:_36=true;break;}if(_36){_35=this.messages[_34];}}return _35;},storeMailboxList:function(_38,_39){if(_39&&_39==this.mailboxlistvalidity){return this.mailboxlist;}else{this.mailboxlist=_38;this.mailboxlistvalidity=_39;return _38;}},getMailboxList:function(_3a){if(_3a&&_3a==this.mailboxlistvalidity){return this.mailboxlist;}else{return null;}},getMailboxListValidity:function(){return this.mailboxlistvalidity;}});var MessageComposer=new Class({initialize:function(_3b){this.wrapper=_3b;this.messageFormat="text/plain";this.sending=false;this.composerData=null;this.draftSaveTimer=null;},getWindowTitle:function(){var _3c=_("Composer - ");if(this.composerData){switch(this.composerData.comp_mode){case "reply":case "replyall":_3c+=_("Replying to ")+this.composerData.comp_subj;break;case "forwardinline":case "forwardasattach":_3c+=_("Forwarding ")+this.composerData.comp_subj;break;case "draft":_3c+=_("Editing draft ")+this.composerData.comp_subj;break;default:_3c+=_("New message");break;}}else{_3c+=_("New message");}return _3c;},showComposer:function(_3d,_3e,_3f){var _40="request=getComposeData&mailbox="+encodeURIComponent(Lichen.MessageList.getMailbox());if(_3d){_40+="&mode="+_3d;}if(_3e){_40+="&uid="+encodeURIComponent(_3e);}if(_3f){_40+="&mailto="+encodeURIComponent(_3f);}if_remoteRequestStart();new Ajax("ajax.php",{postBody:_40,onComplete:this.showComposerCBStub.bind(this),onFailure:if_remoteRequestFailed}).request();},showComposerCBStub:function(_41){Lichen.action("compose","MessageCompose","showComposerCB",[_41]);},showComposerCB:function(_42){var _43=if_checkRemoteResult(_42);if(!_43){return;}this._render(_43.composedata);this.composerData=_43.composedata;},_render:function(_44){var _45="";var _46=_44.comp_mode;_45="<div class=\"header-bar\"><img src=\"themes/"+userSettings.theme+"/top-corner.png\" alt=\"\" class=\"top-corner\" /><div class=\"header-right\">&nbsp;</div><div class=\"comp-header\">"+_("New message")+"</div></div>";_45+="<form action=\""+lichenURL+"\" method=\"post\" id=\"compose\" onsubmit=\"Lichen.MessageCompose.sendMessage();return false\">";_45+="<input type=\"hidden\" name=\"comp_mode\" id=\"comp_mode\" value=\""+_44.comp_mode+"\" />";if(_44.comp_quoteuid){_45+="<input type=\"hidden\" name=\"comp_quoteuid\" id=\"comp_quoteuid\" value=\""+_44.comp_quoteuid+"\" />";_45+="<input type=\"hidden\" name=\"comp_quotemailbox\" id=\"comp_quotemailbox\" value=\""+_44.comp_quotemailbox+"\" />";}_45+="<input type=\"hidden\" name=\"comp_draftuid\" id=\"comp_draftuid\" value=\"";if(_46=="draft"){_45+=_44.comp_draftuid;}_45+="\" />";if(_44.identities.length==1){_45+="<input name=\"comp_identity\" id=\"comp_identity\" type=\"hidden\" value=\""+_44.identities[0].address_html+"\" />";}else{_45+="<label class=\"comp-label\" for=\"comp_identity\">"+_("From:")+"</label> ";_45+="<select name=\"comp_identity\" id=\"comp_identity\" onchange=\"Lichen.MessageCompose.changeIdentity();\">";for(var i=0;i<_44.identities.length;i++){var _48=_44.identities[i];_45+="<option value=\""+_48.address_html+"\"";if(_44.identity.address==_44.identities[i].address){_45+=" selected=\"selected\"";}_45+=">"+_48.name_html+" &lt;"+_48.address_html+"&gt;</option>";}_45+="</select>";}_45+="<div class=\"comp-label\"><label for=\"comp_to\">"+_("To:")+"</label>";_45+="<p class=\"comp-add-fields\"><a id=\"comp-ccshow\" href=\"#\""+(_44.show_cc?" style=\"display:none\"":"")+" onclick=\"$('comp-cceditor').style.display='block';$('comp-ccshow').style.display='none';return false\">"+_("add CC")+"</a>";_45+=" <a id=\"comp-bccshow\" href=\"#\""+(_44.show_bcc?" style=\"display:none\"":"")+" onclick=\"$('comp-bcceditor').style.display='block';$('comp-bccshow').style.display='none';return false\">"+_("add BCC")+"</a></p>";_45+="</div> <textarea name=\"comp_to\" id=\"comp_to\">"+_44.comp_to+"</textarea>";_45+="<div id=\"comp-cceditor\" style=\"display: "+(_44.show_cc?"block":"none")+";\">";_45+="<label class=\"comp-label\" for=\"comp_cc\">"+_("CC:")+"</label> <textarea name=\"comp_cc\" id=\"comp_cc\">";_45+=_44.comp_cc;_45+="</textarea></div>";_45+="<div id=\"comp-bcceditor\" style=\"display: "+(_44.show_bcc?"block":"none")+";\">";_45+="<label class=\"comp-label\" for=\"comp_bcc\">"+_("BCC:")+"</label> <textarea name=\"comp_bcc\" id=\"comp_bcc\">";_45+=_44.comp_bcc;_45+="</textarea></div>";_45+="<label class=\"comp-label\" for=\"comp_subj\">"+_("Subject:")+"</label> <input type=\"text\" name=\"comp_subj\" id=\"comp_subj\" value=\"";_45+=_44.comp_subj+"\" />";_45+="<textarea name=\"comp_msg\" id=\"comp_msg\" onchange=\"Lichen.MessageCompose.draftSaveTimeout();\">";_45+=_44.comp_msg;_45+="</textarea>";if(_46=="forwardinline"){_45+="<p><a href=\"#\" onclick=\"Lichen.MessageCompose.showComposer('forwardasattach',Lichen.MessageDisplayer.getViewedUID()); return false\">&raquo; "+_("forward message as attachment")+"</a></p>";}var _49="";for(var i=0;i<_44.comp_attach.length;i++){var _4a=_44.comp_attach[i];_49+="<li>"+_4a.filename+" ("+_4a.type+", "+_4a.size+") ";if(_4a.isforwardedmessage){_49+="<a href=\"#\" onclick=\"Lichen.MessageCompose.showComposer('forwardinline',Lichen.MessageDisplayer.getViewedUID()); return false\">"+_("[forward inline]")+"</a>";}else{_49+="<a href=\"#\" onclick=\"Lichen.MessageCompose.removeAttachment('"+encodeURIComponent(_4a.filename)+"');return false\">";_49+=_("[remove]")+"</a>";}_49+="</li>";_45+="<input type=\"hidden\" name=\"comp_attach[]\" value=\""+_4a.filename+"\" />";}_45+="</form>";_45+="<div class=\"sidebar-panel\" id=\"comp-attachments\">";_45+="<h2 class=\"sidebar-head\"><img src=\"themes/"+userSettings.theme+"/icons/attach.png\" alt=\"\" /> "+_("attachments")+"</h2>";_45+="<ul id=\"comp-attachlist\">";_45+=_49;_45+="</ul>";_45+="<form enctype=\"multipart/form-data\" action=\"ajax.php\" id=\"comp-uploadform\" method=\"post\" onsubmit=\"return Lichen.MessageCompose.asyncUploadFile($('comp-uploadform'))\">";_45+="<input type=\"hidden\" name=\"request\" id=\"request\" value=\"uploadAttachment\" />";_45+="<input type=\"hidden\" name=\"MAX_FILE_SIZE\" value=\""+_44.maxattachmentsize+"\" />";_45+="<label for=\"comp_attachfile\">"+_("add new")+"</label><br />";_45+="<input type=\"file\" name=\"comp_attachfile\" id=\"comp_attachfile\" />";_45+="<div class=\"comp-attach-submit\"><input type=\"submit\" value=\""+_("upload file")+"\" /></div>";_45+="<input type=\"hidden\" name=\"upattach\" value=\"1\" />";_45+="</form></div>";$(this.wrapper).setHTML(_45);},getIdentityFromCache:function(_4b){if(this.composerData){for(var i=0;i<this.composerData.identities.length;i++){if(this.composerData.identities[i].address==_4b){return this.composerData.identities[i];}}}return null;},changeIdentity:function(){var _4d=this.getIdentityFromCache(this.composerData.identity.address);var _4e=this.getIdentityFromCache($("comp_identity").value);var _4f="";_4f=$("comp_msg").value;var _50=-1;if(_4d.signature!=""){_50=_4f.indexOf(_4d.signature);}if(_50!=-1){_4f=_4f.substr(0,_50)+_4e.signature+_4f.substr(_50+_4d.signature.length);}else{_4f+="\n"+_4e.signature;}this.composerData.identity=_4e;$("comp_msg").value=_4f;},sendMessage:function(_51){Lichen.busy();if(this.sending){Lichen.Flash.flashMessage(_("The message is sending. Please wait."));return false;}else{this.sending=true;}if(_51){Lichen.Flash.flashMessage(_("Saving draft ..."));}else{Lichen.Flash.flashMessage(_("Sending message ..."));}var _52="request=sendMessage&";if(_51){_52+="draft=save&";}_52+="format="+encodeURIComponent(this.messageFormat)+"&";_52+=$("compose").toQueryString();new Ajax("ajax.php",{postBody:_52,onComplete:this.sendMessageCB.bind(this),onFailure:if_remoteRequestFailed}).request();this.draftClearTimeout();},sendMessageCB:function(_53){this.sending=false;Lichen.notbusy();var _54=if_checkRemoteResult(_53);if(!_54){return;}if(_54.draftMode){if($("comp_draftuid")){$("comp_draftuid").value=_54.draftUid;}var d=new Date();var hr=d.getHours();var min=d.getMinutes();if(min<10){min="0"+min;}if(hr==0){hr="12";}if(hr>12){hr=hr-12;min+=" PM";}else{min+=" AM";}Lichen.Flash.flashMessage(_("Draft saved at")+" "+hr+":"+min);}else{this.cleanupComposer();Lichen.action("list","MessageList","listUpdate");Lichen.Flash.flashMessage(_54.message);}},cleanupComposer:function(){this.draftClearTimeout();},draftSaveTimeout:function(){if(this.draftSaveTimer){clearTimeout(this.draftSaveTimer);}this.draftSaveTimer=setTimeout(this.draftSaveTimedout.bind(this),60*1000);},draftClearTimeout:function(){if(this.draftSaveTimer){clearTimeout(this.draftSaveTimer);this.draftSaveTimer=null;}},draftSaveTimedout:function(){this.sendMessage(true);},removeAttachment:function(_58){var _59=$A($("compose").getElementsByTagName("input"));var _5a=$A($("comp-attachlist").getElementsByTagName("li"));var _5b=false;_58=unescape(_58);for(var i=0;i<_59.length;i++){var _5d=_59[i];if(_5d.type=="hidden"&&_5d.value==_58){_5b=true;_5d.remove();}}for(var i=0;i<_5a.length;i++){var _5d=_5a[i];if(_5d.getText().contains(_58)){_5d.remove();}}if(_5b){new Ajax("ajax.php",{postBody:"request=removeAttachment&filename="+encodeURIComponent(_58),onComplete:this.attachmentDeleted.bind(this),onFailure:if_remoteRequestFailed}).request();}},attachmentDeleted:function(_5e){var _5f=if_checkRemoteResult(_5e);},asyncUploadFile:function(_60){var _61="asyncUpload"+Math.floor(Math.random()*99999);var _62=new Element("div");$(_62).setHTML("<iframe style='display: none;' src='about:blank' id='"+_61+"' name='"+_61+"' onload='Lichen.MessageCompose.asyncUploadCompleted(\""+_61+"\")'></iframe>");$("comp-wrapper").adopt(_62);$(_60).setProperty("target",_61);return true;},asyncUploadCompleted:function(_63){var _64=$(_63);if(_64==null){return;}if(_64.contentWindow!=null){_64=_64.contentWindow.document;}else{if(_64.contentDocument!=null){_64=_64.contentDocument;}else{_64=window.frames[_63].document;}}if(_64.location.href=="about:blank"){return;}_64.location.href="about:blank";var _65=if_checkRemoteResult(_64.body.innerHTML);if(!_65){return;}$(_63).getParent().remove();var _66=new Element("li");_66.setHTML(_65.filename+" ("+_65.type+", "+_65.size+" bytes)"+" (<a href=\"#\" onclick=\"Lichen.MessageCompose.removeAttachment('"+escape(_65.filename)+"');return false\">"+_("remove")+"</a>)");$("comp-attachlist").adopt(_66);var _67=new Element("input");_67.type="hidden";_67.name="comp_attach[]";_67.value=_65.filename;$("compose").adopt(_67);$("comp_attachfile").value="";}});function HTMLToText(_68,_69){var _6a=document.createElement("div");_6a.innerHTML=_68;var _6b=_htt_parseNode(_6a,_69);return _6b;}function _htt_parseNode(_6c,_6d,_6e){var i=0;var _70="";for(i=0;i<_6c.childNodes.length;i++){if(_6c.childNodes[i].tagName=="A"){_70+=_6c.childNodes[i].href;}else{if(_6c.childNodes[i].tagName=="HR"){_70+="-------------------------\n\n";}else{if(_6c.childNodes[i].childNodes.length>0){_70+=_htt_parseNode(_6c.childNodes[i]);}else{if(_6c.childNodes[i].nodeType==3){_70+=_6c.childNodes[i].nodeValue;}}}}}switch(_6c.tagName){case "H1":case "H2":case "H3":case "H4":case "H5":case "H6":_70=_70.toUpperCase();_70+="\n\n";break;case "P":case "DIV":_70+="\n\n";break;}return _70;}window.onload=if_init;var activeFadeEffect=false;var userSettings;var Lichen;function if_init(){Lichen.onLoadInit();}function _(str){return str;}var InterfaceController=new Class({initialize:function(){this.mode="list";this.Messages=new MessagesDatastore(true);this.OptionsEditor=new OptionsEditorClass("opts-wrapper");this.MailboxManager=new MailboxManagerClass(this.Messages);this.MessageDisplayer=new MessageDisplay(this.Messages,"msg-wrapper");this.Flash=new FlashArea("notification");this.MessageList=new MessageLister(this.Messages,"list-wrapper");this.MailboxList=new MailboxLister("mailboxes");this.MessageCompose=new MessageComposer("comp-wrapper");this.AddressBook=new AddressBookManager(this.Messages,"addr-wrapper");this.ActionCounter=1;this.historyTrail=new Array(Array("list","MessageList","listUpdate"));this.historyChecker=null;this.lastHash="";this.modeFeedback=null;this.busyCounter=0;this.busyDiv="loading-box";this.busyIFrame=new Element("iframe");this.busyIFrame.setStyle("display","none");this.loadInit=false;},onLoadInit:function(){this.checkCount();this.MessageList.listUpdate();if(window.khtml){var _72=(window.innerWidth-350)+"px";$("list-bar").style.width=_72;$("comp-bar").style.width=_72;$("opts-bar").style.width=_72;$("msg-bar").style.width=_72;}if(window.ie6){for(var i=0;i<document.images.length;i++){var img=document.images[i];var _75=img.src.toUpperCase();if(_75.substring(_75.length-3,_75.length)=="PNG"){var _76="<span style=\"width:22px;height:22px;cursor:hand;"+"display:inline-block;vertical-align:middle;"+"filter:progid:DXImageTransform.Microsoft.AlphaImageLoader"+"(src='"+img.src+"', sizingMethod='crop');\"></span>";img.outerHTML=_76;i=i-1;}}$("corner-bar").style.width=(document.body.clientWidth-128)+"px";}},checkCount:function(){this.Messages.fetchMailboxList();this.clearTimer();this.setTimer();},setTimer:function(){if(!this.refreshTimer&&userSettings["list_refreshtime"]!="disabled"){this.refreshTimer=setTimeout(this.checkCount.bind(this),userSettings["list_refreshtime"]*60*1000);}},clearTimer:function(){if(this.refreshTimer){clearTimeout(this.refreshTimer);this.refreshTimer=null;}},action:function(_77,_78,_79,_7a,_7b){if(_77&&this.mode=="compose"&&_77!=this.mode){this.MessageCompose.cleanupComposer();}if(_77&&_77!=this.mode&&this.modeFeedback==null){this.modeFeedback=new PaneTransition(this.getWrapperName(this.mode));this.busy();}else{if(_77&&_77!=this.mode&&this.modeFeedback!=null){this.modeFeedback.end();this.modeFeedback=null;this.clearScreen();this.enterMode(_77);this.notbusy();}}if(_77&&_77!="list"){this.clearTimer();}else{if(_77=="list"){this.setTimer();}}if(this[_78]&&this[_78][_79]){if(_7a){this[_78][_79].apply(this[_78],_7a);}else{this[_78][_79].apply(this[_78],[]);}}if(this[_78]&&this[_78]["getWindowTitle"]){document.title=this[_78].getWindowTitle();}return false;},clearScreen:function(){$("list-bar").setStyle("display","none");$("comp-bar").setStyle("display","none");$("msg-bar").setStyle("display","none");$("opts-bar").setStyle("display","none");$("list-wrapper").setStyle("display","none");$("msg-wrapper").setStyle("display","none");$("opts-wrapper").setStyle("display","none");$("comp-wrapper").setStyle("display","none");$("addr-wrapper").setStyle("display","none");$("list-wrapper").empty();$("msg-wrapper").empty();$("opts-wrapper").empty();$("comp-wrapper").empty();$("addr-wrapper").setStyle("display","none");},getWrapperName:function(_7c){var _7d="list-wrapper";switch(_7c){case "list":_7d="list-wrapper";break;case "compose":_7d="comp-wrapper";break;case "display":_7d="msg-wrapper";break;case "options":_7d="opts-wrapper";break;case "abook":_7d="addr-wrapper";break;}return _7d;},enterMode:function(_7e){if(_7e!=this.mode){this.mode=_7e;switch(_7e){case "list":$("list-bar").setStyle("display","block");$("list-wrapper").setStyle("display","block");break;case "compose":$("comp-bar").setStyle("display","block");$("comp-wrapper").setStyle("display","block");break;case "display":$("msg-bar").setStyle("display","block");$("msg-wrapper").setStyle("display","block");break;case "options":$("opts-bar").setStyle("display","block");$("opts-wrapper").setStyle("display","block");break;case "abook":$("addr-wrapper").setStyle("display","block");break;default:this.enterMode("list");break;}}},getMode:function(){return this.mode;},busy:function(){if(!this.loadInit){$(this.busyDiv).adopt(this.busyIFrame);this.loadInit=true;}this.busyCounter+=1;if(this.busyCounter>0){this.busyIFrame.src="wait.php";}},notbusy:function(){if(this.busyCounter>0){this.busyCounter-=1;}if(this.busyCounter<1){this.busyIFrame.src="about:blank";}}});var Lichen=new InterfaceController();var FlashArea=new Class({initialize:function(_7f){this.wrapper=_7f;this.messages=new Array();this.timeouts=new Array();this.onscreen=false;},flashMessage:function(_80,_81){if(_81){this.messages.push(_80+"<div class=\"detail\">"+_81+"</div>");}else{this.messages.push(_80);}this.renderFlash();if(!this.onscreen){$(this.wrapper).setStyle("display","block");this.onscreen=true;}this.timeouts.push(window.setTimeout(this.clearFlash.bind(this),7500));},renderFlash:function(){var _82=this.messages.join("<br />");$(this.wrapper).setHTML(_82);},clearFlash:function(){this.messages.shift();this.timeouts.shift();if(this.messages.length==0){$(this.wrapper).setStyle("display","none");this.onscreen=false;}else{this.renderFlash();}},hideFlash:function(){this.messages=new Array();for(var i=0;i<this.timeouts.length;i++){window.clearTimeout(this.timeouts[i]);}this.timeouts=new Array();this.renderFlash();this.onscreen=false;$(this.wrapper).setStyle("display","none");}});var PaneTransition=new Class({initialize:function(_84){this.fadeOut=new Fx.Style(_84,"opacity",{duration:1500});this.elementID=_84;this.fadeOut.start(0.9,0);},end:function(){this.fadeOut.stop();$(this.elementID).style.display="none";$(this.elementID).setStyle("opacity",1);}});function if_remoteRequestStart(){}function if_remoteRequestEnd(){}function if_checkRemoteResult(_85){var _86="";if($type(_85)!="string"){return _85;}_86=Json.evaluate(_85,true);if(!_86){alert(_("Unable to Json decode what the server sent back.\n The server sent us:")+" '"+_85+"'\n");if_remoteRequestEnd();return null;}if_remoteRequestEnd();if(_86.resultCode!="OK"){if(_86.resultCode=="AUTH"){if($("relogin_pass")==null){var _87=$("opts-wrapper");var _88="";_88+="<h3>"+_("You were logged out.")+"</h3>";_88+="<p>"+_("The server said:")+" "+_86.errorMessage+"</p>";_88+="<p>"+_("Enter your password to login again:")+"</p>";_88+="<input type=\"password\" name=\"relogin_pass\" id=\"relogin_pass\" />";_88+="<button onclick=\"if_relogin(); return false\">"+_("Login")+"</button>";_87.setHTML(_88);_87.setStyle("display","block");$("relogin_pass").focus();}}else{if(_86.imapNotices!=""){Lichen.Flash.flashMessage(_86.errorMessage,_("IMAP messages: ")+_86.imapNotices);}else{Lichen.Flash.flashMessage(_86.errorMessage,"");}return null;}}else{return _86;}}function if_remoteRequestFailed(_89){if_remoteRequestEnd();Lichen.Flash.flashMessage(_89);Lichen.Messages.getCallback(true);}function if_relogin(){var _8a=$("relogin_pass").value;new Ajax("index.php",{postBody:"action=relogin&user="+encodeURIComponent(serverUser)+"&pass="+encodeURIComponent(_8a),onComplete:if_reloginCB,onFailure:if_remoteRequestFailed}).request();}function if_reloginCB(_8b){var _8c=if_checkRemoteResult(_8b);if(!_8c){return;}if(_8c.error){Lichen.Flash.flashMessage(_8c.error);}else{$("opts-wrapper").setStyle("display","none");$("opts-wrapper").empty();}}function if_logoutSilent(){new Ajax("index.php",{postBody:"logout=0&silent=0",onComplete:if_logoutSilentCB,onFailure:if_remoteRequestFailed}).request();}function if_logoutSilentCB(_8d){var _8e=if_checkRemoteResult(_8d);if(!_8e){return;}Lichen.Flash.flashMessage(_("Silently logged out."));}function if_newWin(_8f){var nw=window.open(_8f);return !nw;}var MessagesDatastore=new Class({initialize:function(_91){this.online=_91;this.server=new IMAPServerConnector(this);this.cache=new HashCacheConnector(this,serverUser);this.callbacks=new Array();this.allMessagesMailbox=null;this.allMessagesSearch=null;},addCallback:function(_92){this.callbacks.push(_92);},getCallback:function(_93){var _94=this.callbacks.shift();if(_93){_94=null;}return _94;},fetchMessageList:function(_95,_96,_97,_98){var _99=this.cache.getMessageListValidity(_95,_96,_97,_98);var _9a=this.cache.getMessageList(_95,_96,_97,_98,_99);if(_9a){Lichen.action("list","MessageList","listUpdateCB",[_9a]);}if(this.online){this.server.messageList(_95,_96,_97,_98,_99);}if(!this.online&&!_9a){Lichen.Flash.flashMessage(_("Not online, and that data is not cached."));}},fetchMessageListCB:function(_9b,_9c,_9d,_9e,_9f,_a0,_a1){if(_9e==-1){return;}var _a2=this.cache.getMessageList(_9c,_9d,_9e,_9f,_a0);if(_a2==null){var _a2=this.cache.storeMessageList(_9c,_9d,_9e,_9f,_9b.data,_9b.validityKey);if(_a1!="true"&&Lichen.getMode()=="list"){Lichen.action("list","MessageList","listUpdateCB",[_a2]);}if(this.online&&_a1!="true"){if(_9e!=0&&!this.cache.haveCachedMessageList(_9c,_9d,_9e-1,_9f)){this.server.messageList(_9c,_9d,_9e-1,_9f,this.cache.getMessageListValidity(_9c,_9d,_9e-1,_9f),true);}if(_a2.numberpages>(_9e+1)&&!this.cache.haveCachedMessageList(_9c,_9d,_9e+1,_9f)){this.server.messageList(_9c,_9d,_9e+1,_9f,this.cache.getMessageListValidity(_9c,_9d,_9e+1,_9f),true);}}}},fetchAdjacentMessages:function(_a3,_a4,_a5,_a6,uid){var _a8=-1;var _a9=-1;var _aa=-1;var _ab=null;var _ac=null;var _ad=new Array();_ad.push(this.cache.getMessageList(_a3,_a4,_a5,_a6,this.cache.getMessageListValidity(_a3,_a4,_a5,_a6)));_ad.push(this.cache.getMessageList(_a3,_a4,_a5+1,_a6,this.cache.getMessageListValidity(_a3,_a4,_a5+1,_a6)));_ad.push(this.cache.getMessageList(_a3,_a4,_a5-1,_a6,this.cache.getMessageListValidity(_a3,_a4,_a5-1,_a6)));for(var j=0;j<_ad.length;j++){if(_ad[j]==null){continue;}for(var i=0;i<_ad[j].messages.length;i++){if(_ad[j].messages[i].uid==uid){_a8=i;_a9=_ad[j].thispage.toInt();_aa=j;break;}}if(_a8!=-1){break;}}if(_a9!=_a5){return this.fetchAdjacentMessages(_a3,_a4,_a9,_a6,uid);}if(_a8!=-1&&_a9!=-1){if(_a8>0){_ab=_ad[_aa].messages[_a8-1];}if(_a8==0){if(_ad[2]!=null){_ab=_ad[2].messages[_ad[2].messages.length-1];}}if(_a8<(_ad[_aa].messages.length-1)){_ac=_ad[_aa].messages[_a8+1];}if(_a8==(_ad[_aa].messages.length-1)){if(_ad[1]!=null){_ac=_ad[1].messages[0];}}}if(_a9!=-1&&_a9!=Lichen.MessageList.getPage()){Lichen.MessageList.setPage(_a9,true);if(this.online){if(_a9!=0){var _b0=this.cache.getMessageListValidity(_a3,_a4,_a9-1,_a6);if(!this.cache.getMessageList(_a3,_a4,_a9-1,_a6,_b0)){this.server.messageList(_a3,_a4,_a9-1,_a6,_b0,true);}}var _b0=this.cache.getMessageListValidity(_a3,_a4,_a9+1,_a6);if(!this.cache.getMessageList(_a3,_a4,_a9+1,_a6,_b0)){this.server.messageList(_a3,_a4,_a9+1,_a6,_b0,true);}}}var _b1={};_b1.previous=_ab;_b1.next=_ac;return _b1;},fetchMailboxList:function(_b2){var _b3=this.cache.getMailboxListValidity();var _b4=this.cache.getMailboxList(_b3);if(_b2){return _b4;}if(this.online){this.server.mailboxList(_b3);}else{if(_b4){Lichen.MailboxList.listUpdateCB(_b4);}else{Lichen.Flash.flashMessage(_("Unable to fetch mailbox list: not online and not cached."));}}},fetchMailboxListCB:function(_b5){var _b6=this.cache.storeMailboxList(_b5.data,_b5.validity);Lichen.MailboxList.listUpdateCB(_b6);},fetchMailboxStatus:function(_b7){var _b8=this.cache.getMailboxListValidity();var _b9=this.cache.getMailboxList(_b8);var _ba=null;if(_b9){for(var i=0;i<_b9.length;i++){if(_b9[i].fullboxname==_b7){_ba=_b9[i];}}}else{}return _ba;},fetchMessage:function(_bc,uid,_be){var _bf=this.cache.getMessage(_bc,uid,_be,true);if(_bf){Lichen.action("display","MessageDisplayer","showMessageCB",[_bf]);}else{if(this.online){this.server.messageBody(_bc,uid,_be);}else{Lichen.Flash.flashMessage(_("Unable to view message: in offline mode, and not cached."));}}},fetchMessageCB:function(_c0,_c1,uid){var _c3=this.cache.storeMessage(_c1,uid,_c0.data);Lichen.action("display","MessageDisplayer","showMessageCB",[_c0.data]);},fetchLargePart:function(_c4,uid,_c6,_c7){if(this.online){var _c8=this.server.fetchLargePart(_c4,uid,_c6);_c8="<pre>"+_c8+"</pre>";this.cache.storeLargePart(_c4,uid,_c7,_c8);return _c8;}else{return _("Not online - unable to fetch that part of the message.");}},nextOperationOnAllMessages:function(_c9,_ca){this.allMessagesMailbox=_c9;this.allMessagesSearch=_ca;if(this.online){this.server.nextOperationOnAllMessages(_c9,_ca);}else{}},clearOperationOnAllMessages:function(){if(this.online){this.server.clearOperationOnAllMessages();}this.allMessagesMailbox=null;this.allMessagesSearch=null;},moveMessage:function(_cb,_cc,uid,_ce){this.addCallback(_ce);this.server.moveMessage(_cb,_cc,uid);},moveMessageCB:function(_cf,_d0){this.genericServerCallback(_cf,_d0);},deleteMessage:function(_d1,uid,_d3){this.addCallback(_d3);this.server.deleteMessage(_d1,uid);},deleteMessageCB:function(_d4,_d5){this.genericServerCallback(_d4,_d5);},twiddleFlag:function(_d6,uid,_d8,_d9,_da){this.addCallback(_da);this.server.twiddleFlag(_d6,uid,_d8,_d9);},twiddleFlagCB:function(_db,_dc){if(!_dc){this.cache.updateFlagStatus(Lichen.MessageList.getMailbox(),Lichen.MessageList.getSearch(),Lichen.MessageList.getPage(),Lichen.MessageList.getSortStr(),_db.uid,_db.flag,_db.state);}this.genericServerCallback(_db,_dc);},addressBookList:function(_dd,_de,_df){this.addCallback(_df);this.server.addressBookList(_dd,_de);},addressBookListCB:function(_e0,_e1){if(!_e1){}this.genericServerCallback(_e0,_e1);},addressBookEdit:function(_e2,_e3,_e4,_e5,_e6){this.addCallback(_e6);this.server.addressBookEdit(_e2,_e3,_e4,_e5);},addressBookEditCB:function(_e7,_e8){this.genericServerCallback(_e7,_e8);},addressBookDelete:function(_e9,_ea){this.addCallback(_ea);this.server.addressBookDelete(_e9);},addressBookDeleteCB:function(_eb,_ec){this.genericServerCallback(_eb,_ec);},genericServerCallback:function(_ed,_ee){var _ef=this.getCallback(_ee);if(_ef){_ef(_ed);}}});var MailboxManagerClass=new Class({initialize:function(_f0){this.mailboxCache=null;this.dataStore=_f0;},renameInline:function(_f1,_f2){if($("mbm-namearea-"+_f1)){var _f3="<input id=\"mbm-rename-"+_f1+"\" type=\"text\" size=\"20\" value=\""+_f2+"\" />";_f3+="<button onclick=\"Lichen.MailboxManager.renameDone('"+_f1+"', '"+_f2+"');return false\">"+_("save")+"</button> <button onclick=\"Lichen.MailboxManager.renameCancel('"+_f1+"');return false\">"+_("cancel")+"</button> ";$("mbm-namearea-"+_f1).setHTML(_f3);var _f4=$("mbm-rename-"+_f1);if(_f4){_f4.focus();}}},renameDone:function(_f5,_f6){var _f7=$("mbm-rename-"+_f5);if(_f7){var _f8=_f7.value;if(_f8&&_f8!=""){if(_f8==_f6){this.serverActionCB({action:"rename",mailbox1:_f5,mailbox2:_f5});}else{_f8=_f5.substr(0,_f5.length-_f6.length)+_f8;new Ajax("ajax.php",{postBody:"request=mailboxAction&action=rename&mailbox1="+encodeURIComponent(_f5)+"&mailbox2="+encodeURIComponent(_f8),onComplete:this.serverActionCB.bind(this),onFailure:if_remoteRequestFailed}).request();}}}},renameCancel:function(_f9){var _fa=$("mbm-rename-"+_f9);if(_fa){this.serverActionCB({action:"rename",mailbox1:_f9,mailbox2:_f9});}},mailboxDelete:function(_fb,_fc){if(confirm(_("Are you sure you want to delete '")+_fc+_("'?\nAll messages in this mailbox will be deleted.\nThis cannot be undone."))){new Ajax("ajax.php",{postBody:"request=mailboxAction&action=delete&mailbox1="+encodeURIComponent(_fb),onComplete:this.serverActionCB.bind(this),onFailure:if_remoteRequestFailed}).request();}},newChild:function(_fd){var _fe=$("mbm-changearea-"+_fd);if(_fe){var _ff="<div id=\"mbm-newchild-wrapper-"+_fd+"\">";_ff+=_("New Subfolder:")+" <input id=\"mbm-newchild-"+_fd+"\" type=\"text\" size=\"20\" />";_ff+="<button onclick=\"Lichen.MailboxManager.newChildSubmit('"+_fd+"'); return false\">"+_("Add")+"</button>";_ff+="<button onclick=\"Lichen.MailboxManager.newChildCancel('"+_fd+"'); return false\">"+_("Cancel")+"</button>";_ff+="</div>";_fe.setHTML(_ff);var _100=$("mbm-newchild-"+_fd);if(_100){_100.focus();}}},newChildSubmit:function(_101){var _102=$("mbm-newchild-"+_101);if(_102&&_102.value!=""){new Ajax("ajax.php",{postBody:"request=mailboxAction&action=create&mailbox1="+encodeURIComponent(_101)+"&mailbox2="+encodeURIComponent(_102.value),onComplete:this.serverActionCB.bind(this),onFailure:if_remoteRequestFailed}).request();}},newChildCancel:function(_103){var _104=$("mbm-newchild-wrapper-"+_103);if(_104){_104.remove();}},changeParentInline:function(_105,_106){var _107=$("mbm-changearea-"+_105);if(_107){var _108="<div id=\"mbm-changeparent-wrapper-"+_105+"\">";_108+=_("Move to subfolder of: ");_108+="<select id=\"mbm-changeparent-"+_105+"\">";_108+="<option value=\"\">"+_("[Top Level]")+"</option>";for(var i=0;i<this.mailboxCache.length;i++){var _10a=this.mailboxCache[i];_108+="<option value=\""+_10a.fullboxname+"\"";if(_106==_10a.mailbox){_108+=" selected=\"selected\">";}else{_108+=">";}for(var j=0;j<_10a.folderdepth;j++){_108+="-";}_108+=_10a.mailbox+"</option>";}_108+="</select>";_108+="<button onclick=\"Lichen.MailboxManager.changeParentSubmit('"+_105+"', '"+_106+"'); return false\">"+_("Move")+"</button>";_108+="<button onclick=\"Lichen.MailboxManager.changeParentCancel('"+_105+"', '"+_106+"'); return false\">"+_("Cancel")+"</button>";_108+="</div>";_107.setHTML(_108);}},changeParentSubmit:function(_10c,_10d){var _10e=$("mbm-changeparent-"+_10c);if(_10e&&_10e.value!=_10d){new Ajax("ajax.php",{postBody:"request=mailboxAction&action=move&mailbox1="+encodeURIComponent(_10c)+"&mailbox2="+encodeURIComponent(_10e.value),onComplete:this.serverActionCB.bind(this),onFailure:if_remoteRequestFailed}).request();}},changeParentCancel:function(_10f,_110){var _111=$("mbm-changeparent-wrapper-"+_10f);if(_111){_111.remove();}},serverActionCB:function(_112){var _113=if_checkRemoteResult(_112);if(!_113){return;}Lichen.action("options","OptionsEditor","showEditor",["mailboxes"]);if(_113.mailboxes){this.mailboxCache=_113.mailboxes;}}});var MailboxLister=new Class({initialize:function(_114){this.wrapper=_114;this.mailboxCount=0;this.lastUIDconst=-1;this.mailboxCount=-1;this.msgCount=-1;this.openMailboxes=new Array();this.listCache=null;},isMailboxOpen:function(_115){for(var i=0;i<this.openMailboxes.length;i++){if(this.openMailboxes[i]==_115){return i;}}return -1;},listUpdate:function(){Lichen.Messages.fetchMailboxList();},listUpdateCB:function(_117){var _118=_117;this.listCache=_117;if(this.mailboxCount!=_118.length){this._render(_118);this.mailboxCount=_118.length;}var i=0;for(i=0;i<_118.length;i++){if(Lichen.MessageList.getMailbox()==_118[i].fullboxname){if(this.lastUIDconst!=-1&&this.lastUIDconst!=_118[i].uidConst){Lichen.action("list","MessageList","listUpdate");}else{if(this.msgCount!=-1&&this.msgCount!=_118[i].messages){Lichen.action("list","MessageList","listUpdate");}}this.lastUIDconst=_118[i].uidConst;this.msgCount=_118[i].messages;$("mb-"+Lichen.MessageList.getMailbox()).addClass("mb-active");}var _11a="";if(_118[i].unseen>0||userSettings.boxlist_showtotal){_11a="("+_118[i].unseen;if(userSettings.boxlist_showtotal){_11a+="/"+_118[i].messages;}_11a+=")";}if($("mb-unread-"+_118[i].fullboxname)){$("mb-unread-"+_118[i].fullboxname).setHTML(_11a);}else{this._render(_118);return;}}this.mailboxCount=_117.length;},_render:function(_11b){$(this.wrapper).empty();var _11c="<li id=\"mb-header\"><span class=\"s-head\">"+_("Mailboxes")+"</span> [<a href=\"#manage-mailboxes\" onclick=\"return Lichen.action('options','OptionsEditor','showEditor',['mailboxes'])\">"+_("edit")+"</a>]</li>";var _11d=new Array();for(var i=0;i<_11b.length;i++){if(_11d.length>0){var _11f=_11d[_11d.length-1];if(_11b[i].fullboxname.substr(0,_11f.length)==_11f){continue;}else{_11d.pop();}}_11c+="<li id=\"mb-"+_11b[i].fullboxname;if(Lichen.MessageList.getMailbox()==_11b[i].fullboxname){_11c+="\" class=\"mb-active";}_11c+="\">";if(_11b[i].haschildren){_11c+=" <a href=\"#\" style=\"float:right;\" onclick=\"return Lichen.MailboxList.viewToggle('"+_11b[i].fullboxname+"');\">";if(this.isMailboxOpen(_11b[i].fullboxname)!=-1){_11c+="<img width=\"8\" height=\"8\" src=\"themes/"+userSettings.theme+"/icons/folder_contract.png\" alt=\""+_("[contract]")+"\" />";}else{_11d.push(_11b[i].fullboxname+_11b[i].delimiter);_11c+="<img width=\"8\" height=\"8\" src=\"themes/"+userSettings.theme+"/icons/folder_expand.png\" alt=\""+_("[expand]")+"\" />";}_11c+="</a>";}if(_11b[i].selectable){_11c+="<a href=\"#\" onclick=\"return Lichen.action('list', 'MailboxList', 'selectMailbox', ['"+_11b[i].fullboxname+"'])\" class=\"mb-click\">";}else{_11c+="<div class=\"mb-noclick\">";}for(var j=0;j<_11b[i].folderdepth;j++){_11c+="&nbsp;&nbsp;";}_11c+="<span class=\"mailbox\">"+_11b[i].mailbox;_11c+=" <span id=\"mb-unread-"+_11b[i].fullboxname+"\">";if(_11b[i].unseen>0||userSettings.boxlist_showtotal){_11c+="("+_11b[i].unseen;if(userSettings.boxlist_showtotal){_11c+="/"+_11b[i].messages;}_11c+=")";}_11c+="</span>";_11c+="</span>";if(_11b[i].selectable){_11c+="</a>";}else{_11c+="</div>";}_11c+="</li>";}$(this.wrapper).setHTML(_11c);},selectMailbox:function(_121){this.lastUIDconst="";this.msgCount=0;var _122=$("mb-"+Lichen.MessageList.getMailbox());if(_122){_122.removeClass("mb-active");}Lichen.action("list","MessageList","setMailbox",[_121]);$("mb-"+Lichen.MessageList.getMailbox()).addClass("mb-active");return false;},viewToggle:function(_123){var _124=this.isMailboxOpen(_123);if(_124==-1){this.openMailboxes.push(_123);this._render(this.listCache);}else{this.openMailboxes.splice(_124,1);this._render(this.listCache);}return false;}});var MessageDisplay=new Class({initialize:function(_125,_126){this.dataStore=_125;this.wrapperdiv=_126;this.displayMode="";this.displayModeUID="";this.lastShownUID="";this.messageData=null;},getViewedUID:function(){return this.lastShownUID;},getWindowTitle:function(){if(this.messageData){return this.messageData.subject+_(" - Message Display");}else{return _("Message Display");}},showMessage:function(_127,uid,mode){this.displayMode=mode;this.displayModeUID=uid;var _12a=mode;if(mode=="monospace"){_12a="text";}this.dataStore.fetchMessage(_127,uid,_12a);return false;},showMessageCB:function(_12b,mode){if($("mr-"+_12b.uid)){$("mr-"+_12b.uid).removeClass("new");}if(!mode&&this.displayModeUID==_12b.uid){mode=this.displayMode;}$(this.wrapperdiv).empty();$(this.wrapperdiv).setHTML(this._render(_12b,mode));$(this.wrapperdiv).style.display="block";$("msg-bar").style.display="block";this.lastShownUID=_12b.uid;var _12d=$("btn-draft");if(Lichen.MessageList.getMailbox()==specialFolders.drafts){_12d.setStyle("display","inline");}else{_12d.setStyle("display","none");}},_render:function(_12e,_12f){var _130=this.dataStore.fetchAdjacentMessages(Lichen.MessageList.getMailbox(),Lichen.MessageList.getSearch(),Lichen.MessageList.getPage(),Lichen.MessageList.getSortStr(),_12e.uid);var _131="<div class=\"list-header-bar\"><img src=\"themes/"+userSettings.theme+"/top-corner.png\" alt=\"\" class=\"top-corner\" />";var _132="<div class=\"header-left\"><a class=\"list-return\" href=\"#inbox\" onclick=\"Lichen.action('list','MessageList','listUpdate');return false\">"+_("back to ")+Lichen.MessageList.getMailbox()+"</a></div>";_132+="<div class=\"header-right\">";if(_130.previous){_132+="<a href=\"#\" onclick=\"return Lichen.action('display','MessageDisplayer','showMessage',['"+_12e.mailbox+"','"+_130.previous.uid+"'])\">"+"&laquo; ";if(_130.previous.subject.length>24){_132+=_130.previous.subject.substr(0,24)+"...";}else{_132+=_130.previous.subject;}if(_130.next){_132+="</a> | ";}else{_132+="</a>";}}if(_130.next){_132+="<a href=\"#\" onclick=\"return Lichen.action('display','MessageDisplayer','showMessage',['"+_12e.mailbox+"','"+_130.next.uid+"'])\">";if(_130.next.subject.length>24){_132+=_130.next.subject.substr(0,24)+"...";}else{_132+=_130.next.subject;}_132+=" &raquo;"+"</a>";}_132+="</div>";_132+="<div class=\"header-left\">";_132+="<select onchange=\"Lichen.MessageDisplayer.moveMessage(this)\">";_132+="<option value=\"noop\" selected=\"selected\">"+_("move message to ...")+"</option>";if(!window.ie){mailboxes=this.dataStore.fetchMailboxList(true);}if(mailboxes){for(var i=0;i<mailboxes.length;i++){_132+="<option value=\"move-"+mailboxes[i].fullboxname+"\">";for(var j=0;j<mailboxes[i].folderdepth;j++){_132+="-";}_132+=mailboxes[i].mailbox;_132+="</option>";}}_132+="</select>";_132+=" &nbsp; <input type=\"button\" onclick=\"Lichen.MessageDisplayer.deleteMessage();return false\" value=\""+_("delete message")+"\" />";_132+="</div>";_132+="</div>";_131+=_132;_131+="<select id=\"msg-switch-view\" onchange=\"return Lichen.action('display','MessageDisplayer','switchView',[this.value])\">";_131+="<option value=\"noop\">"+_("switch view ...")+"</option>";if(_12e.texthtml.length>0||_12e.texthtmlpresent){_131+="<option value=\"html\">"+_("HTML part")+"</option>";}if(_12e.textplain.length>0||_12e.textplainpresent){_131+="<option value=\"text\">"+_("text part")+"</option>";_131+="<option value=\"text-mono\">"+_("monospace text")+"</option>";}_131+="<option value=\"source\">"+_("message source")+"</option>";_131+="</select>";_131+="<h1 class=\"msg-head-subject\">"+_12e.subject_html+"</h1>";_131+="<p class=\"msg-head-line2\" id=\"msg-details-short\">";_131+=_("to")+" <span class=\"msg-head-sender\">"+_12e.to_html+"</span><br />";_131+=_("from")+" <span class=\"msg-head-sender\">"+_12e.from_html+"</span> ";_131+="at <span class=\"msg-head-date\">"+_12e.localdate+"</span> ";_131+="</p>";if(_12e.htmlhasremoteimages){_131+="<div class=\"msg-notification\" id=\"msg-remoteimagesnotify\">";_131+=_("Remote images are not displayed.")+" [<a href=\"#\" onclick=\"return Lichen.MessageDisplayer.enableRemoteContent()\">"+_("show images")+"</a>]";_131+="</div>";}if(_12e.texthtml.length>0&&_12f!="text"&&_12f!="monospace"&&_12f!="source"){for(var i=0;i<_12e.texthtml.length;i++){_131+="<div class=\"html-message\">";_131+=_12e.texthtml[i];_131+="</div>";}}else{for(var i=0;i<_12e.textplain.length;i++){_131+="<div id=\"plainmsg-"+i+"\" class=\"plain-message";if(_12f=="monospace"){_131+=" plain-message-monospace";}_131+="\">";if(_12e.textplain[i].substr(0,14)=="LICHENTOOLARGE"){var _135=_12e.textplain[i].substr(15).split(")")[0];_131+="<a href=\"#\" onclick=\"Lichen.MessageDisplayer.getLargePart('"+_12e.uid+"', '"+_12e.mailbox+"','"+_135+"',"+i+");return false\">"+("This message part was too large to return directly. Click here to load it.")+"</a>";}else{_131+=_12e.textplain[i];}_131+="</div>";}}if(_12e.attachments.length>0&&_12f!="source"){_131+="<ul class=\"attachments\">";for(var i=0;i<_12e.attachments.length;i++){var _136=_12e.attachments[i];if(_136.filename==""){continue;}_131+="<li>";var _137="message.php?mailbox="+encodeURIComponent(_12e.mailbox)+"&uid="+encodeURIComponent(_12e.uid)+"&filename="+encodeURIComponent(_136.filename);_131+="<a href=\""+_137+"\" onclick=\"return if_newWin('"+_137+"')\">";_131+=_136.filename+"</a>";_131+=" <span class=\"msg-attach-meta\">type "+_136.type+", size ~"+_136.size+" bytes</span>";if(_136.type.substr(0,5)=="image"){_131+="<br />";_131+="<img src=\""+_137+"\" alt=\""+_137+"\" />";}}_131+="</ul>";}_131+="<div class=\"footer-bar\"><img src=\"themes/"+userSettings.theme+"/bottom-corner.png\" alt=\"\" class=\"bottom-corner\" />"+_132+"</div>";this.messageData=_12e;return _131;},switchView:function(_138){switch(_138){case "html":this.showMessage(Lichen.MessageList.getMailbox(),this.lastShownUID,"html");break;case "text":this.showMessage(Lichen.MessageList.getMailbox(),this.lastShownUID,"text");break;case "text-mono":this.showMessage(Lichen.MessageList.getMailbox(),this.lastShownUID,"monospace");break;case "source":if_newWin("message.php?source&mailbox="+encodeURIComponent(Lichen.MessageList.getMailbox())+"&uid="+encodeURIComponent(this.lastShownUID));break;}return false;},alwaysEnableRemoteContent:function(){this.enableRemoteContent();},showFullDetails:function(){$("msg-details-short").setStyle("display","none");$("msg-details-long").setStyle("display","block");},enableRemoteContent:function(){if(this.messageData.htmlhasremoteimages){for(var i=0;i<this.messageData.remotecontent.length;i++){var _13a=this.messageData.remotecontent[i];var _13b=$(_13a.id);if(_13b){if(_13a.attr=="style"){for(var j=0;j<_13a.url.length;j++){_13b.setStyle(_13a.url[j][0],_13a.url[j][1]);}}else{_13b[_13a.attr]=_13a.url;}}}}$("msg-remoteimagesnotify").setStyle("display","none");return false;},getLargePart:function(uid,_13e,part,_140){$("plainmsg-"+_140).setHTML(_("Please wait... this might take a while..."));var _141=Lichen.Messages.fetchLargePart(_13e,uid,part,_140);$("plainmsg-"+_140).setHTML(_141);},moveMessage:function(_142){var _143=_142.value.substr(5);Lichen.Messages.moveMessage(Lichen.MessageList.getMailbox(),_143,this.displayModeUID,this.movedMessageCB.bind(this));},deleteMessage:function(){Lichen.Messages.deleteMessage(Lichen.MessageList.getMailbox(),this.displayModeUID,this.movedMessageCB.bind(this));},movedMessageCB:function(_144){Lichen.Flash.flashMessage(_144.message);var _145=this.dataStore.fetchAdjacentMessages(Lichen.MessageList.getMailbox(),Lichen.MessageList.getSearch(),Lichen.MessageList.getPage(),Lichen.MessageList.getSortStr(),this.displayModeUID);if(_145.next){this.showMessage(Lichen.MessageList.getMailbox(),_145.next.uid);}else{Lichen.action("list","MessageList","listUpdate");}}});var MessageLister=new Class({initialize:function(_146,_147){this.parseSort(userSettings.list_sortmode);this.mailbox=specialFolders.inbox;this.page=0;this.search="";this.wrapper=_147;this.dataStore=_146;this.numberPages=1;this.messagesOnThisPage=0;this.messagesInMailbox=0;this.unreadMessages=0;this.allSelectedStatus=0;},getWindowTitle:function(){var _148=this.mailbox+" (";_148+=this.unreadMessages+_(" unread, ");_148+=this.messagesInMailbox+_(" total");_148+=")";return _148;},setSort:function(_149,_14a){$("list-sort-"+this.sort).getParent().getElementsByTagName("img")[0].remove();if(_149==this.sort){this.sortAsc=!this.sortAsc;}else{this.sort=_149;this.sortAsc=true;}userSettings.list_sortmode=this.getSortStr();if(!_14a){this.listUpdate();}},getSortStr:function(){return this.sort+(this.sortAsc?"":"_r");},getSort:function(){return this.sort;},getSortAsc:function(){return this.sortAsc;},parseSort:function(_14b){if(_14b){if(_14b.substr(_14b.length-2,2)=="_r"){this.sort=_14b.substr(0,_14b.length-2);this.sortAsc=false;}else{this.sort=_14b;this.sortAsc=true;}}else{this.sort="date";this.sortAsc=false;}},setSearch:function(_14c,_14d){if(this.search!=_14c){this.search=_14c;this.page=0;this.allSelectedStatus=0;if(!_14d){this.listUpdate();}}if(_14c==""){if($("qsearch")){$("qsearch").value="";}}return false;},getSearch:function(){return this.search;},setMailbox:function(_14e,_14f){if(this.mailbox!=_14e){this.mailbox=_14e;this.page=0;this.search="";this.allSelectedStatus=0;}if(!_14f){this.listUpdate();}return false;},getMailbox:function(){return this.mailbox;},setPage:function(_150,_151){if(this.page!=_150){if(_150>=0&&_150<=(this.numberPages-1)){if(this.allSelectedStatus!=2){this.allSelectedStatus=0;}this.page=_150;if(!_151){this.listUpdate();}}}return false;},nextPage:function(){return this.setPage(this.page+1);},previousPage:function(){return this.setPage(this.page-1);},firstPage:function(){return this.setPage(0);},lastPage:function(){return this.setPage(this.numberPages);},listUpdate:function(){Lichen.busy();this.dataStore.fetchMessageList(this.mailbox,this.search,this.page,this.getSortStr());},getPage:function(){return this.page;},listUpdateCB:function(_152){Lichen.notbusy();if(_152.mailbox!=this.mailbox||_152.search!=this.search||_152.sort!=this.getSortStr()||_152.thispage!=this.page){return;}if(_152.thispage>=_152.numberpages||_152.thispage==-1){this.setPage(_152.numberpages-1);return;}this.numberPages=_152.numberpages;if(_152.unreadmessages!=null){this.unreadMessages=_152.unreadmessages;}this._render(_152.messages,_152);this.dataStore.fetchMailboxList();},_render:function(_153,_154){var _155=this.getSelectedMessages();$(this.wrapper).empty();var _156="";_156+=this._createPageBar(_154,true);if(this.search!=""){_156+="<div class=\"list-notification\"><strong>"+_("Found ")+_154.numbermessages+_(" results for")+" &#8220;"+this.search+"&#8221;</strong> "+"[<a href=\"#clearsearch\" onclick=\"return Lichen.action('list','MessageList','setSearch',[''])\">"+_("clear search")+"</a>]</div>";this.messagesInMailbox=_154.numbermessages;}else{this.messagesInMailbox=_154.mailboxmessages;}this.messagesOnThisPage=_153.length;var _157=this.allSelectedDisplay(true);_156+="<div class=\"list-notification\" id=\"select-all-notification\" ";if(_157==""){_156+="style=\"display: none\">";}else{_156+=">"+_157;}_156+="</div>";_156+="<table id=\"list-data-tbl\" class=\"messagelist\">";var _158=window.getWidth()-515;if(userSettings.list_showsize){_158=window.getWidth()-590;}_156+="<colgroup><col class=\"mcol-checkbox\" /><col class=\"mcol-flag\" /><col class=\"mcol-sender\" /><col class=\"mcol-subject\" style=\"width:"+_158+"px\" />";if(userSettings.list_showsize){_156+="<col class=\"mcol-size\" />";}_156+="<col class=\"mcol-date\" /></colgroup>";_156+="<thead><tr class=\"list-sortrow\">";_156+="<th><input type=\"checkbox\" id=\"list-check-main\" value=\"0\" onclick=\"Lichen.MessageList.selectMessages(0)\" /></th><th></th>";_156+="<th class=\"list-sortlabel\"><a href=\"#sort-from\" id=\"list-sort-from\" onclick=\"Lichen.MessageList.setSort('from');return false\">"+_("sender")+"</a></th>";_156+="<th class=\"list-sortlabel\"><a href=\"#sort-subject\" id=\"list-sort-subject\" onclick=\"Lichen.MessageList.setSort('subject');return false\">"+_("subject")+"</a></th>";if(userSettings.list_showsize){_156+="<th class=\"list-sortlabel\"><a href=\"#sort-size\" id=\"list-sort-size\" onclick=\"Lichen.MessageList.setSort('size');return false\">"+_("size")+"</a></th>";}_156+="<th class=\"list-sortlabel\"><a href=\"#sort-date\" id=\"list-sort-date\" onclick=\"Lichen.MessageList.setSort('date');return false\">"+_("date")+"</a></th>";_156+="</tr></thead><tbody>";if(_153.length==0){_156+="<tr><td colspan=\"5\" class=\"list-nothing\">"+_("No messages in this mailbox.")+"</td></tr>";}for(var i=0;i<_153.length;i++){var _15a=_153[i];var uid=_15a.uid;var _15c="<tr id=\"mr-"+_15a.uid+"\" class=\"";if(i%2==1){_15c+="odd";}else{_15c+="even";}if(_15a.readStatus=="U"){_15c+=" new";}if(this.allSelectedStatus==2){_15c+=" active";}_15c+="\">";_15c+="<td><input type=\"checkbox\" class=\"msg-select\" name=\"s-"+_15a.uid+"\" id=\"s-"+_15a.uid+"\" value=\""+_15a.uid+"\" onclick=\"Lichen.MessageList.messageCheckboxClicked(this);\" /></td>";var _15d=_15a.flagged?"/icons/flag.png":"/icons/flag_off.png";_15c+="<td><img src=\"themes/"+userSettings.theme+_15d+"\" id=\"f-"+_15a.uid+"\" alt=\"\" onclick=\"Lichen.MessageList.twiddleFlag('"+_15a.uid+"', 'flagged', 'toggle')\" title=\"Flag this message\" class=\"list-flag\" /></td>";_15c+="<td class=\"sender\" onclick=\"Lichen.action('display','MessageDisplayer','showMessage',['"+this.mailbox+"','"+_15a.uid+"'])\"";if(_15a.fromName==""){if(_15a.fromAddr.length>22){_15c+=" title=\""+_15a.fromAddr+"\"";}_15c+="><div class=\"sender\">"+_15a.fromAddr;}else{_15c+=" title=\""+_15a.fromAddr+"\"><div class=\"sender\">"+_15a.fromName;}_15c+="</div></td>";_15c+="<td class=\"subject\" onclick=\"Lichen.action('display','MessageDisplayer','showMessage',['"+this.mailbox+"','"+_15a.uid+"'])\"><div class=\"subject\">"+_15a.subject;if(userSettings.list_showpreviews){_15c+="<span class=\"messagePreview\">"+_15a.preview+"</span>";}_15c+="</div></td>";if(userSettings.list_showsize){_15c+="<td class=\"size\"><div class=\"size\">"+_15a.size+"</div></td>";}_15c+="<td class=\"date\"><div class=\"date\">"+_15a.dateString+"</div></td>";_15c+="</tr>";_156+=_15c;}_156+="</tbody></table>";_156+=this._createPageBar(_154,false);$(this.wrapper).setHTML(_156);var _15e=null;if(!this.sortAsc){_15e=new Element("img",{"class":"list-sort-marker","src":"themes/"+userSettings.theme+"/icons/sort_decrease.png"});}else{_15e=new Element("img",{"class":"list-sort-marker","src":"themes/"+userSettings.theme+"/icons/sort_incr.png"});}$("list-sort-"+this.sort).getParent().adopt(_15e);if(this.allSelectedStatus==2){this.selectMessages(7);}else{for(var i=0;i<_155.length;i++){var _15f=$("s-"+_155[i]);if(_15f){_15f.checked=true;}}}},_createPageBar:function(_160,_161){var _162="";if(_161){_162+="<div class=\"list-header-bar\"><img src=\"themes/"+userSettings.theme+"/top-corner.png\" alt=\"\" class=\"top-corner\" />";}else{_162+="<div class=\"list-footer-bar\"><img src=\"themes/"+userSettings.theme+"/bottom-corner.png\" alt=\"\" class=\"bottom-corner\" />";}var _163=_160.thispage+1;var _164=_160.numberpages;var _165=_163*_160.pagesize;if(_165>_160.numbermessages){_165=_160.numbermessages;}_162+="<div class=\"header-left\">";_162+="<select onchange=\"Lichen.MessageList.withSelected(this)\">";_162+="<option value=\"noop\" selected=\"selected\">"+_("move selected to ...")+"</option>";if(!window.ie){mailboxes=this.dataStore.fetchMailboxList(true);}if(mailboxes){for(var i=0;i<mailboxes.length;i++){_162+="<option value=\"move-"+mailboxes[i].fullboxname+"\">";for(var j=0;j<mailboxes[i].folderdepth;j++){_162+="-";}_162+=mailboxes[i].mailbox;_162+="</option>";}}_162+="</select>";_162+=" &nbsp; <input type=\"button\" onclick=\"Lichen.MessageList.deleteMessages();return false\" value=\""+_("delete")+"\" />";_162+=" &nbsp; <input type=\"button\" onclick=\"Lichen.MessageList.withSelected(null, 'flag');return false\" value=\""+_("flag")+"\" />";_162+=" &nbsp; <input type=\"button\" onclick=\"Lichen.MessageList.withSelected(null, 'markseen');return false\" value=\""+_("mark read")+"\" /><br />";if(!_161){_162+="select: <a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(1);return false\">"+_("all")+"</a> | ";_162+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(2);return false\">"+_("none")+"</a> | ";_162+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(3);return false\">"+_("read")+"</a> | ";_162+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(4);return false\">"+_("unread")+"</a> | ";_162+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(5);return false\">"+_("flagged")+"</a> | ";_162+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(6);return false\">"+_("unflagged")+"</a> | ";_162+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(0);return false\">"+_("invert")+"</a>";}_162+="</div><div class=\"header-right\">";if(_160.numberpages>1){var _168=_("previous");var _169=_("next");if(this.sort=="date"){if(this.sortAsc){_168=_("earlier");_169=_("later");}else{_168=_("later");_169=_("earlier");}}if(_163>1){_162+="<a href=\"#\" onclick=\"Lichen.MessageList.previousPage(); return false\">"+_168+"</a> | ";}_162+="<select onchange=\"Lichen.MessageList.setPage(this.value);\">";var _16a=_160.pagesize;var _16b=_160.numbermessages;var _16c=0;for(var i=1;i<=_160.numbermessages;i+=_16a){_162+="<option value=\""+_16c+"\"";if(_163==(_16c+1)){_162+=" selected=\"selected\"";}_162+=">"+i+" to ";if((_16c+1)*_16a>_16b){_162+=_16b;}else{_162+=(_16c+1)*_16a;}_162+="</option>";_16c++;}_162+="</select>";_162+=" of "+_160.numbermessages;if(_164-_163>0){_162+=" | <a href=\"#\" onclick=\"Lichen.MessageList.nextPage(); return false\">"+_169+"</a>";}}else{if(_160.numbermessages>0&&!_161){_162+=_("showing 1 to ")+_160.numbermessages+_(" of ")+_160.numbermessages;}}_162+="</div></div>";return _162;},getSelectedMessages:function(){var _16d=new Array();var _16e=$A($(this.wrapper).getElementsByTagName("input"));for(var i=0;i<_16e.length;i++){if(_16e[i].type!="checkbox"){continue;}if(_16e[i].checked){_16d.push(_16e[i].value);}}return _16d;},messageCheckboxClicked:function(_170){this.allSelectedStatus=0;this.allSelectedDisplay();this.setRowActive(_170);return false;},setRowActive:function(_171){var _172=$("mr-"+_171.value);if(_171.checked){_172.addClass("active");}else{_172.removeClass("active");}},allSelectedDisplay:function(_173){var _174="";if(this.allSelectedStatus==0){if(!_173){$("select-all-notification").setStyle("display","none");}}else{if(this.allSelectedStatus==1){_174+=_("Only the ")+"<b>"+this.messagesOnThisPage+"</b>"+_(" messages on this page have been selected. ");_174+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(7);\">";if(this.getSearch()==""){_174+=_("Select all messages in this mailbox");}else{_174+=_("Select all messages from this search");}_174+="</a>.";}else{_174+=_("All ")+"<b>"+this.messagesInMailbox+"</b>"+_(" messages ");if(this.getSearch()==""){_174+=_("in this mailbox have been selected. ");}else{_174+=_("from this search have been selected. ");}_174+="<a href=\"#\" onclick=\"Lichen.MessageList.selectMessages(1);\">";_174+=_("Select only the messages on this page");_174+="</a>.";}if(!_173){$("select-all-notification").setHTML(_174);$("select-all-notification").setStyle("display","block");}}return _174;},allSelectedServerNotify:function(_175){if(this.allSelectedStatus==2){Lichen.Messages.nextOperationOnAllMessages(this.getMailbox(),this.getSearch());}else{Lichen.Messages.clearOperationOnAllMessages();}if(_175){this.allSelectedStatus=0;Lichen.Messages.clearOperationOnAllMessages();}},selectMessages:function(mode){var _177=$A($("list-data-tbl").getElementsByTagName("input"));this.allSelectedStatus=0;if(mode==1){this.allSelectedStatus=1;}else{if(mode==7){this.allSelectedStatus=2;}}for(var i=1;i<_177.length;i++){var _179=_177[i].value;switch(mode){case 1:case 7:_177[i].checked=true;break;case 2:_177[i].checked=false;break;case 3:_177[i].checked=!$("mr-"+_179).hasClass("new");break;case 4:_177[i].checked=$("mr-"+_179).hasClass("new");break;case 5:_177[i].checked=!($("f-"+_179).src.substring($("f-"+_179).src.length-12)=="flag_off.png");break;case 6:_177[i].checked=($("f-"+_179).src.substring($("f-"+_179).src.length-12)=="flag_off.png");break;default:_177[i].checked=!_177[i].checked;break;}this.setRowActive(_177[i]);}this.allSelectedDisplay();},withSelected:function(_17a,_17b){var _17c=this.getSelectedMessages();var _17d="noop";if(!_17a&&_17b){_17d=_17b;}else{_17d=_17a.value;}var _17e="";if(_17d.substr(0,5)=="move-"){_17e=_17d.substr(5);_17d="move";}this.allSelectedServerNotify();switch(_17d){case "noop":break;case "markseen":this.twiddleFlag(_17c.join(","),"seen","true");break;case "markunseen":this.twiddleFlag(_17c.join(","),"seen","false");break;case "flag":this.twiddleFlag(_17c.join(","),"flagged","true");break;case "unflag":this.twiddleFlag(_17c.join(","),"flagged","false");break;case "move":this.moveMessages(_17e);break;}if(_17a){_17a.selectedIndex=0;}},twiddleFlag:function(uid,flag,_181){Lichen.Messages.twiddleFlag(this.getMailbox(),uid,flag,_181,this.twiddleFlagCB.bind(this));},twiddleFlagCB:function(_182){var _183=_182.uid.split(",");if(_182.flag=="seen"){for(var i=0;i<_183.length;i++){var _185=$("mr-"+_183[i]);if(_185){if(!_182.state){_185.addClass("new");}else{_185.removeClass("new");}}}}if(_182.flag=="flagged"){for(var i=0;i<_183.length;i++){var _186=$("f-"+_183[i]);if(_186){if(_182.state){_186.src="themes/"+userSettings.theme+"/icons/flag.png";}else{_186.src="themes/"+userSettings.theme+"/icons/flag_off.png";}}}}if(_183.length>1){Lichen.Flash.flashMessage(_("Updated ")+_183.length+_(" messages."));}},moveMessages:function(_187){var _188=this.getSelectedMessages();var _189=_188.length;_188=_188.join(",");this.allSelectedServerNotify();Lichen.Messages.moveMessage(this.getMailbox(),_187,_188,this.moveMessagesCB.bind(this));this.allSelectedServerNotify(true);},deleteMessages:function(){var _18a=this.getSelectedMessages();var _18b=_18a.length;_18a=_18a.join(",");this.allSelectedServerNotify();Lichen.Messages.deleteMessage(this.getMailbox(),_18a,this.moveMessagesCB.bind(this));this.allSelectedServerNotify(true);},moveMessagesCB:function(_18c){Lichen.Flash.flashMessage(_18c.message);this.listUpdate();},threadTest:function(){new Ajax("ajax.php",{postBody:"request=getThreadedList&mailbox="+encodeURIComponent(this.getMailbox()),onComplete:this.threadTestCB.bind(this),onFailure:if_remoteRequestFailed}).request();},threadTestCB:function(_18d){var _18e=if_checkRemoteResult(_18d);if(!_18e){return;}$(this.wrapper).setHTML(_18e.htmlFragment);}});var IMAPServerConnector=new Class({initialize:function(_18f){this.dataStore=_18f;this.allMessagesMailbox=null;this.allMessagesSearch=null;},nextOperationOnAllMessages:function(_190,_191){this.allMessagesMailbox=_190;this.allMessagesSearch=_191;},clearOperationOnAllMessages:function(){this.allMessagesMailbox=null;this.allMessagesSearch=null;},getOperationOnAllMessages:function(){if(this.allMessagesMailbox!=null&&this.allMessagesSearch!=null){return "&allmailbox="+encodeURIComponent(this.allMessagesMailbox)+"&allsearch="+encodeURIComponent(this.allMessagesSearch);}else{return "";}},messageList:function(_192,_193,page,sort,_196,_197){if(_197==null){_197=false;}new Ajax("ajax.php",{postBody:"request=mailboxContentsList&mailbox="+encodeURIComponent(_192)+"&page="+page+"&search="+encodeURIComponent(_193)+"&sort="+encodeURIComponent(sort)+"&validity="+encodeURIComponent(_196)+"&cacheonly="+encodeURIComponent(_197),onComplete:this.messageListCB.bind(this),onFailure:if_remoteRequestFailed}).request();},messageListCB:function(_198){var _199=if_checkRemoteResult(_198);if(!_199){return null;}this.dataStore.fetchMessageListCB(_199,_199.data.mailbox,_199.data.search,_199.data.thispage,_199.data.sort,_199.validity,_199.cacheonly);},mailboxList:function(_19a){new Ajax("ajax.php",{postBody:"request=getMailboxList&validity="+encodeURIComponent(_19a),onComplete:this.mailboxListCB.bind(this),onFailure:if_remoteRequestFailed}).request();},mailboxListCB:function(_19b){var _19c=if_checkRemoteResult(_19b);if(!_19c){return null;}this.dataStore.fetchMailboxListCB(_19c);},messageBody:function(_19d,uid,mode){new Ajax("ajax.php",{postBody:"request=getMessage&mailbox="+encodeURIComponent(_19d)+"&msg="+encodeURIComponent(uid)+"&mode="+encodeURIComponent(mode),onComplete:this.messageBodyCB.bind(this),onFailure:if_remoteRequestFailed}).request();},messageBodyCB:function(_1a0){var _1a1=if_checkRemoteResult(_1a0);if(!_1a1){return null;}this.dataStore.fetchMessageCB(_1a1,_1a1.data.mailbox,_1a1.data.uid);},fetchLargePart:function(_1a2,uid,part){var _1a5=new XHR({method:"get",async:false});var url="message.php?mailbox="+encodeURIComponent(_1a2)+"&uid="+encodeURIComponent(uid)+"&filename=part:"+encodeURIComponent(part);_1a5.send(url,null);return _1a5.response.text;},moveMessage:function(_1a7,_1a8,uid,_1aa){new Ajax("ajax.php",{postBody:"request=moveMessage&mailbox="+encodeURIComponent(_1a7)+"&destbox="+encodeURIComponent(_1a8)+"&uid="+encodeURIComponent(uid)+this.getOperationOnAllMessages(),onComplete:this.moveMessageCB.bind(this),onFailure:if_remoteRequestFailed}).request();},moveMessageCB:function(_1ab){var _1ac=if_checkRemoteResult(_1ab);if(_1ac){this.dataStore.moveMessageCB(_1ac,false);}else{this.dataStore.moveMessageCB(_1ac,true);}},deleteMessage:function(_1ad,uid){new Ajax("ajax.php",{postBody:"request=deleteMessage&mailbox="+encodeURIComponent(_1ad)+"&uid="+encodeURIComponent(uid)+this.getOperationOnAllMessages(),onComplete:this.deleteMessageCB.bind(this),onFailure:if_remoteRequestFailed}).request();},deleteMessageCB:function(_1af){var _1b0=if_checkRemoteResult(_1af);if(_1b0){this.dataStore.deleteMessageCB(_1b0,false);}else{this.dataStore.deleteMessageCB(_1b0,true);}},twiddleFlag:function(_1b1,uid,flag,_1b4){var _1b5="request=setFlag";_1b5+="&flag="+encodeURIComponent(flag);_1b5+="&mailbox="+encodeURIComponent(_1b1);_1b5+="&uid="+encodeURIComponent(uid);_1b5+=this.getOperationOnAllMessages();if(_1b4){_1b5+="&state="+_1b4;}new Ajax("ajax.php",{postBody:_1b5,onComplete:this.twiddleFlagCB.bind(this),onFailure:if_remoteRequestFailed}).request();},twiddleFlagCB:function(_1b6){var _1b7=if_checkRemoteResult(_1b6);if(_1b7){this.dataStore.twiddleFlagCB(_1b7,false);}else{this.dataStore.twiddleFlagCB(_1b7,true);}},addressBookList:function(_1b8,_1b9){var _1ba="request=addressBookList";if(_1b8){_1ba+="&searchin="+encodeURIComponent(_1b8);}if(_1b9){_1ba+="&searchterm="+encodeURIComponent(_1b9);}new Ajax("ajax.php",{postBody:_1ba,onComplete:this.addressBookListCB.bind(this),onFailure:if_remoteRequestFailed}).request();},addressBookListCB:function(_1bb){var _1bc=if_checkRemoteResult(_1bb);if(_1bc){this.dataStore.addressBookListCB(_1bc,false);}else{this.dataStore.addressBookListCB(_1bc,true);}},addressBookEdit:function(_1bd,name,_1bf,_1c0){var _1c1="request=addressBookEdit";_1c1+="&original="+encodeURIComponent(_1bd);_1c1+="&name="+encodeURIComponent(name);_1c1+="&email="+encodeURIComponent(_1bf);_1c1+="&notes="+encodeURIComponent(_1c0);new Ajax("ajax.php",{postBody:_1c1,onComplete:this.addressBookEditCB.bind(this),onFailure:if_remoteRequestFailed}).request();},addressBookEditCB:function(_1c2){var _1c3=if_checkRemoteResult(_1c2);if(_1c3){this.dataStore.addressBookEditCB(_1c3,false);}else{this.dataStore.addressBookEditCB(_1c3,true);}},addressBookDelete:function(_1c4){var _1c5="request=addressBookDelete";_1c5+="&email="+encodeURIComponent(_1c4);new Ajax("ajax.php",{postBody:_1c5,onComplete:this.addressBookDeleteCB.bind(this),onFailure:if_remoteRequestFailed}).request();},addressBookDeleteCB:function(_1c6){var _1c7=if_checkRemoteResult(_1c6);if(_1c7){this.dataStore.addressBookDeleteCB(_1c7,false);}else{this.dataStore.addressBookDeleteCB(_1c7,true);}}});var OptionsEditorClass=new Class({initialize:function(_1c8){this.wrapper=_1c8;this.identityCache=null;},getWindowTitle:function(){return _("Lichen - Settings");},showEditor:function(_1c9){if_remoteRequestStart();Lichen.busy();new Ajax("ajax.php",{postBody:"request=settingsPanel&tab="+encodeURIComponent(_1c9),onComplete:this.showEditorCBStub.bind(this),onFailure:if_remoteRequestFailed}).request();},showEditorCBStub:function(_1ca){Lichen.action("options","OptionsEditor","showEditorCB",[_1ca]);Lichen.notbusy();},showEditorCB:function(_1cb){var _1cc=if_checkRemoteResult(_1cb);if(!_1cc){return;}$(this.wrapper).setHTML(_1cc.htmlFragment);if(_1cc.mailboxes){Lichen.MailboxManager.mailboxCache=_1cc.mailboxes;}if(_1cc.identities){this.identityCache=_1cc.identities;}},closePanel:function(){Lichen.MailboxList.listUpdate();Lichen.action("list","MessageList","listUpdate");},generateQueryString:function(_1cd){var _1ce=$A($(_1cd).getElementsByTagName("input"));_1ce.extend($A($(_1cd).getElementsByTagName("select")));var _1cf=new Array();for(var i=0;i<_1ce.length;i++){var _1d1="";switch(_1ce[i].type){case "checkbox":if(_1ce[i].checked){_1d1="true";}else{_1d1="false";}break;default:_1d1=_1ce[i].value;break;}_1cf.push(_1ce[i].id+"="+encodeURIComponent(_1d1));}return _1cf.join("&");},saveOptions:function(){if_remoteRequestStart();Lichen.busy();new Ajax("ajax.php",{postBody:"request=settingsPanelSave&"+this.generateQueryString("opts-settings"),onComplete:this.saveOptionsCB.bind(this),onFailure:if_remoteRequestFailed}).request();},saveOptionsCB:function(_1d2){Lichen.notbusy();var _1d3=if_checkRemoteResult(_1d2);if(!_1d3){return;}if(_1d3.errors&&_1d3.errors.length>0){alert(_("There were some errors saving your settings.\nAny valid settings were saved.\n\n")+_1d3.errors.join("\n"));}else{this.closePanel();}opts_getCB(_1d3);},identity_findInCache:function(_1d4){for(var i=0;i<this.identityCache.length;i++){if(_1d4==this.identityCache[i].address){return this.identityCache[i];}}return null;},identity_add:function(){$("opts-identity-name").value="";$("opts-identity-address").value="";$("opts-identity-sig").value="";if(!$("opts-identity-new")){var _1d6=new Element("option",{"id":"opts-identity-new"});_1d6.appendText("new identity");$("opts-identity-list").adopt(_1d6);$("opts-identity-list").value="new identity";}$("opts-identity-save").onclick=Lichen.OptionsEditor.identity_add_done.bind(this);return false;},identity_add_done:function(){var _1d7=$("opts-identity-name").value;var _1d8=$("opts-identity-address").value;var _1d9=$("opts-identity-sig").value;if(_1d7==""||_1d8==""){Lichen.Flash.flashMessage(_("Can't add an identity with a blank name or blank e-mail."));return false;}new Ajax("ajax.php",{postBody:"request=identityEditor&action=add&idname="+encodeURIComponent(_1d7)+"&idemail="+encodeURIComponent(_1d8)+"&idsig="+encodeURIComponent(_1d9),onComplete:this.identity_actionCB.bind(this),onFailure:if_remoteRequestFailed}).request();return false;},identity_edit:function(){if($("opts-identity-new")){$("opts-identity-new").remove();}var _1da=$("opts-identity-list");if(_1da.value==""){return false;}var _1db=this.identity_findInCache(_1da.value);$("opts-identity-name").value=_1db.name;$("opts-identity-address").value=_1db.address;$("opts-identity-sig").value=_1db.signature;$("opts-identity-save").onclick=function(){return Lichen.OptionsEditor.identity_edit_done(_1db.address);};return false;},identity_edit_done:function(_1dc){var _1dd=$("opts-identity-name").value;var _1de=$("opts-identity-address").value;var _1df=$("opts-identity-sig").value;if(_1dd==""||_1de==""){Lichen.Flash.flashMessage(_("Can't edit an identity to have a blank name or blank e-mail."));return false;}new Ajax("ajax.php",{postBody:"request=identityEditor&action=edit&idname="+encodeURIComponent(_1dd)+"&idemail="+encodeURIComponent(_1de)+"&oldid="+encodeURIComponent(_1dc)+"&idsig="+encodeURIComponent(_1df),onComplete:this.identity_actionCB.bind(this),onFailure:if_remoteRequestFailed}).request();return false;},identity_setdefault:function(){var _1e0=$("opts-identity-list");if(_1e0.value==""){return false;}new Ajax("ajax.php",{postBody:"request=identityEditor&action=setdefault&oldid="+encodeURIComponent(_1e0.value),onComplete:this.identity_actionCB.bind(this),onFailure:if_remoteRequestFailed}).request();return false;},identity_remove:function(){var _1e1=$("opts-identity-list");if(_1e1.value==""){return false;}new Ajax("ajax.php",{postBody:"request=identityEditor&action=delete&oldid="+encodeURIComponent(_1e1.value),onComplete:this.identity_actionCB.bind(this),onFailure:if_remoteRequestFailed}).request();return false;},identity_actionCB:function(_1e2){var _1e3=if_checkRemoteResult(_1e2);if(!_1e3){return;}Lichen.action("options","OptionsEditor","showEditor",["identities"]);}});function opts_get(){new Ajax("ajax.php",{postBody:"request=getUserSettings",onComplete:opts_getCB,onFailure:if_remoteRequestFailed}).request();}function opts_getCB(_1e4){var _1e5=if_checkRemoteResult(_1e4);if(!_1e5){return;}userSettings=_1e5.settings;}